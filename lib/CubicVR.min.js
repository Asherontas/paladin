(function(P,sa,p,va,h){function ab(a){this.worker=new Worker(Aa+"CubicVR.js");this.message=a.message;this.error=a.error;this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message&&b.message(a.data)};this.worker.onerror=function(a){b.error?b.error(a):la("Error: "+a.message+": "+a.lineno)};this.fn=function(a,d){b.worker.postMessage({message:"function",data:a,options:d})};this.start=function(a){b.worker.postMessage({message:"start",data:b.type,options:a})};this.init=function(a){b.send({message:"init",
data:a})};this.stop=function(){b.worker.postMessage({message:"stop",data:null})};this.send=function(a){b.worker.postMessage({message:"data",data:a})}}function vb(){this.onmessage=function(a){a.test?setTimeout(function(){postMessage(a.test)},1E3):setTimeout(function(){throw Error(a);},1E3)}}function wb(){this.onmessage=function(){}}function Q(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function bb(){w.GLCore.mainloop!==
null&&(P.requestAnimationFrame&&P.requestAnimationFrame(bb),w.GLCore.mainloop.interval())}function Ba(a,b){if(P.requestAnimationFrame===h)P.requestAnimationFrame=P.webkitRequestAnimationFrame||P.mozRequestAnimationFrame||P.oRequestAnimationFrame||P.msRequestAnimationFrame||null;if(w.GLCore.mainloop!==null)!P.requestAnimationFrame&&w.GLCore.mainloop&&clearInterval(w.GLCore.mainloop.interval),w.GLCore.mainloop=null;if(a===null)w.GLCore.mainloop=null;else{var c=new Q;c.start();this.timer=c;this.func=
a;this.doclear=b!==h?b:!0;w.GLCore.mainloop=this;if(l.resizeList.length&&!w.GLCore.resize_active)P.addEventListener("resize",function(){w.GLCore.onResize()},!1),w.GLCore.resize_active=!0;var d=function(){return function(){var b=w.GLCore.gl;c.update();w.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(c,w.GLCore.gl)}}();P.requestAnimationFrame?(d(),this.interval=d,P.requestAnimationFrame(bb)):this.interval=setInterval(d,20)}}function ia(a,b,c){this.canvas=a;this.camera=b;this.mpos=
[0,0];this.mdown=!1;var d=this;this.mEvents={};this.keyState=[];this.onMouseDown=function(){return function(a){d.mdown=!0;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseDown&&d.mEvents.mouseDown(d,d.mpos,d.keyState)}}();this.onMouseUp=function(){return function(a){d.mdown=!1;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseUp&&d.mEvents.mouseUp(d,d.mpos,d.keyState)}}();this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-
a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-d.mpos[0];b[1]=a[1]-d.mpos[1];d.mpos=a;d.mEvents.mouseMove&&d.mEvents.mouseMove(d,d.mpos,b,d.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;d.mEvents.mouseWheel&&d.mEvents.mouseWheel(d,d.mpos,a,d.keyState)}}();this.onKeyDown=function(){return function(){}}();this.onKeyUp=function(){return function(){}}();this.eventDefaults={mouseMove:function(a,b,c){a.mdown&&a.orbitView(c)},mouseWheel:function(a,
b,c){a.zoomView(c)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null};c!==!1&&this.setEvents(c===h?this.eventDefaults:c);this.bind()}function R(a){return this.clearStack(a)}function na(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}function Ca(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=
[0,0,0];this.segment=this.material=0}function L(a){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=a?a:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1}function $(a){a!==h?(this.rotation=a.rotation===h?[0,0,0]:a.rotation,this.scale=a.scale===h?[1,1,1]:a.scale,this.center=a.center===h?[0,0,0]:a.center,this.projection_mode=
a.projectionMode===h?g.uv.projection.PLANAR:a.projectionMode,this.projection_axis=a.projectionAxis===h?g.uv.axis.X:a.projectionAxis,this.wrap_w_count=a.wrapW===h?1:a.wrapW,this.wrap_h_count=a.wrapH===h?1:a.wrapH):(this.rotation=[0,0,0],this.scale=[1,1,1],this.center=[0,0,0],this.projection_mode=g.uv.projection.PLANAR,this.projection_axis=g.uv.axis.X,this.wrap_h_count=this.wrap_w_count=1)}function Da(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=
b[2]}function Ea(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])}function G(a,b){if(a===h)a=g.light.type.POINT;if(b===h)b=g.light.method.DYNAMIC;typeof a=="object"?(this.light_type=a.type!==h?a.type:g.light.type.POINT,this.diffuse=a.diffuse!==h?a.diffuse:[1,1,1],this.specular=a.specular!==h?a.specular:[1,1,1],this.intensity=a.intensity!==h?a.intensity:1,this.position=
a.position!==h?a.position:[0,0,0],this.direction=a.direction!==h?a.direction:[0,0,0],this.distance=a.distance!==h?a.distance:this.light_type===g.light.type.AREA?30:10,this.cutoff=a.cutoff!==h?a.cutoff:60,this.map_res=a.map_res!==h?a.map_res:this.light_type===g.light.type.AREA?2048:512,this.map_res=a.mapRes!==h?a.mapRes:this.map_res,this.method=a.method!==h?a.method:b,this.areaCam=a.areaCam!==h?a.areaCam:null,this.areaCeiling=a.areaCeiling!==h?a.areaCeiling:40,this.areaFloor=a.areaFloor!==h?a.areaFloor:
-40,this.areaAxis=a.areaAxis!==h?a.areaAxis:[1,1,0]):(this.light_type=a,this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===g.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===g.light.type.AREA?2048:512,this.method=b,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0]);this.trans=new R;this.lposition=[0,0,0];this.tMatrix=this.trans.getResult();this.dirty=!0;this.octree_leaves=
[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];Da(this.aabb,this.position);this.adjust_octree=V.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===g.light.type.SPOT_SHADOW||this.light_type===g.light.type.AREA)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0]}function E(a,b){var c,d;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=
[];a.indexOf("\n")!==-1?c=Na(l.gl,a,"x-shader/x-vertex"):(c=cb(l.gl,a),c===null&&(d=z.getURL(a),c=Na(l.gl,d,"x-shader/x-vertex")));b.indexOf("\n")!==-1?d=Na(l.gl,b,"x-shader/x-fragment"):(d=cb(l.gl,b),d===null&&(d=z.getURL(b),d=Na(l.gl,d,"x-shader/x-fragment")));this.shader=l.gl.createProgram();l.gl.attachShader(this.shader,c);l.gl.attachShader(this.shader,d);l.gl.linkProgram(this.shader);if(!l.gl.getProgramParameter(this.shader,l.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+a+
"), frag("+b+")");}function Fa(a){var b=w.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=sa.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var c=this.canvasSource,d=c.width,c=c.height,e=!0;if(d===1||c===1)e=!1;else{if(d!==1)for(;d%
2===0;)d/=2;if(c!==1)for(;c%2===0;)c/=2;d>1&&(e=!1);c>1&&(e=!1)}this.updateFunction=a.update;this.texture=new w.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;e?(this.setFilter(g.texture.filter.LINEAR_MIP),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)):(this.setFilter(g.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function db(a,b,c){var d=w.GLCore.gl;this.texture=new w.Texture;this.canvas=sa.createElement("CANVAS");this.canvas.width=b;this.canvas.height=c;this.pjs=new Processing(this.canvas,w.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;b=this.canvas.height;c=!0;if(a===1||b===1)c=!1;else{if(a!==1)for(;a%2===0;)a/=2;if(b!==1)for(;b%2===0;)b/=2;a>1&&(c=
!1);b>1&&(c=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;c?this.setFilter(g.texture.filter.LINEAR_MIP):(this.setFilter(g.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function La(a,b,c,d){if(a.compiled!==null){var e=0,f=w.GLCore.gl,m=d===h?0:d.length,r,i=0,g,q=null,o=!1;f.depthFunc(f.LEQUAL);
c===h&&(c=oa);for(var H=0,n=a.compiled.elements_ref.length;H<n;H++){var q=a.materials[H],x=0,i=!1;q.opacity!==1?(f.enable(f.BLEND),f.depthMask(0),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA)):(f.depthMask(1),f.disable(f.BLEND),f.blendFunc(f.ONE,f.ONE));for(var t=0,l=a.compiled.elements_ref[H].length;t<l;t++){g=a.compiled.elements_ref[H][t][0];var i=!1,y=a.compiled.elements_ref[H][t][1];x+=y;if(!a.segment_state[g])if(x>y){e+=y*2;x-=y;if(m){for(var y=0,s=!1,y=0;y<m;){nLights=m-y;nLights>Ga&&(nLights=
Ga);y>0&&!s&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),s=!0);r=d[y];for(var v=r.light_type,i=0;i<nLights;i++)if(d[i+y].light_type!=v){nLights=i;break}q.use(r.light_type,nLights);r=q.shader[r.light_type][nLights];f.uniformMatrix4fv(r.uMVMatrix,!1,b.mvMatrix);f.uniformMatrix4fv(r.uPMatrix,!1,b.pMatrix);f.uniformMatrix4fv(r.uOMatrix,!1,c);f.uniformMatrix3fv(r.uNMatrix,!1,b.nMatrix);o||(q.bindObject(a,r),o=!0);for(i=0;i<nLights;i++)d[i+y].setupShader(r,i);f.drawElements(f.TRIANGLES,
x,f.UNSIGNED_SHORT,e);y+=nLights}s&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else q.use(0,0),f.uniformMatrix4fv(q.shader[0][0].uMVMatrix,!1,b.mvMatrix),f.uniformMatrix4fv(q.shader[0][0].uPMatrix,!1,b.pMatrix),f.uniformMatrix4fv(q.shader[0][0].uOMatrix,!1,c),f.uniformMatrix3fv(q.shader[0][0].uNMatrix,!1,b.nMatrix),o||(q.bindObject(a,q.shader[0][0]),o=!0),f.drawElements(f.TRIANGLES,x,f.UNSIGNED_SHORT,e);e+=x*2;x=0;i=!0}else e+=x*2,x=0}if(!i&&a.segment_state[g]){if(m){s=!1;for(y=0;y<m;){nLights=m-
y;nLights>Ga&&(nLights=Ga);y>0&&!s&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),s=!0);r=d[y];v=r.light_type;for(i=0;i<nLights;i++)if(d[i+y].light_type!=v){nLights=i;break}q.use(r.light_type,nLights);r=q.shader[r.light_type][nLights];f.uniformMatrix4fv(r.uMVMatrix,!1,b.mvMatrix);f.uniformMatrix4fv(r.uPMatrix,!1,b.pMatrix);f.uniformMatrix4fv(r.uOMatrix,!1,c);f.uniformMatrix3fv(r.uNMatrix,!1,b.nMatrix);o||(q.bindObject(a,r),o=!0);for(i=0;i<nLights;i++)d[i+y].setupShader(r,i);f.drawElements(f.TRIANGLES,
x,f.UNSIGNED_SHORT,e);y+=nLights}s&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else q.use(0,0),f.uniformMatrix4fv(q.shader[0][0].uMVMatrix,!1,b.mvMatrix),f.uniformMatrix4fv(q.shader[0][0].uPMatrix,!1,b.pMatrix),f.uniformMatrix4fv(q.shader[0][0].uOMatrix,!1,c),f.uniformMatrix3fv(q.shader[0][0].uNMatrix,!1,b.nMatrix),o||(q.bindObject(a,q.shader[0][0]),o=!0),f.drawElements(f.TRIANGLES,x,f.UNSIGNED_SHORT,e);e+=x*2}}q&&r&&q.clearObject(a,r);f.depthMask(1);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)}}function eb(a,
b,c,d,e,f){var m=[],r,i=[0,1,0],g=[1,0,0],q=[0,0,0],o=a.points.length,H,n,x;for(H=r=0;H<pa;H+=pa/c){if(r===c)break;g=[p.cos(H),0,p.sin(H)];n=0;for(x=b.length;n<x;n++)q=s.add(s.multiply(g,b[n][0]),s.multiply(i,b[n][1])),m[r]===h&&(m[r]=[]),m[r].push(q);r++}x=null;e!==h&&(x=e.getResult!==h?e.getResult():e);for(n=0;n<c;n++){e=0;for(r=b.length;e<r;e++)x?a.addPoint(A.vec3_multiply(m[n][e],x)):a.addPoint(m[n][e])}a.setFaceMaterial(d);for(e=0;e<c;e++){n=0;for(x=b.length-1;n<x;n++)m=n+b.length*e,r=n+b.length*
((e+1)%c),s.equal(a.points[o+m],a.points[o+r])?a.addFace([o+m+1,o+r+1,o+r]):s.equal(a.points[o+m+1],a.points[o+r+1])?a.addFace([o+m,o+m+1,o+r]):a.addFace([o+m,o+m+1,o+r+1,o+r])}f!==h&&(b=null,f.apply!==h?b=f:f&&(b=new $(f)),b!==null&&(a.calcNormals(),b.apply(a,d)))}function fb(a,b,c,d,e){b*=0.5;var f=a.points.length;a.setFaceMaterial(c);d!==h?(d=d.getResult!==h?d.getResult():d,a.addPoint([A.vec3_multiply([b,-b,0],d),A.vec3_multiply([b,b,0],d),A.vec3_multiply([-b,b,0],d),A.vec3_multiply([-b,-b,0],
d)])):a.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);a.addFace([[f+0,f+1,f+2,f+3],[f+3,f+2,f+1,f+0]]);e!==h&&(d=null,e.apply!==h?d=e:e&&(d=new $(e)),d!==null&&(a.calcNormals(),d.apply(a,c)))}function Va(a,b,c,d,e){b/=2;var f=a.points.length;a.setFaceMaterial(c);d!==h?(d=d.getResult!==h?d.getResult():d,a.addPoint([A.vec3_multiply([b,-b,b],d),A.vec3_multiply([b,b,b],d),A.vec3_multiply([-b,b,b],d),A.vec3_multiply([-b,-b,b],d),A.vec3_multiply([b,-b,-b],d),A.vec3_multiply([b,b,-b],d),A.vec3_multiply([-b,
b,-b],d),A.vec3_multiply([-b,-b,-b],d)])):a.addPoint([[b,-b,b],[b,b,b],[-b,b,b],[-b,-b,b],[b,-b,-b],[b,b,-b],[-b,b,-b],[-b,-b,-b]]);a.addFace([[f+0,f+1,f+2,f+3],[f+7,f+6,f+5,f+4],[f+4,f+5,f+1,f+0],[f+5,f+6,f+2,f+1],[f+6,f+7,f+3,f+2],[f+7,f+4,f+0,f+3]]);e!==h&&(d=null,e.apply!==h?d=e:e&&(d=new $(e)),d!==null&&(a.calcNormals(),d.apply(a,c)))}function gb(a,b,c,d,e,f,m,r){var i=[];c-=b;b+=c/2;for(var g=pa/e,h=0,o=0;o<=e;o++)i.push([b+p.cos(h)*c,p.sin(h)*c,0]),h+=g;w.genLatheObject(a,i,d,f,m,r)}function hb(a,
b,c,d,e,f,m){w.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],d,e,f,m)}function ib(a,b,c,d,e,f,m){w.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],d,e,f,m)}function jb(a,b,c,d,e,f,m){for(var r=[],d=parseInt(d/=2),c=parseInt(c),i=J/d,g=-N,h=0;h<=d;h++)r.push([p.cos(g)*b,p.sin(g)*b,0]),g+=i;w.genLatheObject(a,r,c,e,f,m)}function wa(a,b,c,d){this.doTransform=function(){};this.tMatrix=oa;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=a;this.divisions_w=b;this.divisions_h=
c;this.matRef=d;this.children=null;this.obj=new L;this.divisions_w>this.divisions_h?(this.size_w=a,this.size_h=a/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?a/this.divisions_h*this.divisions_w:a,this.size_h=a);for(b=-(this.size_h/2);b<this.size_h/2;b+=this.size_h/this.divisions_h)for(a=-(this.size_w/2);a<this.size_w/2;a+=this.size_w/this.divisions_w)this.obj.addPoint([a+this.size_w/this.divisions_w/2,0,b+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);
for(b=0;b<this.divisions_h-1;b++)for(a=0;a<this.divisions_w-1;a++)this.obj.addFace([a+(b+1)*this.divisions_w,a+1+b*this.divisions_w,a+b*this.divisions_w]),this.obj.addFace([a+(b+1)*this.divisions_w,a+1+(b+1)*this.divisions_w,a+1+b*this.divisions_w])}function V(a,b){var c=null;a!==h&&a!==null&&(c=a.compile?null:a);c?(this.morphWeight=c.morphWeight||0,this.morphSource=c.morphSource||-1,this.morphTarget=c.morphTarget||-1,this.position=c.position===h?[0,0,0]:c.position,this.rotation=c.rotation===h?[0,
0,0]:c.rotation,this.scale=c.scale===h?[1,1,1]:c.scale,this.shadowCast=c.shadowCast===h?!0:c.shadowCast,this.motion=c.motion===h?null:c.motion,this.obj=c.mesh===h?a!==h&&c.faces!==h?a:null:c.mesh,this.name=c.name===h?b!==h?b:null:c.name):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=a,this.name=b,this.shadowCast=!0);this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.trans=new R;
this.tMatrix=this.trans.getResult();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];Da(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[]}function xb(){this.time=this.value=0;this.shape=g.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function ja(a){this.nKeys=0;this.lastKey=this.firstKey=
this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:g.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:g.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=g.envelope.behavior.CONSTANT}function aa(a,b){this.env_init=a;this.key_init=b;this.controllers=[];this.yzflip=!1}function Oa(){this.d=this.c=this.b=this.a=0}function Wa(a,b){this.position=a;if(this.position===h)this.position=[0,0,0];this.radius=b}function I(a,b,c,d,e){this._children=[];this._dirty=
!1;this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._children[7]=null;this._child_index=e===h?-1:e;this._size=a===h?0:a;this._max_depth=b===h?0:b;this._root=c===h?null:c;this._position=d===h?[0,0,0]:d;this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=new Wa(this._position,p.sqrt(3*(this._size/2*this._size/2)));this._bbox=[[0,0,0],[0,0,0]];Da(this._bbox,this._position);
a=this._size/2;Ea(this._bbox,[this._position[0]+a,this._position[1]+a,this._position[2]+a]);Ea(this._bbox,[this._position[0]-a,this._position[1]-a,this._position[2]-a]);this._debug_visible=!1}function kb(){this.position=[0,0,0];this.visible=!1;this._object=null}function lb(){this.octree=null;this.nodes=[];this.camera=null}function Ha(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=new Oa}function S(a,b,c,d,e){this.frustum=new Ha;typeof a=="object"?(this.position=
a.position?a.position:[0,0,0],this.rotation=a.rotation?a.rotation:[0,0,0],this.target=a.target?a.target:[0,0,0],this.fov=a.fov?a.fov:60,this.nearclip=a.nearclip?a.nearclip:0.1,this.farclip=a.farclip?a.farclip:400,this.targeted=a.targeted?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix?a.calcNormalMatrix:!0,b=a.height?a.height:h,a=a.width?a.width:h):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=c!==h?c:60,this.nearclip=d!==h?d:0.1,this.farclip=e!==h?e:400,this.calc_nmatrix=
this.targeted=!0);this.motion=this.targetSceneObject=null;this.transform=new R;this.manual=!1;this.setDimensions(a!==h?a:512,b!==h?b:512);this.mvMatrix=oa;this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1}}function Pa(a){this.position=a!==h?a:[0,0,0]}function Ia(a,b,c){this.camPath=new aa;this.targetPath=new aa;this.start_position=a!==h?a:[8,8,8];this.target=b!==h?b:[0,0,0];this.bounds=c!==h?c:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=
[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}function T(a,b,c,d,e,f){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.octree=f;this.skybox=null;this.camera=new S(a,b,c,d,e);this._workers=null;this.stats=[];this.collect_stats=!1}function mb(a,
b){return a.light_type-b.light_type}function W(a,b,c){this.createBuffer(a,b,c)}function ta(a,b){this.bloom=!0;this.renderBuffer=new W(a,b,!0);this.blurBuffer=new W(a,b,!1);this.bloomBuffer=new W(parseInt(a/6,10),parseInt(b/6,10),!1);this.copyShader=new E("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}\n","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void)\n{\ngl_FragColor = texture2D(srcTex, vTex);\n}\n");
this.copyShader.use();this.copyShader.addUVArray("aTex");this.copyShader.addVertexArray("aVertex");this.copyShader.addInt("srcTex",0);this.fsQuad=this.makeFSQuad(a,b);this.bloomShader=new E("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}\n","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 texel_ofs;\nvarying vec2 vTex;\nvec3 rangeValHDR(vec3 src)\n{\nreturn (src.r>0.90||src.g>0.90||src.b>0.90)?(src):vec3(0.0,0.0,0.0);\n}\nvec4 hdrSample(float rad)\n{\nvec3 accum;\nfloat radb = rad*0.707106781;\naccum =  rangeValHDR(texture2D(srcTex, vec2(vTex.s+texel_ofs.x*rad,  vTex.t)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s,          vTex.t+texel_ofs.y*rad)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s-texel_ofs.x*rad,  vTex.t)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s,          vTex.t-texel_ofs.y*rad)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s+texel_ofs.x*radb, vTex.t+texel_ofs.y*radb)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s-texel_ofs.x*radb, vTex.t-texel_ofs.y*radb)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s+texel_ofs.x*radb, vTex.t-texel_ofs.y*radb)).rgb);\naccum += rangeValHDR(texture2D(srcTex, vec2(vTex.s-texel_ofs.x*radb, vTex.t+texel_ofs.y*radb)).rgb);\naccum /= 8.0;\nreturn vec4(accum,1.0);\n}\nvoid main(void)\n{\nvec4 color;\ncolor = hdrSample(2.0);\ncolor += hdrSample(8.0);\ncolor += hdrSample(12.0);\ngl_FragColor = color/2.0;\n}\n");
this.bloomShader.use();this.bloomShader.addUVArray("aTex");this.bloomShader.addVertexArray("aVertex");this.bloomShader.addInt("srcTex",0);this.bloomShader.addVector("texel_ofs");this.bloomShader.setVector("texel_ofs",[1/this.renderBuffer.sizeParam(a),1/this.renderBuffer.sizeParam(b),0]);this.fsQuadBloom=this.makeFSQuad(this.bloomBuffer.width,this.bloomBuffer.height);this.blurShader=new E("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}\n",
"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{\ngl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}\n");this.blurShader.use();this.blurShader.addUVArray("aTex");this.blurShader.addVertexArray("aVertex");this.blurShader.addInt("srcTex",0);this.blurShader.addFloat("opacity");this.blurOpacity=0.1;var c=l.gl;this.blurBuffer.use();c.clear(c.COLOR_BUFFER_BIT);this.end()}function Xa(a){if(a.shader_vertex===
h)return null;if(a.shader_fragment===h)return null;this.outputMode=a.outputMode===h?g.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===h?null:a.onresize;this.onupdate=a.onupdate===h?null:a.onupdate;this.init=a.init===h?null:a.init;this.enabled=a.enabled===h?!0:a.enabled;this.outputDivisor=a.outputDivisor===h?1:a.outputDivisor;this.shader=new E(a.shader_vertex,a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",
0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function ba(a,b,c){var d=l.gl;this.width=a;this.height=b;this.accum=c===h?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new W(a,b,!0);this.bufferA=new W(a,b,!1);this.bufferB=new W(a,b,!1);this.bufferC=new W(a,b,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new W(a,b,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),
this.blur_shader=new Xa({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();
d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.bufferB.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new Xa({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,b)}function nb(a,b,c){var d=l.gl;this.width=b;this.height=c;this.srcTex=a;this.outTex=new W(b,c);var a=b,e=c;if(!(a===1||e===1)){if(a!==1)for(;a%2===0;)a/=2;if(e!==1)for(;e%2===0;)e/=2}a=[1/b,1/c,0];this.outputBuffer=new W(b,c,!1);this.fsQuad=ba.prototype.makeFSQuad(b,c);shaderNMap=new E("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(d.TEXTURE0);this.setFilter(g.texture.filter.LINEAR);
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)}function da(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}function yb(a){var b={},c=[],d,e=a,f,m,r,i=/^\s+|\s+$/g;a.jsonParent=b;for(c.push(a);c.length;){var e=c.pop(),g=null;f=e.jsonParent;a=0;for(d=e.childNodes.length;a<d;a++)m=e.childNodes[a],r=m.tagName,r!==h&&(g=g||{},g[r]=g[r]||0,g[r]++);if(e.attributes&&e.attributes.length){a=
0;for(d=e.attributes.length;a<d;a++)m=e.attributes[a],f["@"+m.name]=m.value}a=0;for(d=e.childNodes.length;a<d;a++)if(m=e.childNodes[a],r=m.tagName,m.nodeType===1)g[r]>1?(f[r]=f[r]||[],f[r].push({}),m.jsonParent=f[r][f[r].length-1]):(f[r]=f[r]||{},m.jsonParent=f[r]),c.push(m);else if(m.nodeType===3&&m.nodeValue.replace(i,"")!=="")f.$=f.$||"",f.$+=m.nodeValue}return b}function zb(a,b){new L;new T;var c=z.getXML(a),d,e,f,m,r,i,u,q,o,H,n,x,t,l,y=yb(c),c=null;if(!y.COLLADA)throw Error(a+" does not appear to be a valid COLLADA file.");
y=y.COLLADA;c={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(y.asset){var s=y.asset.up_axis.$;if(s==="X_UP")c.up_axis=0;else if(s==="Y_UP")c.up_axis=1;else if(s==="Z_UP")c.up_axis=2}s=c.up_axis;if(y.library_images){if(y.library_images.image&&!y.library_images.image.length)y.library_images.image=[y.library_images.image];if(y.library_images.image.length){e=y.library_images.image;n=0;for(var v=e.length;n<v;n++){var p=e[n],B=p["@id"];d=p["@name"];
p=p.init_from;if(p.$)p=p.$,b!==h&&p.lastIndexOf("/")!==-1&&(p=p.substr(p.lastIndexOf("/")+1)),b!==h&&p.lastIndexOf("\\")!==-1&&(p=p.substr(p.lastIndexOf("\\")+1)),c.images[B]={source:p,id:B,name:d}}}}var F,w;if(y.library_effects){var D=y.library_effects.effect;D&&!D.length&&(D=[D]);p=0;for(F=D.length;p<F;p++){n=D[p];B=n["@id"];r={};r.id=B;r.surfaces=[];r.samplers=[];(v=n.profile_COMMON.newparam)&&!v.length&&(v=[v]);if(v){e=0;for(f=v.length;e<f;e++){var C=v[e];d=C["@sid"];if(C.surface){if(r.surfaces[d]=
{},C=C.surface.init_from.$,typeof c.images[C]==="object")r.surfaces[d].source=b+"/"+c.images[C].source}else if(C.sampler2D){r.samplers[d]={};r.samplers[d].source=C.sampler2D.source.$;if(C.sampler2D.minfilter)r.samplers[d].minfilter=C.sampler2D.minfilter.$;if(C.sampler2D.magfilter)r.samplers[d].magfiter=C.sampler2D.magfilter.$}}}(e=n.profile_COMMON.technique)&&!e.length&&(e=[e]);f=function(){return function(a){if(!a.color)return!1;return(a=a.color)?z.floatDelimArray(a.$," "):!1}}();var C=function(){return function(a){var K;
if(!a["float"])return!1;return K=(a=a["float"])?parseFloat(a.$):0,a=K}}(),A=function(){return function(a){if(!a.texture)return!1;return a.texture["@texture"]}}();r.material={textures_ref:[]};n=0;for(v=e.length;n<v;n++){d=e[n].blinn;if(!d)d=e[n].phong;if(!d)d=e[n].lambert;if(d)for(t in d){w=d[t];var M=f(w),X=C(w);w=A(w);M!==!1&&M.length>3&&M.pop();if(t=="emission"){if(M!==!1)r.material.ambient=M}else if(t!="ambient")if(t=="diffuse"){if(M!==!1)r.material.color=M}else if(t=="specular"){if(M!==!1)r.material.specular=
M}else if(t=="shininess"){if(X!==!1)r.material.shininess=X}else t=="reflective"?va():t=="reflectivity"?va():t=="transparent"?va():t=="index_of_refraction"&&va();if(w!==!1)M=r.surfaces[r.samplers[w].source].source,t=="emission"?r.material.textures_ref.push({image:M,type:g.texture.map.AMBIENT}):t=="ambient"?r.material.textures_ref.push({image:M,type:g.texture.map.AMBIENT}):t=="diffuse"?r.material.textures_ref.push({image:M,type:g.texture.map.COLOR}):t=="specular"?r.material.textures_ref.push({image:M,
type:g.texture.map.SPECULAR}):t!="shininess"&&(t=="reflective"?r.material.textures_ref.push({image:M,type:g.texture.map.REFLECT}):t!="reflectivity"&&(t=="transparent"?r.material.textures_ref.push({image:M,type:g.texture.map.ALPHA}):t=="transparency"?va():t=="index_of_refraction"&&va()))}c.effects[B]=r}}}n=ca.getAllOf(y.library_visual_scenes,"instance_material");t=[];if(n.length){f=0;for(e=n.length;f<e;f++)B=n[f],v=B["@symbol"],B=B["@target"].substr(1),t[v]=B}e=y.library_materials;if(e.material){(v=
e.material)&&!v.length&&(v=[v]);e=0;for(n=v.length;e<n;e++)if(B=v[e],d=B["@id"],p=B["@name"],B=B.instance_effect)B=B["@url"].substr(1),c.materials.push({id:d,name:p,mat:c.effects[B].material})}if(e=y.library_geometries)if((B=e.geometry)&&!B.length&&(B=[B]),B.length){d=0;for(p=B.length;d<p;d++){F={id:h,points:[],parts:[]};var ea=B[d].mesh;if(ea){var O=B[d]["@id"];r=B[d]["@name"];(n=ea.source)&&!n.length&&(n=[n]);D=[];v=0;for(f=n.length;v<f;v++)if(C=n[v],e=C["@id"],A=C["@name"],(M=C.float_array)&&(D[e]=
{id:e,name:A,data:z.floatDelimArray(M.$?M.$:""," ")}),C=C.technique_common.accessor)if(D[e].count=parseInt(C["@count"]),D[e].stride=parseInt(C["@stride"]),D[e].count)D[e].data=z.repackArray(D[e].data,D[e].stride,D[e].count);e=ea.vertices;X=M=A=C=null;if(e&&(A=e["@id"],(f=e.input)&&!f.length&&(f=[f]),f)){i=0;for(u=f.length;i<u;i++)o=f[i],o["@semantic"]==="POSITION"&&(C=o["@source"].substr(1))}var G=ea.triangles;G&&!G.length&&(G=[G]);if(G){n=0;for(v=G.length;n<v;n++){var J={material:0,faces:[],normals:[],
texcoords:[]};e=parseInt(G[n]["@count"],10);(f=G[n].input)&&!f.length&&(f=[f]);w=[];if(f.length){i=0;for(u=f.length;i<u;i++)o=f[i],H=parseInt(o["@offset"],10),m=o["@source"].substr(1),o["@semantic"]==="VERTEX"?(m===A&&(m=C),w[H]=0):o["@semantic"]==="NORMAL"?(M=m,D[M].count&&(w[H]=1)):o["@semantic"]==="TEXCOORD"?(X=m,D[X].count&&(w[H]=2)):w[H]=3}o=w.length;f=G[n]["@material"];f===null?J.material=0:t[f]===h?(la("missing material ["+f+"]@"+r+"?"),J.material=0):J.material=t[f];f=G[n].p;o=[];f&&(o=z.intDelimArray(f.$,
" "));if(o.length&&(f=o.length/w.length/3,f===e)){if(F.points.length===0)F.points=D[C].data;f=H=0;e=o.length;for(H=w.length;f<e;f+=H*3){i=[];u=[];q=[];for(m=0;m<H*3;m++)x=m%H,w[x]===0?u.push(o[f+m]):w[x]===1?i.push(o[f+m]):w[x]===2&&q.push(o[f+m]);u.length&&(J.faces.push(u),i.length===3&&J.normals.push([ca.fixuaxis(c.up_axis,D[M].data[i[0]]),ca.fixuaxis(c.up_axis,D[M].data[i[1]]),ca.fixuaxis(c.up_axis,D[M].data[i[2]])]),q.length===3&&J.texcoords.push([D[X].data[q[0]],D[X].data[q[1]],D[X].data[q[2]]]))}}F.parts.push(J)}}r=
ea.polylist;if(!r)r=ea.polygons;r&&!r.length&&(r=[r]);if(r){n=0;for(v=r.length;n<v;n++){J={material:0,faces:[],normals:[],texcoords:[]};q=parseInt(r[n]["@count"],10);(f=r[n].input)&&!f.length&&(f=[f]);w=[];if(f.length){i=0;for(u=f.length;i<u;i++)o=f[i],e=o["@offset"],e===null&&(e=o["@idx"]),H=parseInt(e,10),m=o["@source"].substr(1),o["@semantic"]==="VERTEX"?(m===A&&(m=C),w[H]=0):o["@semantic"]==="NORMAL"?(M=m,w[H]=1):o["@semantic"]==="TEXCOORD"?(X=m,w[H]=2):w[H]=3}e=r[n].vcount;ea=[];e&&(ea=z.intDelimArray(e.$,
" "));f=r[n]["@material"];J.material=f===h?0:t[f];H=r[n].p;o=w.length;G=[];if(H.length>1&&!ea.length){e=0;for(f=H.length;e<f;e++)i=z.intDelimArray(H[e].$," "),ea[e]=parseInt(i.length/o,10),G.splice(G.length,0,i)}else H&&(G=z.intDelimArray(H.$," "));if(G.length)if(f=ea.length,f!==q)la("poly vcount data doesn't add up, skipping object load: "+f+" !== "+q);else{if(F.points.length===0)F.points=D[C].data;f=H=0;for(e=ea.length;f<e;f++){i=[];u=[];q=[];m=0;for(x=ea[f]*o;m<x;m++)w[m%o]===0?(u.push(G[H]),H++):
w[m%o]===1?(i.push(G[H]),H++):w[m%o]===2&&(q.push(G[H]),H++);if(u.length){J.faces.push(u);if(i.length){u=[];m=0;for(x=i.length;m<x;m++)u.push(ca.fixuaxis(c.up_axis,D[M].data[i[m]]));J.normals.push(u)}if(q.length){i=[];m=0;for(x=q.length;m<x;m++)i.push(D[X].data[q[m]]);J.texcoords.push(i)}}}}}}if(s!==1){f=0;for(e=F.points.length;f<e;f++)F.points[f]=ca.fixuaxis(c.up_axis,F.points[f])}F.id=O;c.meshes.push(F)}}}if(t=y.library_cameras){(B=t.camera)&&!B.length&&(B=[B]);t=0;for(n=B.length;t<n;t++){e=B[t];
d=e["@id"];F=p=v=0;if(e.optics&&e.optics.technique_common&&e.optics.technique_common.perspective)v=e.optics.technique_common.perspective.yfov,p=e.optics.technique_common.perspective.znear,F=e.optics.technique_common.perspective.zfar;var E,I;if(!v&&!p&&!F){(v=e.param)&&!v.length&&(v=[v]);f=0;for(e=v.length;f<e;f++)p=v[f].$,F=v[f]["@name"],F=="YFOV"?E=parseFloat(p):F=="ZNEAR"?I=parseFloat(p):F=="ZFAR"&&(l=parseFloat(p))}else E=v?parseFloat(v.$):60,I=p?parseFloat(p.$):0.1,l=F?parseFloat(F.$):1E3;c.cameras.push({id:d,
targeted:!1,fov:parseFloat(E),nearclip:parseFloat(I),farclip:parseFloat(l)})}}if(E=y.library_lights)if((E=E.light)&&!E.length&&(E=[E]),E){I=0;for(l=E.length;I<l;I++)if(B=E[I],e=(t=B.technique_common.point)?t:null,t=B["@id"],e!==null)n=(n=e.intensity)?parseFloat(n.$):1,v=(v=e.distance)?parseFloat(v.$):10,e=e.color,B=[1,1,1],e&&(B=z.floatDelimArray(e.$," ")),c.lights.push({id:t,name:t,type:g.light.type.POINT,method:g.light.method.STATIC,diffuse:B,specular:[0,0,0],distance:v,intensity:n})}if(I=y.library_visual_scenes){E=
null;(E=I.visual_scene)&&!E.length&&(E=[E]);I=0;for(l=E.length;I<l;I++){e=E[I];t={id:e["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};n={};v=[];for(B=[e];B.length;)if(d=B.pop(),d.node&&((u=d.node)&&!u.length&&(u=[u]),u)){f=0;for(e=u.length;f<e;f++)u[f].parentNode=d,v.push(u[f]),B.push(u[f])}if(v.length){d=0;for(p=v.length;d<p;d++){A=v[d];r=A.instance_geometry;B=v[d].instance_light;e=v[d].instance_camera;F=A["@id"];D=A["@name"];f=ca.cl_getInitalTransform(c.up_axis,A);if(s===2)f.rotation=
ca.quaternionFilterZYYZ(f.rotation,e?[-90,0,0]:h);C={};r?(r=r["@url"].substr(1),C.name=C.id=D?D:F,C.position=f.position,C.rotation=f.rotation,C.scale=f.scale,C.meshId=O,C.meshName=r,t.sceneObjects.push(C),n[C.id]=!0,A.parentNode&&(e=A.parentNode["@id"])&&n[e]&&t.parentMap.push({parent:e,child:C.id})):e?(e=e["@url"].substr(1),t.cameras.push({name:D?D:F,id:D?D:F,source:e,position:f.position,rotation:f.rotation})):B?(e=B["@url"].substr(1),t.lights.push({name:D?D:F,id:D?D:F,source:e,position:f.position})):
t.sceneObjects.push({id:D!==null?D:F,name:D!==null?D:F,position:f.position,rotation:f.rotation,scale:f.scale})}}c.scenes.push(t)}}if(O=y.library_animations)if((s=O.animation)&&!s.length&&(s=[s]),s){E=0;for(I=s.length;E<I;E++){n=s[E];O=n["@id"];c.animations[O]={};c.animations[O].sources=[];(v=n.source)&&!v.length&&(v=[v]);if(v.length){l=0;for(t=v.length;l<t;l++){d=v[l];e=d["@id"];r=d.technique_common;p=B=null;d.name_array?B=z.textDelimArray(d.name_array.$," "):d.Name_array?B=z.textDelimArray(d.Name_array.$,
" "):d.float_array&&(p=z.floatDelimArray(d.float_array.$," "));d=0;D="";F=1;if(r)d=r,r=d.accessor,d=parseInt(r["@count"],10),D=r["@source"].substr(1),(r=r["@stride"])&&(F=parseInt(r,10));c.animations[O].sources[e]={data:B?B:p,count:d,source:D,stride:F};if(F!==1)c.animations[O].sources[e].data=z.repackArray(c.animations[O].sources[e].data,F,d)}}(v=n.sampler)&&!v.length&&(v=[v]);if(v){c.animations[O].samplers=[];l=0;for(t=v.length;l<t;l++)if(e=v[l],B=e["@id"],(f=e.input)&&!f.length&&(f=[f]),f){p=[];
d=0;for(e=f.length;d<e;d++)o=f[d],p[o["@semantic"]]=o["@source"].substr(1);c.animations[O].samplers[B]=p}}(l=n.channel)&&!l.length&&(l=[l]);if(l){c.animations[O].channels=[];t=0;for(n=l.length;t<n;t++)v=l[t],e=v["@source"].substr(1),v=v["@target"],d=v.split("/"),B=d[0],d=d[1].split("."),c.animations[O].channels.push({source:e,target:v,targetName:B,paramName:d[0],typeName:d[1]})}}}if(y=y.scene)if(e=y.instance_visual_scene)y=e["@url"].substr(1),c.scene=y;return c}function Qa(a){this.strokes=[];this.bounds=
[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(a!==h){var a=z.getXML(a),b=a.getElementsByTagName("header");if(!b.length)return null;var c=b[0],b=a.getElementsByTagName("environment");if(!b.length)return null;this.name=null;c=c.getElementsByTagName("name");if(c.length)this.name=z.collectTextNode(c[0]);c=b[0].getElementsByTagName("screenBounds");if(c.length)this.bounds=[parseFloat(z.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(z.collectTextNode(c[0].getElementsByTagName("y")[0])),
parseFloat(z.collectTextNode(c[0].getElementsByTagName("z")[0]))];c=b[0].getElementsByTagName("origin");if(c.length)this.origin=[parseFloat(z.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(z.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(z.collectTextNode(c[0].getElementsByTagName("z")[0]))];b=b[0].getElementsByTagName("up");if(b.length)this.upvector=[parseFloat(z.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(z.collectTextNode(b[0].getElementsByTagName("y")[0])),
parseFloat(z.collectTextNode(b[0].getElementsByTagName("z")[0]))];a=a.getElementsByTagName("drawing");b=0;for(c=a.length;b<c;b++)for(var d=a[b].getElementsByTagName("stroke"),e=0,f=0,m=0,r=0,i=0,g=d.length;i<g;i++){for(var q=d[i].getElementsByTagName("pt"),o=q.length,H=Array(o),n,x,t,l=0,p=o;l<p;l++)t=q[l],o=parseFloat(z.collectTextNode(t.getElementsByTagName("x")[0])),n=parseFloat(z.collectTextNode(t.getElementsByTagName("y")[0])),x=parseFloat(z.collectTextNode(t.getElementsByTagName("z")[0])),t=
parseFloat(z.collectTextNode(t.getElementsByTagName("time")[0])),this.upvector[0]===1?H[l]=[n!==n?0:n,o!==o?0:-o,x!==x?0:x,t]:this.upvector[1]===1?H[l]=[o!==o?0:o,n!==n?0:n,x!==x?0:x,t]:this.upvector[2]===1&&(H[l]=[o!==o?0:o,x!==x?0:-x,n!==n?0:n,t]),e<o&&(e=o),f<n&&(f=n),m<x&&(m=x),r<t&&(r=t);if(m>r){q=0;for(l=H.length;q<l;q++)o=H[q][3],H[q][3]=H[q][2],H[q][2]=o/this.bounds[2]}this.strokes[i]=H}}}function xa(a,b,c,d,e,f,m){if(a){this.last_particle=this.particles=null;this.pTex=c!==h?c:null;this.vWidth=
d;this.vHeight=e;this.alpha=f!==h?f:!1;this.alphaCut=m!==h?m:0;this.pfunc=function(a,b){var c=b-a.start_time;if(c<0)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];this.pgov!==null&&this.pgov(a,b);return 1};this.pgov=null;this.hasColor=b===h?!1:b;c=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",
this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;",
"gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":
"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=a;this.numParticles=0;this.arPoints=new Float32Array(a*3);this.glPoints=null;if(b)this.arColor=new Float32Array(a*3),this.glColor=null;this.shader_particle=new E(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");
this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[d,e,0]));this.genBuffer()}}function Ya(a){this.texture=a.texture?a.texture:null;this.width=a.width?a.width:128;this.height=a.height?a.height:128;this.x=a.x?a.x:0;this.y=a.y?a.y:0;this.blend=a.blend?a.blend:!1;this.opacity=typeof a.opacity!=="undefined"?a.opacity:1;this.tint=a.tint?a.tint:[1,1,1];this.type="view";
this.superView=null;this.childViews=[];this.panel=null}function ya(a){this.texture=a.texture?a.texture:null;this.width=a.width?a.width:128;this.height=a.height?a.height:128;this.x=a.x?a.x:0;this.y=a.y?a.y:0;this.blend=a.blend?a.blend:!1;this.opacity=typeof a.opacity!=="undefined"?a.opacity:1;this.tint=a.tint?a.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}var J=p.PI,pa=2*p.PI,N=p.PI/2,Aa="";try{for(var ma=sa.querySelectorAll("script"),
fa=0,Za=ma.length;fa<Za;fa++){var ob=ma[fa].src.lastIndexOf("/CubicVR.js");ob>-1&&(Aa=ma[fa].src.substr(0,ob)+"/")}}catch(Ab){}var w=P.CubicVR={},l={canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,resizeList:[]},ka=[],Y=[],U=[],qa=[],za=[],Ra=[],la;try{la=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(Bb){la=function(){}}var g=
{math:{},frustum:{plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}},octree:{TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7},light:{type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,MAX:7},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}},texture:{map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}},uv:{axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,
SPHERICAL:3,CUBIC:4,SKY:5}},shader:{map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}},motion:{POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3},envelope:{shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}},post:{output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}}},oa=[1,0,0,0,0,1,0,0,0,0,1,
0,0,0,0,1],pb={equal:function(a,b,c){c===h&&(c=1.0E-8);if(a===h&&b===h)return!0;if(a===h||b===h)return!1;return p.abs(a[0]-b[0])<c&&p.abs(a[1]-b[1])<c}},s={length:function(a){return p.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var b=p.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);if(b===0)return[0,0,0];return[a[0]/b,a[1]/b,a[2]/b]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return p.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(p.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*
p.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,c){c===h&&(c=1.0E-7);if(a===h&&b===h)return!0;if(a===h||b===h)return!1;return p.abs(a[0]-b[0])<c&&p.abs(a[1]-b[1])<c&&p.abs(a[2]-b[2])<c},moveViewRelative:function(a,b,c,d,e){var f=
p.atan2(d,c),b=p.atan2(b[2]-a[2],b[0]-a[0]),c=p.sqrt(c*c+d*d),f=b+f+N;if(typeof e==="object")return[e[0]+c*p.cos(f),e[1],e[2]+c*p.sin(f)];return[a[0]+c*p.cos(f),a[1],a[2]+c*p.sin(f)]},trackTarget:function(a,b,c,d){var b=s.subtract(b,a),e=s.length(b),f;f=s.normalize(b);f=s.multiply(f,c*(1/(1/(e-d))));e>d?a=s.add(a,f):e<d?(f=s.normalize(b),f=s.multiply(f,c*(1/(1/p.abs(e-d)))),a=s.subtract(a,f)):a=[a[0],a[1]+f[2],a[2]];return a},getClosestTo:function(a,b,c){b=s.subtract(b,a);c=s.subtract(c,a);return s.add(s.multiply(b,
s.dot(b,c)/s.dot(b,b)),a)},linePlaneIntersect:function(a,b,c,d){var e=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(d[0]-c[0])+a[1]*(d[1]-c[1])+a[2]*(d[2]-c[2]);if(p.abs(b)<0.0010)return!1;a=-(e+a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/b;return[c[0]+a*(d[0]-c[0]),c[1]+a*(d[1]-c[1]),c[2]+a*(d[2]-c[2])]}},qb={normal:function(a,b,c){var d=a[0]-b[0],e=a[1]-b[1],a=a[2]-b[2],f=b[0]-c[0],m=b[1]-c[1],b=b[2]-c[2];return[e*b-a*m,a*f-d*b,d*m-e*f]}},Ma={transpose_inline:function(a){var b=a[1],c=a[2],d=a[5];a[1]=a[3];a[2]=a[6];
a[3]=b;a[5]=a[7];a[6]=c;a[7]=d},vec3_multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];c[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];c[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return c}},A={lookat:function(a,b,c,d,e,f,m,g,i){var h=[],q=[],o=[],q=[];h[0]=d-a;h[1]=e-b;h[2]=f-c;o[0]=m;o[1]=g;o[2]=i;h=s.normalize(h);q=s.cross(h,o);q=s.normalize(q);o=s.cross(q,h);q=[q[0],o[0],-h[0],0,q[1],o[1],-h[1],0,q[2],o[2],-h[2],0,0,0,0,1];d=new R(q);d.translate([-a,-b,-c]);return d.getResult()},multiply:function(a,
b){var c=[];c[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];c[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];c[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];c[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];c[4]=b[0]*a[4]+b[4]*a[5]+b[8]*a[6]+b[12]*a[7];c[5]=b[1]*a[4]+b[5]*a[5]+b[9]*a[6]+b[13]*a[7];c[6]=b[2]*a[4]+b[6]*a[5]+b[10]*a[6]+b[14]*a[7];c[7]=b[3]*a[4]+b[7]*a[5]+b[11]*a[6]+b[15]*a[7];c[8]=b[0]*a[8]+b[4]*a[9]+b[8]*a[10]+b[12]*a[11];c[9]=b[1]*a[8]+b[5]*a[9]+b[9]*a[10]+b[13]*a[11];c[10]=b[2]*a[8]+b[6]*
a[9]+b[10]*a[10]+b[14]*a[11];c[11]=b[3]*a[8]+b[7]*a[9]+b[11]*a[10]+b[15]*a[11];c[12]=b[0]*a[12]+b[4]*a[13]+b[8]*a[14]+b[12]*a[15];c[13]=b[1]*a[12]+b[5]*a[13]+b[9]*a[14]+b[13]*a[15];c[14]=b[2]*a[12]+b[6]*a[13]+b[10]*a[14]+b[14]*a[15];c[15]=b[3]*a[12]+b[7]*a[13]+b[11]*a[14]+b[15]*a[15];return c},vec4_multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];c[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];c[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];c[3]=b[3]*a[0]+b[7]*a[1]+b[11]*
a[2]+b[15]*a[3];return c},vec3_multiply:function(a,b){var c=[];c[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12];c[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];c[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return c},perspective:function(a,b,c,d){a=p.tan(a*J/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(d+c)/(d-c),-1,0,0,-(2*d*c)/(d-c),0]},ortho:function(a,b,c,d,e,f){return[2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,-2/(f-e),0,-(a+b)/(b-a),-(d+c)/(d-c),-(f+e)/(f-e),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-
a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],c=a[0],d=a[1],e=a[2],f=a[4],m=a[5],g=a[6],i=a[8],h=a[9],a=a[10],q=a*m-g*h,o=-a*f+
g*i,l=h*f-m*i,n=c*q+d*o+e*l;if(!n)return null;n=1/n;b[0]=q*n;b[1]=(-a*d+e*h)*n;b[2]=(g*d-e*m)*n;b[3]=o*n;b[4]=(a*c-e*i)*n;b[5]=(-g*c+e*f)*n;b[6]=l*n;b[7]=(-h*c+d*i)*n;b[8]=(m*c-d*f)*n;return b},inverse$1:function(a){for(var b=[],c=[],d=[],e=0;e<4;e++)c[e+0]=a[e*4+0],c[e+4]=a[e*4+1],c[e+8]=a[e*4+2],c[e+12]=a[e*4+3];b[0]=c[10]*c[15];b[1]=c[11]*c[14];b[2]=c[9]*c[15];b[3]=c[11]*c[13];b[4]=c[9]*c[14];b[5]=c[10]*c[13];b[6]=c[8]*c[15];b[7]=c[11]*c[12];b[8]=c[8]*c[14];b[9]=c[10]*c[12];b[10]=c[8]*c[13];b[11]=
c[9]*c[12];d[0]=b[0]*c[5]+b[3]*c[6]+b[4]*c[7];d[0]-=b[1]*c[5]+b[2]*c[6]+b[5]*c[7];d[1]=b[1]*c[4]+b[6]*c[6]+b[9]*c[7];d[1]-=b[0]*c[4]+b[7]*c[6]+b[8]*c[7];d[2]=b[2]*c[4]+b[7]*c[5]+b[10]*c[7];d[2]-=b[3]*c[4]+b[6]*c[5]+b[11]*c[7];d[3]=b[5]*c[4]+b[8]*c[5]+b[11]*c[6];d[3]-=b[4]*c[4]+b[9]*c[5]+b[10]*c[6];d[4]=b[1]*c[1]+b[2]*c[2]+b[5]*c[3];d[4]-=b[0]*c[1]+b[3]*c[2]+b[4]*c[3];d[5]=b[0]*c[0]+b[7]*c[2]+b[8]*c[3];d[5]-=b[1]*c[0]+b[6]*c[2]+b[9]*c[3];d[6]=b[3]*c[0]+b[6]*c[1]+b[11]*c[3];d[6]-=b[2]*c[0]+b[7]*c[1]+
b[10]*c[3];d[7]=b[4]*c[0]+b[9]*c[1]+b[10]*c[2];d[7]-=b[5]*c[0]+b[8]*c[1]+b[11]*c[2];b[0]=c[2]*c[7];b[1]=c[3]*c[6];b[2]=c[1]*c[7];b[3]=c[3]*c[5];b[4]=c[1]*c[6];b[5]=c[2]*c[5];b[6]=c[0]*c[7];b[7]=c[3]*c[4];b[8]=c[0]*c[6];b[9]=c[2]*c[4];b[10]=c[0]*c[5];b[11]=c[1]*c[4];d[8]=b[0]*c[13]+b[3]*c[14]+b[4]*c[15];d[8]-=b[1]*c[13]+b[2]*c[14]+b[5]*c[15];d[9]=b[1]*c[12]+b[6]*c[14]+b[9]*c[15];d[9]-=b[0]*c[12]+b[7]*c[14]+b[8]*c[15];d[10]=b[2]*c[12]+b[7]*c[13]+b[10]*c[15];d[10]-=b[3]*c[12]+b[6]*c[13]+b[11]*c[15];
d[11]=b[5]*c[12]+b[8]*c[13]+b[11]*c[14];d[11]-=b[4]*c[12]+b[9]*c[13]+b[10]*c[14];d[12]=b[2]*c[10]+b[5]*c[11]+b[1]*c[9];d[12]-=b[4]*c[11]+b[0]*c[9]+b[3]*c[10];d[13]=b[8]*c[11]+b[0]*c[8]+b[7]*c[10];d[13]-=b[6]*c[10]+b[9]*c[11]+b[1]*c[8];d[14]=b[6]*c[9]+b[11]*c[11]+b[3]*c[8];d[14]-=b[10]*c[11]+b[2]*c[8]+b[7]*c[9];d[15]=b[10]*c[10]+b[4]*c[8]+b[9]*c[9];d[15]-=b[8]*c[9]+b[11]*c[10]+b[5]*c[8];a=c[0]*d[0]+c[1]*d[1]+c[2]*d[2]+c[3]*d[3];b=[];a=1/a;for(e=0;e<16;e++)b[e]=d[e]*a;return b},inverse$2:function(a){var b=
[];b[0]=a[5]*a[10]*a[15]-a[5]*a[11]*a[14]-a[9]*a[6]*a[15]+a[9]*a[7]*a[14]+a[13]*a[6]*a[11]-a[13]*a[7]*a[10];b[4]=-a[4]*a[10]*a[15]+a[4]*a[11]*a[14]+a[8]*a[6]*a[15]-a[8]*a[7]*a[14]-a[12]*a[6]*a[11]+a[12]*a[7]*a[10];b[8]=a[4]*a[9]*a[15]-a[4]*a[11]*a[13]-a[8]*a[5]*a[15]+a[8]*a[7]*a[13]+a[12]*a[5]*a[11]-a[12]*a[7]*a[9];b[12]=-a[4]*a[9]*a[14]+a[4]*a[10]*a[13]+a[8]*a[5]*a[14]-a[8]*a[6]*a[13]-a[12]*a[5]*a[10]+a[12]*a[6]*a[9];b[1]=-a[1]*a[10]*a[15]+a[1]*a[11]*a[14]+a[9]*a[2]*a[15]-a[9]*a[3]*a[14]-a[13]*a[2]*
a[11]+a[13]*a[3]*a[10];b[5]=a[0]*a[10]*a[15]-a[0]*a[11]*a[14]-a[8]*a[2]*a[15]+a[8]*a[3]*a[14]+a[12]*a[2]*a[11]-a[12]*a[3]*a[10];b[9]=-a[0]*a[9]*a[15]+a[0]*a[11]*a[13]+a[8]*a[1]*a[15]-a[8]*a[3]*a[13]-a[12]*a[1]*a[11]+a[12]*a[3]*a[9];b[13]=a[0]*a[9]*a[14]-a[0]*a[10]*a[13]-a[8]*a[1]*a[14]+a[8]*a[2]*a[13]+a[12]*a[1]*a[10]-a[12]*a[2]*a[9];b[2]=a[1]*a[6]*a[15]-a[1]*a[7]*a[14]-a[5]*a[2]*a[15]+a[5]*a[3]*a[14]+a[13]*a[2]*a[7]-a[13]*a[3]*a[6];b[6]=-a[0]*a[6]*a[15]+a[0]*a[7]*a[14]+a[4]*a[2]*a[15]-a[4]*a[3]*
a[14]-a[12]*a[2]*a[7]+a[12]*a[3]*a[6];b[10]=a[0]*a[5]*a[15]-a[0]*a[7]*a[13]-a[4]*a[1]*a[15]+a[4]*a[3]*a[13]+a[12]*a[1]*a[7]-a[12]*a[3]*a[5];b[14]=-a[0]*a[5]*a[14]+a[0]*a[6]*a[13]+a[4]*a[1]*a[14]-a[4]*a[2]*a[13]-a[12]*a[1]*a[6]+a[12]*a[2]*a[5];b[3]=-a[1]*a[6]*a[11]+a[1]*a[7]*a[10]+a[5]*a[2]*a[11]-a[5]*a[3]*a[10]-a[9]*a[2]*a[7]+a[9]*a[3]*a[6];b[7]=a[0]*a[6]*a[11]-a[0]*a[7]*a[10]-a[4]*a[2]*a[11]+a[4]*a[3]*a[10]+a[8]*a[2]*a[7]-a[8]*a[3]*a[6];b[11]=-a[0]*a[5]*a[11]+a[0]*a[7]*a[9]+a[4]*a[1]*a[11]-a[4]*
a[3]*a[9]-a[8]*a[1]*a[7]+a[8]*a[3]*a[5];b[15]=a[0]*a[5]*a[10]-a[0]*a[6]*a[9]-a[4]*a[1]*a[10]+a[4]*a[2]*a[9]+a[8]*a[1]*a[6]-a[8]*a[2]*a[5];det=a[0]*b[0]+a[1]*b[4]+a[2]*b[8]+a[3]*b[12];if(det==0)return null;inverse_det=1/det;b[0]*=inverse_det;b[1]*=inverse_det;b[2]*=inverse_det;b[3]*=inverse_det;b[4]*=inverse_det;b[5]*=inverse_det;b[6]*=inverse_det;b[7]*=inverse_det;b[8]*=inverse_det;b[9]*=inverse_det;b[10]*=inverse_det;b[11]*=inverse_det;b[12]*=inverse_det;b[13]*=inverse_det;b[14]*=inverse_det;b[15]*=
inverse_det;return b},inverse:function(a){var b=a[0]*a[5]-a[1]*a[4],c=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],e=a[1]*a[6]-a[2]*a[5],f=a[1]*a[7]-a[3]*a[5],m=a[2]*a[7]-a[3]*a[6],g=a[8]*a[13]-a[9]*a[12],i=a[8]*a[14]-a[10]*a[12],h=a[8]*a[15]-a[11]*a[12],q=a[9]*a[14]-a[10]*a[13],o=a[9]*a[15]-a[11]*a[13],l=a[10]*a[15]-a[11]*a[14],n=b*l-c*o+d*q+e*h-f*i+m*g;if(n!=0){var x=[];x[0]=0+a[5]*l-a[6]*o+a[7]*q;x[4]=0-a[4]*l+a[6]*h-a[7]*i;x[8]=0+a[4]*o-a[5]*h+a[7]*g;x[12]=0-a[4]*q+a[5]*i-a[6]*g;x[1]=0-a[1]*l+a[2]*
o-a[3]*q;x[5]=0+a[0]*l-a[2]*h+a[3]*i;x[9]=0-a[0]*o+a[1]*h-a[3]*g;x[13]=0+a[0]*q-a[1]*i+a[2]*g;x[2]=0+a[13]*m-a[14]*f+a[15]*e;x[6]=0-a[12]*m+a[14]*d-a[15]*c;x[10]=0+a[12]*f-a[13]*d+a[15]*b;x[14]=0-a[12]*e+a[13]*c-a[14]*b;x[3]=0-a[9]*m+a[10]*f-a[11]*e;x[7]=0+a[8]*m-a[10]*d+a[11]*c;x[11]=0-a[8]*f+a[9]*d-a[11]*b;x[15]=0+a[8]*e-a[9]*c+a[10]*b;a=1/n;x[0]*=a;x[1]*=a;x[2]*=a;x[3]*=a;x[4]*=a;x[5]*=a;x[6]*=a;x[7]*=a;x[8]*=a;x[9]*=a;x[10]*=a;x[11]*=a;x[12]*=a;x[13]*=a;x[14]*=a;x[15]*=a;return x}return null}},
z={getScriptContents:function(a){var b=sa.getElementById(a),c="",d="";if(b){if(b.src!==""||b.attributes.srcUrl!==h)d=b.src!==""?b.src:b.attributes.srcUrl.value}else d=a;if(d.length!==0){if(a=new XMLHttpRequest,a.open("GET",d,!1),a.send(null),a.status===200||a.status===0)c=a.responseText}else for(d=b.firstChild;d;)d.nodeType===3&&(c+=d.textContent),d=d.nextSibling;return c},getURL:function(a){try{var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);if(b.status===200||b.status===0)if(b.responseText.length)return b.responseText;
else if(b.responseXML)return b.responseXML}catch(c){alert(a+" failed to load.")}return null},getXML:function(a){try{var b=new XMLHttpRequest;b.open("GET",a,!1);b.overrideMimeType("application/xml");b.send(null);if(b.status===200||b.status===0)return b.responseXML}catch(c){try{alert(a+" failed to load.")}catch(d){throw c;}}return null},repackArray:function(a,b,c){a.length!==parseInt(b,10)*parseInt(c,10)&&la("array repack error, data size !== stride*count: data.length="+a.length+" stride="+b+" count="+
c);for(var c=[],d=0,e=0,f=a.length;e<f;e++){var m=e%b;m===0&&(c[d]=[]);c[d][m]=a[e];m===b-1&&d++}return c},collectTextNode:function(a){if(!a)return"";for(var b="",a=a.childNodes,c=0,d=a.length;c<d;c++)b+=a[c].nodeValue;return b},floatDelimArray:function(a,b){for(var c=a.split(b?b:","),d=0,e=c.length;d<e;d++)c[d]=parseFloat(c[d]);c[c.length-1]!==c[c.length-1]&&c.pop();return c},intDelimArray:function(a,b){for(var c=a.split(b?b:","),d=0,e=c.length;d<e;d++)c[d]=parseInt(c[d],10);c[c.length-1]!==c[c.length-
1]&&c.pop();return c},textDelimArray:function(a,b){for(var c=a.split(b?b:","),d=0,e=c.length;d<e;d++)c[d]=c[d];return c}},Ga=6;l.init=function(a,b,c){var d;b&&c?(b=z.getScriptContents(b),c=z.getScriptContents(c)):w.CubicVRCoreVS&&w.CubicVRCoreFS?(b=w.CubicVRCoreVS,c=w.CubicVRCoreFS):(b=z.getScriptContents(Aa+"CubicVR_Core.vs"),c=z.getScriptContents(Aa+"CubicVR_Core.fs"));if(a===h)a=sa.createElement("canvas"),d||(d=a.getContext("experimental-webgl")),l.gl=d,l.fixed_size!==null?(l.width=l.fixed_size[0],
l.height=l.fixed_size[1],l.resizeElement(a,l.width,l.height)):(a.style.position="absolute",l.addResizeable(a),l.resizeElement(a,P.innerWidth,P.innerHeight)),sa.body.appendChild(a);if(a.getContext!==h&&a.width!==h&&a.height!==h){try{d||(d=a.getContext("experimental-webgl")),d.viewport(0,0,a.width,a.height),l.canvas=a,l.width=a.width,l.height=a.height,d.clearColor(0,0,0,1),d.clearDepth(1),d.enable(d.DEPTH_TEST),d.depthFunc(d.LEQUAL)}catch(e){}if(!d)return null}else d=a;l.gl=d;l.CoreShader_vs=b;l.CoreShader_fs=
c;d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);for(b=g.light.type.NULL;b<g.light.type.MAX;b++)za[b]=[];c=new w.Texture;a=new w.Material;for(b=0;b<g.texture.map.MAX;b++)b!==g.texture.map.BUMP&&a.setTexture(c,b);a.opacity=0.5;b=1;try{for(;;){a.use(g.light.type.POINT,b);if(b===8){Ga=b;break}b++}}catch(f){Ga=b}la("Calibrated maximum lights per pass to: "+b);for(b=g.light.type.NULL;b<g.light.type.MAX;b++)za[b]=[];if(l.resizeList.length)P.addEventListener("resize",function(){w.GLCore.onResize()},
!1),l.resize_active=!0;return d};l.addResizeable=function(a){w.GLCore.resizeList.push(a)};l.onResize=function(){var a=P.innerWidth,b=P.innerHeight;l.fixed_size!==null&&(a=w.GLCore.fixed_size[0],b=w.GLCore.fixed_size[1]);for(var c=0,d=w.GLCore.resizeList.length;c<d;c++)l.resizeElement(w.GLCore.resizeList[c],a,b)};l.setFixedAspect=function(a){w.GLCore.fixed_aspect=a};l.setFixedSize=function(a,b){w.GLCore.fixed_size=[a,b]};l.getCanvas=function(){return w.GLCore.canvas};l.resizeElement=function(a,b,c){var d=
l.gl;if(l.fixed_aspect!==0){var e=b*(1/w.GLCore.fixed_aspect);e>c&&(e=c,b=c*w.GLCore.fixed_aspect);c=e}if(a.getContext!==h){a.width=b;a.height=c;if(!w.GLCore.fixed_size)a.style.left=parseInt(P.innerWidth/2-b/2)+"px",a.style.top=parseInt(P.innerHeight/2-c/2)+"px";d.viewport(0,0,b,c)}else a.resize(b,c)};l.setDepthAlpha=function(a,b,c){l.depth_alpha=a;l.depth_alpha_near=b;l.depth_alpha_far=c};l.setDefaultFilter=function(a){l.default_filter=a};l.setSoftShadows=function(a){l.soft_shadow=a};var Na=function(a,
b,c){if(c==="x-shader/x-fragment")c=a.createShader(a.FRAGMENT_SHADER);else if(c==="x-shader/x-vertex")c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,b);a.compileShader(c);if(!a.getShaderParameter(c,a.COMPILE_STATUS))return la(a.getShaderInfoLog(c)),null;return c},cb=function(a,b){var c=sa.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)e.nodeType===3&&(d+=e.textContent),e=e.nextSibling;if(c.type==="x-shader/x-fragment")c=a.createShader(a.FRAGMENT_SHADER);else if(c.type===
"x-shader/x-vertex")c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,d);a.compileShader(c);a.getShaderParameter(c,a.COMPILE_STATUS)||la(a.getShaderInfoLog(c));return c},ua=new function(){this.listener=null};self.addEventListener("message",function(a){var b=a.data.message,c=a.data.data;if(b==="start")if(c==="test")ua.listener=new vb;else if(c==="load_collada")ua.listener=new wb;else{if(c==="octree")ua.listener=new lb}else if(b==="function")if(b=a.data.options,c=a.data.data.split("("),
c.length>1&&c[1].indexOf(")")>-1){for(var a=c[0],c=c[1].substr(0,c[1].length-1),b=b||c.split(","),a=a.split("."),c=w,d=0;d<a.length;++d)c=c[a[d]];c&&typeof c==="function"&&(b=c.apply(c,b),postMessage(b))}else throw Error("Worker command not formatted properly.");else if(b==="data"){if(ua.listener!==null)ua.listener.onmessage(a.data.data)}else b==="stop"&&ua.listener!==null&&ua.listener.stop&&ua.listener.stop()},!1);Q.prototype.start=function(){this.update();this.num_updates=0;this.last_update=this.start_time=
this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0};Q.prototype.stop=function(){this.end_time=this.system_milliseconds};Q.prototype.reset=function(){this.start()};Q.prototype.lockFramerate=function(){this.lock_rate=1/this.f_rate;this.lock_state=!0};Q.prototype.unlock=function(){var a=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=
0};Q.prototype.locked=function(){return this.lock_state};Q.prototype.update=function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=parseInt(lock_rate*1E3):this.system_milliseconds=(new Date).getTime();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset};Q.prototype.getMilliseconds=function(){return this.time_elapsed};Q.prototype.getSeconds=
function(){return this.getMilliseconds()/1E3};Q.prototype.setMilliseconds=function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a};Q.prototype.setSeconds=function(a){this.setMilliseconds(parseInt(a*1E3))};Q.prototype.getLastUpdateSeconds=function(){return this.getLastUpdateMilliseconds()/1E3};Q.prototype.getLastUpdateMilliseconds=function(){return this.system_milliseconds-this.last_update};Q.prototype.getTotalMilliseconds=function(){return this.system_milliseconds-
this.start_time};Q.prototype.getTotalSeconds=function(){return this.getTotalMilliseconds()/1E3};Q.prototype.getNumUpdates=function(){return this.num_updates};Q.prototype.setPaused=function(a){this.paused_state=a};Q.prototype.getPaused=function(){return this.paused_state};Ba.prototype.setPaused=function(a){this.timer.setPaused(a)};Ba.prototype.getPaused=function(){return this.timer.getPaused()};Ba.prototype.setTimerSeconds=function(a){this.timer.setSeconds(a)};Ba.prototype.getTimerSeconds=function(){return this.timer.getSeconds()};
Ba.prototype.resetTimer=function(){this.timer.reset()};ia.prototype.setEvents=function(a){this.mEvents={};for(var b in a)this.bindEvent(b,a[b])};ia.prototype.orbitView=function(a){var b=s.subtract(this.camera.target,this.camera.position),b=s.length(b);this.camera.position=s.moveViewRelative(this.camera.position,this.camera.target,-b*a[0]/300,0);this.camera.position[1]+=b*a[1]/300;this.camera.position=s.add(this.camera.target,s.multiply(s.normalize(s.subtract(this.camera.position,this.camera.target)),
b))};ia.prototype.panView=function(a,b){b||(b=!1);var c=s.subtract(this.camera.target,this.camera.position),c=s.length(c),d=this.camera.position;b?this.camera.position=s.moveViewRelative(this.camera.position,this.camera.target,-c*a[0]/300,-c*a[1]/300):(this.camera.position=s.moveViewRelative(this.camera.position,this.camera.target,-c*a[0]/300,0),this.camera.position[1]+=c*a[1]/300);c=s.subtract(this.camera.position,d);this.camera.target=s.add(this.camera.target,c)};ia.prototype.zoomView=function(a,
b,c){var d=s.subtract(this.camera.target,this.camera.position),d=s.length(d);d-=a/1E3;b||(b=0.1);c||(c=1E3);d<b&&(d=b);d>c&&(d=c);this.camera.position=s.add(this.camera.target,s.multiply(s.normalize(s.subtract(this.camera.position,this.camera.target)),d))};ia.prototype.bindEvent=function(a,b){this.mEvents[a]=b===h?this.eventDefaults[a]:b};ia.prototype.unbindEvent=function(a){this.bindEvent(a,null)};ia.prototype.bind=function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",
this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.addEventListener("keydown",this.onKeyDown,!1);this.canvas.addEventListener("keyup",this.onKeyUp,!1)};ia.prototype.unbind=function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",
this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.removeEventListener("keydown",this.onKeyDown,!1);this.canvas.removeEventListener("keyup",this.onKeyUp,!1)};ia.prototype.setCamera=function(a){this.camera=a};ia.prototype.getMousePosition=function(){return this.mpos};R.prototype.setIdentity=function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&
this.c_stack&&this.valid--;return this};R.prototype.getIdentity=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]};R.prototype.invalidate=function(){this.valid=0;this.result=null;return this};R.prototype.getResult=function(){if(!this.c_stack)return this.m_stack[0];var a=oa;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var b=this.valid;b<this.c_stack+1;b++)a=A.multiply(this.m_stack[b],a),this.m_cache[b]=a;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]};R.prototype.pushMatrix=
function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:oa;return this};R.prototype.popMatrix=function(){if(this.c_stack!==0)return this.c_stack--,this};R.prototype.clearStack=function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==h?this.m_stack[0]=a:this.setIdentity();return this};R.prototype.translate=function(a,b,c){if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var d=this.getIdentity();d[12]=a;d[13]=b;d[14]=c;this.m_stack[this.c_stack]=A.multiply(d,
this.m_stack[this.c_stack]);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this};R.prototype.scale=function(a,b,c){if(typeof a==="object")return this.scale(a[0],a[1],a[2]);var d=this.getIdentity();d[0]=a;d[5]=b;d[10]=c;this.m_stack[this.c_stack]=A.multiply(d,this.m_stack[this.c_stack]);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this};R.prototype.rotate=function(a,b,c,d){if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,
0,1),this;var e,f;if(b||c||d)e=p.sin(-a*(J/180)),f=p.cos(-a*(J/180));d&&(a=this.getIdentity(),a[0]=f*d,a[4]=e*d,a[1]=-e*d,a[5]=f*d,this.m_stack[this.c_stack]=A.multiply(this.m_stack[this.c_stack],a));c&&(d=this.getIdentity(),d[0]=f*c,d[8]=-e*c,d[2]=e*c,d[10]=f*c,this.m_stack[this.c_stack]=A.multiply(this.m_stack[this.c_stack],d));b&&(c=this.getIdentity(),c[5]=f*b,c[9]=e*b,c[6]=-e*b,c[10]=f*b,this.m_stack[this.c_stack]=A.multiply(this.m_stack[this.c_stack],c));this.valid===this.c_stack&&this.c_stack&&
this.valid--;return this};na.prototype.length=function(){return p.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)};na.prototype.normalize=function(){var a=p.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a};na.prototype.fromEuler=function(a,b,c){var d=p.cos(J/180*b/2),b=p.sin(J/180*b/2),e=p.cos(J/180*c/2),c=p.sin(J/180*c/2),f=p.cos(J/180*a/2),a=p.sin(J/180*a/2),m=d*e,g=b*c;this.w=m*f-g*a;this.x=m*a+g*f;this.y=b*e*f+d*c*a;this.z=d*c*f-b*e*a};na.prototype.toEuler=function(){var a=
this.w*this.w,b=this.x*this.x,c=this.y*this.y,d=this.z*this.z,e=180/J*p.atan2(2*(this.y*this.z+this.x*this.w),-b-c+d+a),f=180/J*p.asin(-2*(this.x*this.z-this.y*this.w)),a=180/J*p.atan2(2*(this.x*this.y+this.z*this.w),b-c-d+a);return[e,f,a]};na.prototype.multiply=function(a,b){b===h&&(b=a,a=this);return new na(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)};Ca.prototype.setUV=function(a,b){b!==h?this.uvs[b]=a:a.length!==
2?this.uvs=a:this.uvs.push(a)};Ca.prototype.setColor=function(a,b){b!==h?this.point_colors[b]=a:typeof colors[0]!=="number"?this.point_colors=a:this.point_colors.push(a)};Ca.prototype.flip=function(){for(var a=0,b=this.point_normals.length;a<b;a++)this.point_normals[a]=[-this.point_normals[a][0],-this.point_normals[a][1],-this.point_normals[a][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]};L.prototype.showAllSegments=
function(){for(var a in this.segment_state)this.segment_state.hasOwnProperty(a)&&(this.segment_state[a]=!0)};L.prototype.hideAllSegments=function(){for(var a in this.segment_state)this.segment_state.hasOwnProperty(a)&&(this.segment_state[a]=!1)};L.prototype.setSegment=function(a,b){b!==h?this.segment_state[a]=b:this.currentSegment=a};L.prototype.addPoint=function(a){if(a.length!==3||typeof a[0]==="object")for(var b=0,c=a.length;b<c;b++)this.points.push(a[b]);else this.points.push(a);return this.points.length-
1};L.prototype.getMaterialIndex=function(a){return this.materials.indexOf(a)};L.prototype.setFaceMaterial=function(a,b){typeof a=="number"?mat_id=a:(mat_id=this.materials.indexOf(a),mat_id===-1&&(this.materials.push(a),mat_id=this.materials.length-1));if(b!==h){if(this.faces[b]!==h)this.faces[b].material=mat_id}else this.currentMaterial=mat_id;return this};L.prototype.addFace=function(a,b,c,d){if(typeof a[0]!=="number"){b=0;for(c=a.length;b<c;b++)this.addFace(a[b])}else{b===h?(this.currentFace=this.faces.length,
this.faces.push(new Ca)):(this.faces[b]===h&&(this.faces[b]=new Ca),this.currentFace=b);if(typeof a==="object")this.faces[this.currentFace].points=a;c!==h?this.setFaceMaterial(c,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=d!==h?d:this.currentSegment;return this.currentFace}};L.prototype.flipFaces=function(){for(var a=0,b=this.faces.length;a<b;a++)this.faces[a].flip()};L.prototype.triangulateQuads=function(){for(var a=0,b=this.faces.length;a<
b;a++)if(this.faces[a].points.length===4){var c=this.faces.length;this.addFace([this.faces[a].points[2],this.faces[a].points[3],this.faces[a].points[0]],this.faces.length,this.faces[a].material,this.faces[a].segment);this.faces[a].points.pop();this.faces[c].normal=this.faces[a].normal;this.faces[a].uvs!==h&&this.faces[a].uvs.length===4&&(this.faces[c].setUV(this.faces[a].uvs[2],0),this.faces[c].setUV(this.faces[a].uvs[3],1),this.faces[c].setUV(this.faces[a].uvs[0],2),this.faces[a].uvs.pop());this.faces[a].point_normals.length===
4&&(this.faces[c].point_normals[0]=this.faces[a].point_normals[2],this.faces[c].point_normals[1]=this.faces[a].point_normals[3],this.faces[c].point_normals[2]=this.faces[a].point_normals[0],this.faces[a].point_normals.pop())}return this};L.prototype.booleanAdd=function(a,b){var c=this.points.length,d,e,f,m;if(b!==h){var g=b.getResult();d=0;for(f=a.points.length;d<f;d++)this.addPoint(A.vec3_multiply(a.points[d],g))}else{d=0;for(f=a.points.length;d<f;d++)this.addPoint([a.points[d][0],a.points[d][1],
a.points[d][2]])}g=[];d=0;for(f=a.materials.length;d<f;d++)e=this.materials.indexOf(a.materials[d]),e===-1?(this.materials.push(a.materials[d]),g[d]=this.materials.length-1):g[d]=e;d=0;for(f=a.faces.length;d<f;d++){var i=[];e=0;for(m=a.faces[d].points.length;e<m;e++)i.push(a.faces[d].points[e]+c);i=this.faces[this.addFace(i)];i.segment=a.faces[d].segment;i.material=g[a.faces[d].material];e=0;for(m=a.faces[d].uvs.length;e<m;e++)i.uvs[e]=[a.faces[d].uvs[e][0],a.faces[d].uvs[e][1]];e=0;for(m=a.faces[d].point_normals.length;e<
m;e++)i.point_normals[e]=[a.faces[d].point_normals[e][0],a.faces[d].point_normals[e][1],a.faces[d].point_normals[e][2]]}return this};L.prototype.calcFaceNormals=function(){for(var a=0,b=this.faces.length;a<b;a++)this.faces[a].normal=this.faces[a].points.length<3?[0,0,0]:s.normalize(qb.normal(this.points[this.faces[a].points[0]],this.points[this.faces[a].points[1]],this.points[this.faces[a].points[2]]));return this};L.prototype.getMaterial=function(a){for(var b=0,c=this.materials.length;b<c;b++)if(this.materials[b].name===
a)return this.materials[b];return null};L.prototype.calcNormals=function(a){var b=!1;a!==h&&(b=!0);this.calcFaceNormals();var c,d,e,f,m=Array(this.points.length);c=0;for(f=m.length;c<f;c++)m[c]=[];e=this.faces.length;for(c=0;c<e;c++){f=this.faces[c].points.length;for(d=0;d<f;d++)m[this.faces[c].points[d]].push([c,d])}c=0;for(f=this.points.length;c<f;c++){var g=m[c].length;for(d=0;d<g;d++){var i=1,u=m[c][d][0],q=m[c][d][1],o=this.materials[this.faces[u].material].max_smooth,l=this.faces[u];b&&(a[u]===
h&&(a[u]=[]),a[u][q]===h&&(a[u][q]=[]));var n=Array(3);n[0]=l.normal[0];n[1]=l.normal[1];n[2]=l.normal[2];if(o!==0)for(e=0;e<g;e++)if(d!==e){var x=m[c][e][0],t=this.faces[x],p=s.angle(t.normal,l.normal);if(p!==p||p*(180/J)<=o)b&&a[u][q].push(x),n[0]+=t.normal[0],n[1]+=t.normal[1],n[2]+=t.normal[2],i++}n[0]/=i;n[1]/=i;n[2]/=i;this.faces[u].point_normals[q]=s.normalize(n)}}return this};L.prototype.recalcNormals=function(a){this.calcFaceNormals();for(var b=0,c=this.faces.length;b<c;b++)for(var d=this.faces[b],
e=0,f=d.points.length;e<f;e++){var m=a[b][e],g=d.point_normals[e];g[0]=d.normal[0];g[1]=d.normal[1];g[2]=d.normal[2];for(var h=m.length,u=0;u<h;u++){var q=this.faces[m[u]];g[0]+=q.normal[0];g[1]+=q.normal[1];g[2]+=q.normal[2]}h!=0&&(g[0]/=h+1,g[1]/=h+1,g[2]/=h+1,m=p.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),g[0]/=m,g[1]/=m,g[2]/=m)}return this};L.prototype.prepare=function(a){a===h&&(a=!0);this.triangulateQuads().compile();a&&this.clean();return this};L.prototype.clean=function(){var a,b;a=0;for(b=this.points.length;a<
b;a++)delete this.points[a],this.points[a]=null;this.points=[];a=0;for(b=this.faces.length;a<b;a++)delete this.faces[a].points,delete this.faces[a].point_normals,delete this.faces[a].uvs,delete this.faces[a].normal,delete this.faces[a],this.faces[a]=null;this.faces=[];return this};L.prototype.compileMap=function(a){a===h&&(a=1.0E-5);var b={segments:[],bounds:[]},c=[],d,e,f,m,g,i,u,q;this.materials.length||this.materials.push(new ga);d=0;for(i=this.materials.length;d<i;d++)c[d]=[];d=0;for(i=this.faces.length;d<
i;d++)if(this.faces[d].points.length===3)f=this.faces[d].material,m=this.faces[d].segment,c[f][m]===h&&(c[f][m]=[],b.segments.push(m)),c[f][m].push(d);var o=[],l=0,n=!1,x=!1,t=!1,p;d=0;for(i=c.length;d<i;d++)for(e in c[d])if(c[d].hasOwnProperty(e))for(f=0;f<c[d][e].length;f++)p=c[d][e][f],n=n||this.faces[p].uvs.length!==0,x=x||this.faces[p].point_normals.length!==0,t=t||this.faces[p].point_colors.length!==0;if(n)for(d=0;d<this.faces.length;d++)if(!this.faces[d].uvs.length)for(e=0;e<this.faces[d].points.length;e++)this.faces[d].uvs.push([0,
0]);if(x)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_normals.length)for(e=0;e<this.faces[d].points.length;e++)this.faces[d].point_normals.push([0,0,0]);if(t)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_colors.length)for(e=0;e<this.faces[d].points.length;e++)this.faces[d].point_colors.push([0,0,0]);d=0;for(i=c.length;d<i;d++)for(e in c[d])if(c[d].hasOwnProperty(e)){f=0;for(u=c[d][e].length;f<u;f++){p=c[d][e][f];for(m=0;m<3;m++){var y=this.faces[p].points[m],w=-1;if(o[y]!==h){g=
0;for(q=o[y].length;g<q;g++){var v=o[y][g][0],K=o[y][g][1],w=o[y][g][2];x&&(w=s.equal(this.faces[v].point_normals[K],this.faces[p].point_normals[m],a)?w:-1);n&&(w=pb.equal(this.faces[v].uvs[K],this.faces[p].uvs[m],a)?w:-1);t&&(w=s.equal(this.faces[v].point_colors[K],this.faces[p].point_colors[m],a)?w:-1)}}if(w!==-1){if(b.elements===h)b.elements=[];b.elements[d]===h&&(b.elements[d]=[]);b.elements[d][e]===h&&(b.elements[d][e]=[]);b.elements[d][e].push(w)}else{if(b.points===h)b.points=[];b.points.push(y);
b.bounds.length===0?(b.bounds[0]=[this.points[y][0],this.points[y][1],this.points[y][2]],b.bounds[1]=[this.points[y][0],this.points[y][1],this.points[y][2]]):(this.points[y][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[y][0]),this.points[y][1]<b.bounds[0][1]&&(b.bounds[0][1]=this.points[y][1]),this.points[y][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[y][2]),this.points[y][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[y][0]),this.points[y][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[y][1]),
this.points[y][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[y][2]));if(x){if(b.normals===h)b.normals=[];b.normals.push([p,m])}if(t){if(b.colors===h)b.colors=[];b.colors.push([p,m])}if(n){if(b.uvs===h)b.uvs=[];b.uvs.push([p,m])}if(b.elements===h)b.elements=[];b.elements[d]===h&&(b.elements[d]=[]);b.elements[d][e]===h&&(b.elements[d][e]=[]);b.elements[d][e].push(l);o[y]===h&&(o[y]=[]);o[y].push([p,m,l]);l++}}}}return b};L.prototype.compileVBO=function(a,b,c,d,e,f){typeof b=="object"?(b=b.element!==
h?b.element:!0,c=b.vertex!==h?b.vertex:!0,f=b.color!==h?b.color:!0,d=b.normal!==h?b.normal:!0,e=b.uv!==h?b.uv:!0):(b===h&&(b=!0),c===h&&(c=!0),f===h&&(f=!0),d===h&&(d=!0),e===h&&(e=!0));var m={};if(a.points&&c){var g=a.points.length;m.vbo_points=new Float32Array(g*3);for(var i=0,c=0;c<g;c++){var u=a.points[c];m.vbo_points[i++]=this.points[u][0];m.vbo_points[i++]=this.points[u][1];m.vbo_points[i++]=this.points[u][2]}}if(a.normals&&d){g=a.normals.length;m.vbo_normals=new Float32Array(g*3);for(c=i=0;c<
g;c++)u=a.normals[c],m.vbo_normals[i++]=this.faces[u[0]].point_normals[u[1]][0],m.vbo_normals[i++]=this.faces[u[0]].point_normals[u[1]][1],m.vbo_normals[i++]=this.faces[u[0]].point_normals[u[1]][2]}if(a.colors&&f){g=a.colors.length;m.vbo_colors=new Float32Array(g*3);for(c=i=0;c<g;c++)u=a.colors[c],m.vbo_colors[i++]=this.faces[u[0]].point_colors[u[1]][0],m.vbo_colors[i++]=this.faces[u[0]].point_colors[u[1]][1],m.vbo_colors[i++]=this.faces[u[0]].point_colors[u[1]][2]}if(a.uvs&&e){g=a.uvs.length;m.vbo_uvs=
new Float32Array(g*2);for(c=i=0;c<g;c++)u=a.uvs[c],m.vbo_uvs[i++]=this.faces[u[0]].uvs[u[1]][0],m.vbo_uvs[i++]=this.faces[u[0]].uvs[u[1]][1]}if(b){m.elements_ref=[];m.vbo_elements=[];c=0;for(g=a.elements.length;c<g;c++)for(j in m.elements_ref[c]=[],b=0,a.elements[c])if(a.elements[c].hasOwnProperty(j)){d=a.elements[c][j];k=0;for(kMax=d.length;k<kMax;k++)m.vbo_elements.push(d[k]);m.elements_ref[c][b]=[parseInt(j),parseInt(d.length)];b++}m.vbo_elements=new Uint16Array(m.vbo_elements)}m.segments=a.segments;
m.bounds=a.bounds;return m};L.prototype.bufferVBO=function(a,b){var c=l.gl,d={};b===h&&(b={});d.gl_points=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,d.gl_points);c.bufferData(c.ARRAY_BUFFER,a.vbo_points,c.STATIC_DRAW);a.vbo_normals?(d.gl_normals=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d.gl_normals),c.bufferData(c.ARRAY_BUFFER,a.vbo_normals,c.STATIC_DRAW)):d.gl_normals=b.gl_normals?b.gl_normals:null;a.vbo_uvs?(d.gl_uvs=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d.gl_uvs),c.bufferData(c.ARRAY_BUFFER,
a.vbo_uvs,c.STATIC_DRAW)):d.gl_uvs=b.gl_uvs?b.gl_uvs:null;a.vbo_colors?(d.gl_colors=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,d.gl_colors),c.bufferData(c.ARRAY_BUFFER,a.vbo_colors,c.STATIC_DRAW)):d.gl_colors=b.gl_colors?b.gl_colors:null;!a.vbo_elements&&b.gl_elements?(d.gl_elements=b.gl_elements,d.elements_ref=b.elements_ref):(d.gl_elements=c.createBuffer(),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,d.gl_elements),c.bufferData(c.ELEMENT_ARRAY_BUFFER,a.vbo_elements,c.STATIC_DRAW),d.elements_ref=a.elements_ref);
d.segments=a.segments;d.bounds=a.bounds;b.elements_ref&&!a.elements_ref&&c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return d};L.prototype.bindBuffer=function(a){if(this.originBuffer===null)this.originBuffer=a;this.compiled=a;this.segment_state=[];for(var b=0,c=a.segments.length;b<c;b++)this.segment_state[a.segments[b]]=!0;this.bb=a.bounds};L.prototype.compile=function(a){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(a))));return this};L.prototype.addMorphTarget=function(a){if(this.morphTargets===
null)this.morphTargets=[];this.morphTargets.push(a)};L.prototype.setMorphSource=function(a){if(this.morphSourceIndex!==a)this.morphSourceIndex=a,this.bindBuffer(this.morphTargets[a])};L.prototype.setMorphTarget=function(a){if(this.morphTargetIndex!==a)this.morphTargetIndex=a,this.morphTarget=this.morphTargets[a]};L.prototype.setMorphWeight=function(a){this.morphWeight=a};L.prototype.morphTargetCount=function(){return this.morphTargets!==null?this.morphTargets.length:0};$.prototype.setRotation=function(a){this.rotation=
a};$.prototype.setScale=function(a){this.scale=a};$.prototype.setCenter=function(a){this.center=a};$.prototype.setProjectionAxis=function(a){this.projection_axis=a};$.prototype.setProjectionMode=function(a){this.projection_mode=a};$.prototype.setWrapW=function(a){this.wrap_w_count=a};$.prototype.setWrapH=function(a){this.wrap_h_count=a};var $a=function(a,b,c){return a===0&&c===0?0:c===0?a<0?N:-N:c<0?-p.atan(a/c)+J:-p.atan(a/c)},ra=function(a,b,c){var d;a===0&&c===0?(d=0,a=b!==0?b<0?-N:N:0):(d=c===
0?a<0?N:-N:c<0?-p.atan(a/c)+J:-p.atan(a/c),a=p.sqrt(a*a+c*c),a=a===0?b<0?-N:N:p.atan(b/a));return[d,a]};$.prototype.apply=function(a,b,c){var d,e,f,m,r,i=new R,u=!1,q=null;if(this.center[0]||this.center[1]||this.center[2])i.translate(-this.center[0],-this.center[1],-this.center[2]),u=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&i.rotate(this.rotation[2],0,0,1),this.rotation[1]&&i.rotate(this.rotation[1],0,1,0),this.rotation[2]&&i.rotate(this.rotation[0],1,0,0),u=!0;
u&&(q=i.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));for(var i=0,o=a.faces.length;i<o;i++)if(a.faces[i].material===b&&!(c!==h&&a.faces[i].segment!==c)){var l,n,x;if(this.projection_mode===g.uv.projection.CUBIC||this.projection_mode===g.uv.projection.SKY)l=p.abs(a.faces[i].normal[0]),n=p.abs(a.faces[i].normal[1]),x=p.abs(a.faces[i].normal[2]);for(var t=[],s=0,y=a.faces[i].points.length;s<y;s++){e=a.faces[i].points[s];var w=a.faces[i].points[(s+1)%3],v=a.faces[i].points[(s+2)%3];d=a.points[e];
var K=a.points[w],B=a.points[v];u&&(d=A.vec3_multiply(d,q));var F=this.projection_mode;if(F===g.uv.projection.SKY)e=a.sky_mapping,l>=n&&l>=x&&(f=d[2]/this.scale[2]+this.scale[2]/2,m=-d[1]/this.scale[1]+this.scale[1]/2,a.faces[i].normal[0]<0?(f=(e[2][2]-e[2][0])*(1-f),m=1-(e[2][3]-e[2][1])*m,f+=e[2][0],m+=e[2][1]):(f*=e[3][2]-e[3][0],m=1-(e[3][3]-e[3][1])*m,f+=e[3][0],m+=e[3][1])),n>=l&&n>=x&&(f=d[0]/this.scale[0]+this.scale[0]/2,m=-d[2]/this.scale[2]+this.scale[2]/2,a.faces[i].normal[1]<0?(f*=e[1][2]-
e[1][0],m=1-(e[1][3]-e[1][1])*m,f+=e[1][0],m-=e[1][1]):(f*=e[0][2]-e[0][0],m=1-(e[0][3]-e[0][1])*m,f+=e[0][0],m-=e[0][1])),x>=l&&x>=n&&(f=d[0]/this.scale[0]+this.scale[0]/2,m=d[1]/this.scale[1]+this.scale[1]/2,a.faces[i].normal[2]<0?(f*=e[4][2]-e[4][0],m=1-(e[4][3]-e[4][1])*(1-m),f+=e[4][0],m-=e[4][1]):(f=(e[5][2]-e[5][0])*(1-f),m=1-(e[5][3]-e[5][1])*(1-m),f+=e[5][0],m+=e[5][1])),a.faces[i].setUV([f,m],s);else if(F===g.uv.projection.CUBIC)l>=n&&l>=x&&(f=d[2]/this.scale[2]+0.5,m=d[1]/this.scale[1]+
0.5),n>=l&&n>=x&&(f=-d[0]/this.scale[0]+0.5,m=d[2]/this.scale[2]+0.5),x>=l&&x>=n&&(f=-d[0]/this.scale[0]+0.5,m=d[1]/this.scale[1]+0.5),a.faces[i].normal[0]>0&&(f=-f),a.faces[i].normal[1]<0&&(f=-f),a.faces[i].normal[2]>0&&(f=-f),a.faces[i].setUV([f,m],s);else if(F===g.uv.projection.PLANAR)f=this.projection_axis===g.uv.axis.X?d[2]/this.scale[2]+0.5:-d[0]/this.scale[0]+0.5,m=this.projection_axis===g.uv.axis.Y?d[2]/this.scale[2]+0.5:d[1]/this.scale[1]+0.5,a.faces[i].setUV([f,m],s);else{if(F===g.uv.projection.CYLINDRICAL)F=
this.projection_axis,F===g.uv.axis.X?(r=$a(d[2],d[0],-d[1]),m=-d[0]/this.scale[0]+0.5):F===g.uv.axis.Y?(r=$a(-d[0],d[1],d[2]),m=-d[1]/this.scale[1]+0.5):F===g.uv.axis.Z&&(r=$a(-d[0],d[2],-d[1]),m=-d[2]/this.scale[2]+0.5),r=1-r/pa,this.wrap_w_count!==1&&(r*=this.wrap_w_count),d=r,e=m;else if(F===g.uv.projection.SPHERICAL){var z,D,C,F=this.projection_axis;F===g.uv.axis.X?(z=t[e]?t[e]:ra(d[2],d[0],-d[1]),t[e]||(t[e]=z),D=t[w]?t[w]:ra(K[2],K[0],-K[1]),t[w]||(t[w]=D),C=t[v]?t[v]:ra(B[2],B[0],-B[1]),t[v]||
(t[v]=C)):F===g.uv.axis.Y?(z=t[e]?t[e]:ra(d[0],-d[1],d[2]),t[e]||(t[e]=z),D=t[w]?t[w]:ra(K[0],-K[1],K[2]),t[w]||(t[w]=D),C=t[v]?t[v]:ra(B[0],-B[1],B[2]),t[v]||(t[v]=C)):F===g.uv.axis.Z&&(z=t[e]?t[e]:ra(-d[0],d[2],-d[1]),t[e]||(t[e]=z),D=t[w]?t[w]:ra(-K[0],K[2],-K[1]),t[w]||(t[w]=D),C=t[v]?t[v]:ra(-B[0],B[2],-B[1]),t[v]||(t[v]=C));p.abs(z[0]-D[0])>N&&p.abs(z[0]-C[0])>N&&(z[0]>D[0]&&z[0]>C[0]?z[0]-=pa:z[0]+=pa);p.abs(z[1]-D[1])>N&&p.abs(z[1]-C[1])>N&&(z[1]>D[1]&&z[1]>C[1]?z[1]-=pa:z[1]+=pa);r=1-z[0]/
pa;e=0.5-z[1]/J;this.wrap_w_count!==1&&(r*=this.wrap_w_count);this.wrap_h_count!==1&&(e*=this.wrap_h_count);d=r}else e=d=0;a.faces[i].setUV([d,e],s)}}}return this};G.prototype.setType=function(){this.light_type=type};G.prototype.setMethod=function(a){this.method=a};G.prototype.setDiffuse=function(a){this.diffuse=a};G.prototype.setSpecular=function(a){this.specular=a};G.prototype.setIntensity=function(a){this.intensity=a};G.prototype.setPosition=function(a){this.position=a};G.prototype.setDistance=
function(a){this.distance=a};G.prototype.setCutoff=function(a){this.cutoff=a};G.prototype.prepare=function(a){var b=this.light_type;if(b===g.light.type.DIRECTIONAL)this.lDir=Ma.vec3_multiply(this.direction,a.nMatrix);else if(b===g.light.type.SPOT||b===g.light.type.SPOT_SHADOW)this.lDir=Ma.vec3_multiply(this.direction,a.nMatrix),this.lPos=A.vec3_multiply(this.position,a.mvMatrix);else if(b===g.light.type.POINT)this.lPos=A.vec3_multiply(this.position,a.mvMatrix);else if(b===g.light.type.AREA)this.lDir=
Ma.vec3_multiply(this.direction,a.nMatrix)};G.prototype.control=function(a,b,c){if(a===g.motion.POS)this.position[b]=c;else if(a===g.motion.INTENSITY)this.intensity=c};G.prototype.doTransform=function(a){if(!s.equal(this.lposition,this.position)||a!==h)this.trans.clearStack(),this.trans.translate(this.position),a!==h&&this.trans.pushMatrix(a),this.tMatrix=this.trans.getResult(),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.dirty=!0,this.adjust_octree()};
G.prototype.getAABB=function(){var a=[[0,0,0],[0,0,0]];Ea(a,[this.distance,this.distance,this.distance]);Ea(a,[-this.distance,-this.distance,-this.distance]);a[0]=s.add(a[0],this.position);a[1]=s.add(a[1],this.position);return this.aabb=a};G.prototype.setDirection=function(a,b,c){if(typeof a==="object")this.setDirection(a[0],a[1],a[2]);else return this.direction=s.normalize([a,b,c]),this};G.prototype.lookat=function(a,b,c){if(typeof a==="object")this.lookat(a[0],a[1],a[2]);else return this.direction=
s.normalize(s.subtract([a,b,c],this.position)),this};G.prototype.setRotation=function(a,b,c){if(typeof a==="object")this.setRotation(a[0],a[1],a[2]);else{var d=new R;d.rotate([-a,-b,-c]);d.pushMatrix();this.direction=s.normalize(A.vec3_multiply([1,0,0],d.getResult()));this.rotation=[a,b,c];return this}};G.prototype.setupShader=function(a,b){var c=l.gl;c.uniform3fv(a.lDiff[b],this.diffuse);c.uniform3fv(a.lSpec[b],this.specular);this.lPos&&c.uniform3fv(a.lPos[b],this.lPos);this.lDir&&c.uniform3fv(a.lDir[b],
this.lDir);c.uniform1f(a.lInt[b],this.intensity);c.uniform1f(a.lDist[b],this.distance);(this.light_type===g.light.type.SPOT_SHADOW||this.light_type===g.light.type.SPOT)&&c.uniform1f(a.lCut[b],this.cutoff);if(this.light_type===g.light.type.SPOT_SHADOW||this.light_type===g.light.type.AREA)this.shadowMapTex.texture.use(l.gl.TEXTURE0+b),c.uniform1i(a.lDepthTex[b],b),c.uniform3fv(a.lDepth[b],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),c.uniformMatrix4fv(a.spMatrix[b],!1,this.spMatrix)};
G.prototype.setShadow=function(a){this.map_res=a;this.shadowMapTex=new W(this.map_res,this.map_res,!0);this.shadowMapTex.texture.setFilter(g.texture.filter.NEAREST);this.dummyCam=new S(this.map_res,this.map_res,80,0.1,this.distance);this.dummyCam.calc_nmatrix=!1;this.dummyCam.setTargeted(!0);this.has_shadow=!0};G.prototype.hasShadow=function(){return has_shadow};G.prototype.shadowBegin=function(){var a=l.gl;this.shadowMapTex.use();a.viewport(0,0,this.map_res,this.map_res);a.clear(a.DEPTH_BUFFER_BIT|
a.COLOR_BUFFER_BIT);this.light_type!==g.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);a.cullFace(a.FRONT)};G.prototype.shadowEnd=function(){var a=l.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.cullFace(a.BACK);this.setupTexGen()};G.prototype.setupTexGen=
function(){this.spMatrix=A.multiply([0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1],oa);this.spMatrix=A.multiply(this.dummyCam.pMatrix,this.spMatrix);this.spMatrix=A.multiply(this.dummyCam.mvMatrix,this.spMatrix)};G.prototype.setAreaAxis=function(a){this.areaAxis=a};G.prototype.updateAreaLight=function(){var a=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var b=0,b=p.tan(this.areaCam.fov/2*(J/180)),c=s.subtract(this.areaCam.target,this.areaCam.position);c[1]=0;
c=s.normalize(c);s.normalize(s.cross(c,[0,1,0]));var d=-p.atan2(c[2],c[0]),b=this.distance/2*p.abs(b)-this.distance/2;b<this.distance/3/2&&(b=this.distance/3/2);var c=s.multiply(c,b),b=this.areaAxis[1]*(J/180),e=p.tan(this.areaAxis[0]*(J/180)),b=[p.tan(b),0,e];d-=p.atan2(b[0],b[2]);this.position=s.add(s.add(this.areaCam.position,c),s.multiply(b,a));this.position[1]=this.areaCeiling;this.target=s.add(s.add(this.areaCam.position,c),s.multiply(b,-a));this.target[1]=this.areaFloor;this.direction=s.normalize(s.subtract(this.target,
this.position));this.dummyCam.rotation[2]=d*(180/J);c=this.dummyCam.nearclip;a=this.dummyCam.farclip*p.abs(this.direction[1])*a;c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);c[0][1]<this.areaCeiling&&(c=this.areaCeiling-c[0][1],p.abs(this.direction[1]));c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);c[1][1]>this.areaFloor&&(c=c[1][1]-
this.areaFloor,a+=c/p.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=a;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)};G.prototype.orthoBounds=function(a,b,c,d,e,f){var d=s.normalize([e[0],e[4],e[8]]),g=s.normalize([e[1],e[5],e[9]]),e=s.normalize(s.cross(g,d)),h;h=c/2;c=[];b=s.multiply(d,b/2);d=s.multiply(g,h);f=s.multiply(e,f);c[0]=s.add(s.subtract(a,b),s.add(d,f));c[1]=s.add(s.add(a,b),s.add(d,f));c[2]=s.subtract(s.subtract(a,
b),s.add(d,f));c[3]=s.subtract(s.add(a,b),s.add(d,f));aabb1=c[0];aabb2=c[0];for(a=1;a<4;a++)aabb1[0]>c[a][0]&&(aabb1[0]=c[a][0]),aabb1[1]>c[a][1]&&(aabb1[1]=c[a][1]),aabb1[2]>c[a][2]&&(aabb1[2]=c[a][2]),aabb2[0]<c[a][0]&&(aabb2[0]=c[a][0]),aabb2[1]<c[a][1]&&(aabb2[1]=c[a][1]),aabb2[2]<c[a][2]&&(aabb2[2]=c[a][2]);return[aabb1,aabb2]};var Ja=new G(g.light.type.POINT);Ja.diffuse=[0,0,0];Ja.specular=[0,0,0];Ja.distance=0;Ja.intensity=0;Ja.cutoff=0;E.prototype.bindSelf=function(a){var b,c,d;a.indexOf(".")!==
-1?a.indexOf("[")!==-1?(b=a.split("["),d=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[d]===h&&(this[d]=[]),this[d][c]===h&&(this[d][c]={}),this[d][c][b]=this.uniforms[a]):(b=a.split("."),d=b[0],b=b[1],this[d]===h&&(this[d]={}),this[d][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),d=b[0],b=b[1].split("]"),c=b[0],this[d]===h&&(this[d]=[]),this[d][c]=this.uniforms[a]):this[a]=this.uniforms[a]};E.prototype.addMatrix=function(a,b){this.use();this.uniforms[a]=l.gl.getUniformLocation(this.shader,
a);this.uniform_type[a]=g.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==h&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]};E.prototype.addVector=function(a,b){this.use();this.uniforms[a]=l.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==h&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]};E.prototype.addFloat=function(a,
b){this.use();this.uniforms[a]=l.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==h&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]};E.prototype.addVertexArray=function(a){this.use();this.uniforms[a]=l.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]};
E.prototype.addUVArray=function(a){this.use();this.uniforms[a]=l.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]};E.prototype.addFloatArray=function(a){this.use();this.uniforms[a]=l.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]};
E.prototype.addInt=function(a,b){this.use();this.uniforms[a]=l.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=g.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==h&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]};E.prototype.use=function(){l.gl.useProgram(this.shader)};E.prototype.setMatrix=function(a,b){var c=this.uniforms[a];if(c!==null){var d=b.length;d===16?l.gl.uniformMatrix4fv(c,!1,b):d===9?l.gl.uniformMatrix3fv(c,!1,b):d===4&&l.gl.uniformMatrix2fv(c,
!1,b)}};E.prototype.setInt=function(a,b){var c=this.uniforms[a];c!==null&&l.gl.uniform1i(c,b)};E.prototype.setFloat=function(a,b){var c=this.uniforms[a];c!==null&&l.gl.uniform1f(c,b)};E.prototype.setVector=function(a,b){var c=this.uniforms[a];if(c!==null){var d=b.length;d==3?l.gl.uniform3fv(c,b):d==2?l.gl.uniform2fv(c,b):l.gl.uniform4fv(c,b)}};E.prototype.clearArray=function(a){a=this.uniforms[a];a!==null&&l.gl.disableVertexAttribArray(a)};E.prototype.bindArray=function(a,b){var c=l.gl,d=this.uniforms[a];
if(d!==null){var e=this.uniform_type[a];e===g.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(d,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(d)):e===g.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(d,2,c.FLOAT,!1,0,0)):e===g.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(d,1,c.FLOAT,!1,0,0))}};var ga=function(a){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;typeof a==="object"?
(this.diffuse=a.diffuse===h?[1,1,1]:a.diffuse,this.specular=a.specular===h?[0.1,0.1,0.1]:a.specular,this.color=a.color===h?[1,1,1]:a.color,this.ambient=a.ambient===h?[0,0,0]:a.ambient,this.opacity=a.opacity===h?1:a.opacity,this.shininess=a.shininess===h?1:a.shininess,this.max_smooth=a.max_smooth===h?60:a.max_smooth,this.env_amount=a.env_amount===h?0.75:a.env_amount,this.morph=a.morph===h?!1:a.morph,this.color_map=a.colorMap===h?!1:a.colorMap,this.name=a.name===h?h:a.name,typeof a.textures==="object"&&
(a.textures.color!==h&&this.setTexture(a.textures.color,g.texture.map.COLOR),a.textures.envsphere!==h&&this.setTexture(a.textures.envsphere,g.texture.map.ENVSPHERE),a.textures.normal!==h&&this.setTexture(a.textures.normal,g.texture.map.NORMAL),a.textures.bump!==h&&this.setTexture(a.textures.bump,g.texture.map.BUMP),a.textures.reflect!==h&&this.setTexture(a.textures.reflect,g.texture.map.REFLECT),a.textures.specular!==h&&this.setTexture(a.textures.specular,g.texture.map.SPECULAR),a.textures.ambient!==
h&&this.setTexture(a.textures.ambient,g.texture.map.AMBIENT),a.textures.alpha!==h&&this.setTexture(a.textures.alpha,g.texture.map.ALPHA))):(this.diffuse=[1,1,1],this.specular=[0.1,0.1,0.1],this.color=[1,1,1],this.ambient=[0,0,0],this.shininess=this.opacity=1,this.max_smooth=60,this.name=a,this.color_map=this.morph=!1)};ga.prototype.setTexture=function(a,b){b===h&&(b=0);this.textures[b]=a};ga.prototype.calcShaderMask=function(){var a=0;a+=typeof this.textures[g.texture.map.COLOR]==="object"?g.shader.map.COLOR:
0;a+=typeof this.textures[g.texture.map.SPECULAR]==="object"?g.shader.map.SPECULAR:0;a+=typeof this.textures[g.texture.map.NORMAL]==="object"?g.shader.map.NORMAL:0;a+=typeof this.textures[g.texture.map.BUMP]==="object"?g.shader.map.BUMP:0;a+=typeof this.textures[g.texture.map.REFLECT]==="object"?g.shader.map.REFLECT:0;a+=typeof this.textures[g.texture.map.ENVSPHERE]==="object"?g.shader.map.ENVSPHERE:0;a+=typeof this.textures[g.texture.map.AMBIENT]==="object"?g.shader.map.AMBIENT:0;a+=typeof this.textures[g.texture.map.ALPHA]===
"object"?g.shader.map.ALPHA:0;a+=this.opacity!==1?g.shader.map.ALPHA:0;return a};ga.prototype.getShaderHeader=function(a,b){return(b!==h?"#define loopCount "+b+"\n":"")+"#define hasColorMap "+(typeof this.textures[g.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[g.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+(typeof this.textures[g.texture.map.NORMAL]==="object"?1:0)+"\n#define hasBumpMap "+(typeof this.textures[g.texture.map.BUMP]==="object"?
1:0)+"\n#define hasReflectMap "+(typeof this.textures[g.texture.map.REFLECT]==="object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[g.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+(typeof this.textures[g.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[g.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+(this.opacity!==1?1:0)+"\n#define lightPoint "+(a===g.light.type.POINT?1:0)+"\n#define lightDirectional "+(a===g.light.type.DIRECTIONAL?
1:0)+"\n#define lightSpot "+(a===g.light.type.SPOT||a===g.light.type.SPOT_SHADOW?1:0)+"\n#define hasShadow "+(a===g.light.type.SPOT_SHADOW||a===g.light.type.AREA?1:0)+"\n#define softShadow "+(l.soft_shadow?1:0)+"\n#define lightArea "+(a===g.light.type.AREA?1:0)+"\n#define depthPack "+(a===g.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(l.depth_alpha?1:0)+"\n#define hasMorph "+(this.morph?1:0)+"\n#define hasVertexColorMap "+(this.color_map?1:0)+"\n\n"};ga.prototype.bindObject=function(a,b){var c=
l.gl,d=b.aVertexPosition,e=b.aTextureCoord,f=b.aNormal,g=b.aColor;c.bindBuffer(c.ARRAY_BUFFER,a.compiled.gl_points);c.vertexAttribPointer(d,3,c.FLOAT,!1,0,0);c.enableVertexAttribArray(d);e!==null&&a.compiled.gl_uvs!==null&&e!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,a.compiled.gl_uvs),c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e));f!==null&&a.compiled.gl_normals!==null&&f!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,a.compiled.gl_normals),c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(f));
g!==null&&a.compiled.gl_colors!==null&&g!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,a.compiled.gl_colors),c.vertexAttribPointer(g,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(g));if(a.morphTarget)d=b.amVertexPosition,f=b.amNormal,c.bindBuffer(c.ARRAY_BUFFER,a.morphTarget.gl_points),c.vertexAttribPointer(d,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(d),f!==null&&a.morphTarget.gl_normals!==null&&f!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,a.morphTarget.gl_normals),c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(f)),
c.uniform1f(b.morphWeight,a.morphWeight);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)};ga.prototype.clearObject=function(a,b){var c=l.gl,d=b.aTextureCoord,e=b.aNormal,f=b.aColor;d!==null&&a.compiled.gl_uvs!==null&&d!==-1&&c.disableVertexAttribArray(d);e!==null&&a.compiled.gl_normals!==null&&e!==-1&&c.disableVertexAttribArray(e);f!=null&&a.compiled.gl_colors!==null&&f!==-1&&c.disableVertexAttribArray(f);if(a.morphTarget)up=b.amVertexPosition,c.disableVertexAttribArray(up),e=b.amNormal,
e!=null&&a.compiled.gl_normals!==null&&e!==-1&&c.disableVertexAttribArray(e)};ga.prototype.use=function(a,b){b===h&&(b=0);if(this.customShader!==null)this.customShader.use();else{a===h&&(a=0);var c,d=this.textures;this.shader[a]===h&&(this.shader[a]=[]);if(this.shader[a][b]===h){var e=this.calcShaderMask(a);za[a][e]===h&&(za[a][e]=[]);if(za[a][e][b]===h){c=this.getShaderHeader(a,b);var f=new E(c+l.CoreShader_vs,c+l.CoreShader_fs);za[a][e][b]=f;c=0;if(a!==g.light.type.DEPTH_PACK){if(a===g.light.type.SPOT_SHADOW||
a===g.light.type.AREA)c+=b;typeof d[g.texture.map.COLOR]==="object"&&f.addInt("colorMap",c++);typeof d[g.texture.map.ENVSPHERE]==="object"&&f.addInt("envSphereMap",c++);typeof d[g.texture.map.NORMAL]==="object"&&f.addInt("normalMap",c++);typeof d[g.texture.map.BUMP]==="object"&&f.addInt("bumpMap",c++);typeof d[g.texture.map.REFLECT]==="object"&&f.addInt("reflectMap",c++);typeof d[g.texture.map.SPECULAR]==="object"&&f.addInt("specularMap",c++);typeof d[g.texture.map.AMBIENT]==="object"&&f.addInt("ambientMap",
c++)}typeof d[g.texture.map.ALPHA]==="object"&&f.addInt("alphaMap",c++);f.addMatrix("uMVMatrix");f.addMatrix("uPMatrix");f.addMatrix("uOMatrix");f.addMatrix("uNMatrix");f.addVertexArray("aVertexPosition");f.addVertexArray("aNormal");this.color_map&&f.addVertexArray("aColor");this.morph&&(f.addVertexArray("amVertexPosition"),f.addVertexArray("amNormal"),f.addFloat("morphWeight",0));for(c=0;c<b;c++)if(f.addVector("lDiff["+c+"]"),f.addVector("lSpec["+c+"]"),f.addFloat("lInt["+c+"]"),f.addFloat("lDist["+
c+"]"),f.addVector("lPos["+c+"]"),f.addVector("lDir["+c+"]"),(a===g.light.type.SPOT_SHADOW||a===g.light.type.SPOT)&&f.addFloat("lCut["+c+"]"),a===g.light.type.SPOT_SHADOW||a===g.light.type.AREA)f.addInt("lDepthTex["+c+"]"),f.addVector("lDepth["+c+"]"),f.addMatrix("spMatrix["+c+"]");a!==g.light.type.DEPTH_PACK&&(f.addVector("lAmb"),f.addVector("mDiff"),f.addVector("mColor"),f.addVector("mAmb"),f.addVector("mSpec"),f.addFloat("mShine"),f.addFloat("envAmount"));f.addFloat("mAlpha");(l.depth_alpha||a===
g.light.type.DEPTH_PACK||a===g.light.type.SPOT_SHADOW||a===g.light.type.AREA)&&f.addVector("depthInfo");f.addUVArray("aTextureCoord")}this.shader[a][b]=za[a][e][b]}e=this.shader[a][b];f=l.gl;e.use();c=0;var m;if(a!==g.light.type.DEPTH_PACK){if(a===g.light.type.SPOT_SHADOW||a===g.light.type.AREA)c+=b;if(m=d[g.texture.map.COLOR])m.use(l.gl.TEXTURE0+c),c++;if(m=d[g.texture.map.ENVSPHERE])m.use(l.gl.TEXTURE0+c),c++,f.uniform1f(e.envAmount,this.env_amount);if(m=d[g.texture.map.NORMAL])m.use(l.gl.TEXTURE0+
c),c++;if(m=d[g.texture.map.BUMP])m.use(l.gl.TEXTURE0+c),c++;if(m=d[g.texture.map.REFLECT])m.use(l.gl.TEXTURE0+c),c++;if(m=d[g.texture.map.SPECULAR])m.use(l.gl.TEXTURE0+c),c++;if(m=d[g.texture.map.AMBIENT])m.use(l.gl.TEXTURE0+c),c++}(m=d[g.texture.map.ALPHA])&&m.use(l.gl.TEXTURE0+c);a!==g.light.type.DEPTH_PACK?(f.uniform3fv(e.mColor,this.color),f.uniform3fv(e.mDiff,this.diffuse),f.uniform3fv(e.mAmb,this.ambient),f.uniform3fv(e.mSpec,this.specular),f.uniform1f(e.mShine,this.shininess*128),f.uniform3fv(e.lAmb,
w.globalAmbient),(l.depth_alpha||a===g.light.type.SPOT_SHADOW||a===g.light.type.AREA)&&f.uniform3fv(e.depthInfo,[l.depth_alpha_near,l.depth_alpha_far,0])):f.uniform3fv(e.depthInfo,[l.shadow_near,l.shadow_far,0]);this.opacity!==1&&f.uniform1f(e.mAlpha,this.opacity)}};ma=function(a,b){this.img_path=a;this.filter_type=b};ma.prototype.getTexture=function(a,b){return new Z(this.img_path,this.filter_type,a,b)};var Z=function(a,b,c,d,e){var f=l.gl;this.tex_id=ka.length;this.filterType=-1;this.onready=e;
this.loaded=!1;ka[this.tex_id]=f.createTexture();Y[this.tex_id]=this;if(a)typeof a==="string"?qa[this.tex_id]=new Image:typeof a==="object"&&a.nodeName==="IMG"&&(qa[this.tex_id]=a),U[a]=this.tex_id;f.bindTexture(f.TEXTURE_2D,ka[this.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR);if(a){var m=this.tex_id,r=b!==h?b:l.default_filter,i=this;qa[this.tex_id].onload=function(){f.bindTexture(f.TEXTURE_2D,ka[m]);f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,
!0);f.pixelStorei(f.UNPACK_COLORSPACE_CONVERSION_WEBGL,f.NONE);var a=qa[m];f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,a);var b=a.width,a=a.height,c=!0;if(b===1||a===1)c=!1;else{if(b!==1)for(;b%2===0;)b/=2;if(a!==1)for(;a%2===0;)a/=2;b>1&&(c=!1);a>1&&(c=!1)}c||(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE));if(Y[m].filterType===-1){if(!c&&r===g.texture.filter.LINEAR_MIP)r=g.texture.filter.LINEAR;Y[m].filterType===
-1&&Y[m].setFilter(r)}else Y[m].setFilter(Y[m].filterType);f.bindTexture(f.TEXTURE_2D,null);if(i.onready)i.onready();i.loaded=!0};if(c)qa[this.tex_id].deferredSrc=a,c.addImage(d,a,qa[this.tex_id]);else if(typeof a==="string")qa[this.tex_id].src=a}this.active_unit=-1};Z.prototype.setFilter=function(a){var b=w.GLCore.gl;b.bindTexture(b.TEXTURE_2D,ka[this.tex_id]);a===g.texture.filter.LINEAR?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,
b.LINEAR)):a===g.texture.filter.LINEAR_MIP?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.generateMipmap(b.TEXTURE_2D)):a===g.texture.filter.NEAREST?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST)):a===g.texture.filter.NEAREST_MIP&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,
b.NEAREST_MIPMAP_LINEAR),b.generateMipmap(b.TEXTURE_2D));this.filterType=a};Z.prototype.use=function(a){l.gl.activeTexture(a);l.gl.bindTexture(l.gl.TEXTURE_2D,ka[this.tex_id]);this.active_unit=a};Z.prototype.clear=function(){if(this.active_unit!==-1)l.gl.activeTexture(this.active_unit),l.gl.bindTexture(l.gl.TEXTURE_2D,null),this.active_unit=-1};Fa.prototype.update=function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=w.GLCore.gl;a.bindTexture(a.TEXTURE_2D,
w.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===g.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};db.prototype.update=function(){var a=w.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,w.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===
g.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)};wa.prototype.getMesh=function(){return this.obj};wa.prototype.setIndexedHeight=function(a,b,c){obj.points[a+b*this.divisions_w][1]=c};wa.prototype.mapGen=function(a,b,c,d,e){if(b!==h&&c!==h&&d!==h&&e!==h){if(!(b>=this.divisions_w)&&!(c>=this.divisions_h)&&(b+d>=this.divisions_w&&(d=this.divisions_w-1-b),c+e>=this.divisions_h&&(e=this.divisions_h-1-c),!(d<=0||e<=0)))for(var f=b,d=b+d;f<d;f++)for(var g=c,r=
c+e;g<r;g++)b=this.obj.points[f+g*this.divisions_w],b[1]=a(b[0],b[2])}else{c=0;for(e=this.obj.points.length;c<e;c++)b=this.obj.points[c],b[1]=a(b[0],b[2])}};wa.prototype.getFaceAt=function(a,b){if(typeof a==="object")return this.getFaceAt(a[0],a[2]);var c=this.size_h/2-this.size_h/this.divisions_h/2,d=parseInt(p.floor((a+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),c=parseInt(p.floor((b+c)/this.size_h*this.divisions_h),10);if(d<0)return-1;if(d>=this.divisions_w-
1)return-1;if(c<0)return-1;if(c>=this.divisions_h-1)return-1;var d=parseInt(d+c*(this.divisions_w-1),10)*2,c=parseInt(d+1,10),e=this.obj.points[this.obj.faces[d].points[0]];return p.abs(b-e[2])/p.abs(a-e[0])>=1?d:c};wa.prototype.getHeightValue=function(a,b){if(typeof a==="object")return this.getHeightValue(a[0],a[2]);var c,d=this.getFaceAt(a,b);if(d===-1)return 0;c=this.obj.points[this.obj.faces[d].points[0]];var e=qb.normal(this.obj.points[this.obj.faces[d].points[0]],this.obj.points[this.obj.faces[d].points[1]],
this.obj.points[this.obj.faces[d].points[2]]),d=e[0],f=e[1],e=e[2];return(d*a+e*b+(-(d*c[0])-f*c[1]-e*c[2]))/-f};wa.prototype.orient=function(a,b,c,d,e,f){f===h&&(f=0);var g,r,i=[];g=c/2;var u=d/2;r=p.sqrt(u*u+g*g);u=p.atan2(u,g);e*=J/180;g=a+p.sin(e)*f;f=b+p.cos(e)*f;i[0]=this.getHeightValue([g+r*p.cos(-u-N+e),0,f+r*-p.sin(-u-N+e)]);i[1]=this.getHeightValue([g+r*p.cos(u-N+e),0,f+r*-p.sin(u-N+e)]);i[2]=this.getHeightValue([g+r*p.cos(-u+N+e),0,f+r*-p.sin(-u+N+e)]);i[3]=this.getHeightValue([g+r*p.cos(u+
N+e),0,f+r*-p.sin(u+N+e)]);r=-p.atan2(i[1]-i[2],c);f=-p.atan2(i[0]-i[1],d);r+=-p.atan2(i[0]-i[3],c);f+=-p.atan2(i[3]-i[2],d);r/=2;f/=2;return[[a,(i[2]+i[3]+i[1]+i[0])/4,b],[r*(180/J),e,f*(180/J)]]};var Sa=0;V.prototype.setMorphSource=function(a){this.morphSource=a};V.prototype.setMorphTarget=function(a){this.morphTarget=a};V.prototype.getMorphSource=function(){return this.morphSource};V.prototype.getMorphTarget=function(){return this.morphTarget};V.prototype.setMorphWeight=function(a){this.morphWeight=
a};V.prototype.morphTargetCount=function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:0};V.prototype.doTransform=function(a){if(!s.equal(this.lposition,this.position)||!s.equal(this.lrotation,this.rotation)||!s.equal(this.lscale,this.scale)||a!==h)this.trans.clearStack(),a!==h&&this.trans.pushMatrix(a),this.trans.translate(this.position),this.rotation[0]===0&&this.rotation[1]===0&&this.rotation[2]===0||(this.trans.pushMatrix(),this.trans.rotate(this.rotation)),this.scale[0]===
1&&this.scale[1]===1&&this.scale[2]===1||(this.trans.pushMatrix(),this.trans.scale(this.scale)),this.tMatrix=this.trans.getResult(),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0};V.prototype.adjust_octree=function(){var a=this.getAABB(),
b=this.octree_aabb,c=a[0][0],d=a[0][1],e=a[0][2],f=a[1][0],g=a[1][1],r=a[1][2],i=b[0][0],u=b[0][1],q=b[0][2],o=b[1][0],l=b[1][1],b=b[1][2];if(this.octree_leaves.length>0&&(c<i||d<u||e<q||f>o||g>l||r>b)){for(c=0;c<this.octree_leaves.length;++c)this.octree_leaves[c].remove(this);this.octree_leaves=[];this.static_lights=[];c=this.octree_common_root;this.octree_common_root=null;if(c!==null){for(;;)if(!c.contains_point(a[0])||!c.contains_point(a[1]))if(c._root!==h&&c._root!==null)c=c._root;else break;
else break;Da(this.octree_aabb,this.position);c.insert(this)}}};V.prototype.bindChild=function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)};V.prototype.control=function(a,b,c){a===g.motion.POS?this.position[b]=c:a===g.motion.SCL?this.scale[b]=c:a===g.motion.ROT&&(this.rotation[b]=c)};V.prototype.getAABB=function(){if(this.dirty){var a=Array(8);this.doTransform();var b,c;if(this.obj!==null){if(this.obj.bb===null)return this.aabb=[s.add([-1,-1,-1],this.position),
s.add([1,1,1],this.position)];b=this.obj.bb[0];c=this.obj.bb[1]}if(this.obj===null||b===h||c===h)return this.aabb=[s.add([-1,-1,-1],this.position),s.add([1,1,1],this.position)];var d=b;b=s.subtract(c,b);a[0]=[d[0],d[1],d[2]];a[1]=[d[0],d[1],d[2]+b[2]];a[2]=[d[0]+b[0],d[1],d[2]];a[3]=[d[0]+b[0],d[1],d[2]+b[2]];a[4]=[d[0],d[1]+b[1],d[2]];a[5]=[d[0],d[1]+b[1],d[2]+b[2]];a[6]=[d[0]+b[0],d[1]+b[1],d[2]];a[7]=[d[0]+b[0],d[1]+b[1],d[2]+b[2]];d=A.vec3_multiply(a[0],this.tMatrix);b=[d[0],d[1],d[2]];c=[d[0],
d[1],d[2]];for(var e=1;e<8;++e)d=A.vec3_multiply(a[e],this.tMatrix),b[0]>d[0]&&(b[0]=d[0]),b[1]>d[1]&&(b[1]=d[1]),b[2]>d[2]&&(b[2]=d[2]),c[0]<d[0]&&(c[0]=d[0]),c[1]<d[1]&&(c[1]=d[1]),c[2]<d[2]&&(c[2]=d[2]);this.aabb[0]=b;this.aabb[1]=c;this.dirty=!1}return this.aabb};var Ka=function(a,b,c){var d=0,d=c-b;if(d===0)return[b,0];b=a-d*p.floor((a-b)/d);d=-parseInt((b-a)/d+(b>a?0.5:-0.5),10);return[b,d]},rb=function(a,b,c,d,e){var f,g;g=e*e;f=3*(b-a);b=3*(c-b)-f;return(d-a-f-b)*g*e+b*g+f*e+a},sb=function(a,
b,c,d,e,f,g){var h,i;i=f+(g-f)*0.5;h=rb(a,b,c,d,i);return p.abs(e-h)>1.0E-4?(h>e?g=i:f=i,sb(a,b,c,d,e,f,g)):i},tb=function(a,b){var c,d,e,f;a.shape===g.envelope.shape.TCB?(c=(1-a.tension)*(1+a.continuity)*(1+a.bias),d=(1-a.tension)*(1-a.continuity)*(1-a.bias),e=b.value-a.value,a.prev?(f=(b.time-a.time)/(b.time-a.prev.time),c=f*(c*(a.value-a.prev.value)+d*e)):c=d*e):a.shape===g.envelope.shape.LINE?(e=b.value-a.value,a.prev?(f=(b.time-a.time)/(b.time-a.prev.time),c=f*(a.value-a.prev.value+e)):c=e):
a.shape===g.envelope.shape.BEZI||a.shape===g.envelope.shape.HERM?(c=a.param[1],a.prev&&(c*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===g.envelope.shape.BEZ2?(c=a.param[3]*(b.time-a.time),p.abs(a.param[2])>1.0E-5?c/=a.param[2]:c*=1E5):c=0;return c},ub=function(a,b){var c,d,e,f;b.shape===g.envelope.shape.LINE?(e=b.value-a.value,b.next?(f=(b.time-a.time)/(b.next.time-a.time),c=f*(b.next.value-b.value+e)):c=e):b.shape===g.envelope.shape.TCB?(c=(1-b.tension)*(1-b.continuity)*(1+b.bias),d=(1-b.tension)*
(1+b.continuity)*(1-b.bias),e=b.value-a.value,b.next?(f=(b.time-a.time)/(b.next.time-a.time),c=f*(d*(b.next.value-b.value)+c*e)):c*=e):b.shape===g.envelope.shape.HERM||b.shape===g.envelope.shape.BEZI?(c=b.param[0],b.next&&(c*=(b.time-a.time)/(b.next.time-a.time))):b.shape===g.envelope.shape.BEZ2?(c=b.param[1]*(b.time-a.time),p.abs(b.param[0])>1.0E-5?c/=b.param[0]:c*=1E5):c=0;return c};ja.prototype.setBehavior=function(a,b){this.in_behavior=a;this.out_behavior=b};ja.prototype.empty=function(){return this.nKeys===
0};ja.prototype.addKey=function(a,b,c){var d=typeof a=="object"?a:c;b||(b=0);a||(a=0);d?(d=a,a=d.time,c=this.insertKey(a),c.value=d.value?d.value:b,c.time=d.time?d.time:a,c.shape=d.shape?d.shape:g.envelope.shape.TCB,c.tension=d.tension?d.tension:0,c.continuity=d.continuity?d.continuity:0,c.bias=d.bias?d.bias:0,c.param=d.param?d.param:[0,0,0,0]):(c=this.insertKey(a),c.value=b);return c};ja.prototype.insertKey=function(a){var b=new xb;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=
b,this.nKeys++,b;for(var c=this.keys;c;){if(this.firstKey.time>a)this.firstKey=b;else if(this.lastKey.time<a)this.lastKey=b;if(c.time>b.time){b.prev=c.prev;if(b.prev)b.prev.next=b;b.next=c;b.next.prev=b;this.nKeys++;return b}else if(!c.next)return b.prev=c,c.next=b,this.nKeys++,b;c=c.next}return null};ja.prototype.evaluate=function(a){var b,c,d,e,f,m=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;c=this.firstKey;b=this.lastKey;if(a<c.time)if(e=this.in_behavior,e===g.envelope.behavior.RESET)return 0;
else if(e===g.envelope.behavior.CONSTANT)return c.value;else if(e===g.envelope.behavior.REPEAT)e=Ka(a,c.time,b.time),a=e[0];else if(e===g.envelope.behavior.OCILLATE)e=Ka(a,c.time,b.time),a=e[0],e=e[1],e%2&&(a=b.time-c.time-a);else if(e===g.envelope.behavior.OFFSET)e=Ka(a,c.time,b.time),a=e[0],e=e[1],m=e*(b.value-c.value);else{if(e===g.envelope.behavior.LINEAR)return f=tb(c,c.next)/(c.next.time-c.time),f*(a-c.time)+c.value}else if(a>b.time)if(e=this.out_behavior,e===g.envelope.behavior.RESET)return 0;
else if(e===g.envelope.behavior.CONSTANT)return b.value;else if(e===g.envelope.behavior.REPEAT)e=Ka(a,c.time,b.time),a=e[0];else if(e===g.envelope.behavior.OCILLATE)e=Ka(a,c.time,b.time),a=e[0],e=e[1],e%2&&(a=b.time-c.time-a);else if(e===g.envelope.behavior.OFFSET)e=Ka(a,c.time,b.time),a=e[0],e=e[1],m=e*(b.value-c.value);else if(e===g.envelope.behavior.LINEAR)return e=ub(b.prev,b)/(b.time-b.prev.time),e*(a-b.time)+b.value;if(this.lastKey0)if(a>this.lastKey0.time)b=this.lastKey0;else if(a<this.lastKey0.time)for(b=
this.lastKey;a<b.time&&b.prev;)b=b.prev;else b=this.keys;else b=this.keys;for(;a>b.next.time;)b=b.next;c=b.next;this.lastKey0=b;if(a===b.time)return b.value+m;else if(a===c.time)return c.value+m;d=(a-b.time)/(c.time-b.time);e=c.shape;if(e===g.envelope.shape.TCB||e===g.envelope.shape.BEZI||e===g.envelope.shape.HERM){f=tb(b,c);e=ub(b,c);var h,i;i=d*d;h=d*i;a=3*i-h-h;h-=i;a=[1-a,a,h-i+d,h];return a[0]*b.value+a[1]*c.value+a[2]*f+a[3]*e+m}else return e===g.envelope.shape.BEZ2?(a=sb(b.time,b.shape===g.envelope.shape.BEZ2?
b.time+b.param[2]:b.time+(c.time-b.time)/3,c.time+c.param[0],c.time,a,0,1),m=rb(b.value,b.shape===g.envelope.shape.BEZ2?b.value+b.param[3]:b.value+b.param[1]/3,c.param[1]+c.value,c.value,a)+m):m=e===g.envelope.shape.LINE?b.value+d*(c.value-b.value)+m:e===g.envelope.shape.STEP?b.value+m:m,m};aa.prototype.envelope=function(a,b){this.controllers[a]===h&&(this.controllers[a]=[]);this.controllers[a][b]===h&&(this.controllers[a][b]=new ja(this.env_init));return this.controllers[a][b]};aa.prototype.evaluate=
function(a){var b=[],c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){b[c]=[];for(var d in this.controllers[c])this.controllers[c].hasOwnProperty(d)&&(b[c][d]=this.controllers[c][d].evaluate(a))}return b};aa.prototype.apply=function(a,b){for(var c in this.controllers)if(this.controllers.hasOwnProperty(c)){var d=parseInt(c,10);if(this.yzflip&&d===g.motion.ROT){if(!this.q)this.q=new na;var e=this.q,f=this.controllers[c][0].evaluate(a),m=this.controllers[c][1].evaluate(a),h=this.controllers[c][2].evaluate(a);
e.fromEuler(f,h,-m);e=e.toEuler();b.control(d,0,e[0]);b.control(d,1,e[1]);b.control(d,2,e[2])}else for(var i in this.controllers[c])this.controllers[c].hasOwnProperty(i)&&b.control(d,parseInt(i,10),this.controllers[c][i].evaluate(a))}};aa.prototype.setKey=function(a,b,c,d,e){return this.envelope(a,b).addKey(c,d,e?e:this.key_init)};aa.prototype.setArray=function(a,b,c,d){var e=[],f;for(f in c)if(c.hasOwnProperty(f)){var g=this.envelope(a,f);e[f]=g.addKey(b,c[f],d?d:this.key_init)}return e};aa.prototype.setBehavior=
function(a,b,c,d){this.envelope(a,b).setBehavior(c,d)};aa.prototype.setBehaviorArray=function(a,b,c){for(var d in this.controllers[a])this.controllers[a].hasOwnProperty(d)&&this.envelope(a,d).setBehavior(b,c)};Oa.prototype.classify_point=function(a){a=this.a*a[0]+this.b*a[1]+this.c*a[2]+this.d;if(a<0)return-1;if(a>0)return 1;return 0};Oa.prototype.normalize=function(){var a=p.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);this.a/=a;this.b/=a;this.c/=a;this.d/=a};Oa.prototype.toString=function(){return"[Plane "+
this.a+", "+this.b+", "+this.c+", "+this.d+"]"};Wa.prototype.intersects=function(a){var b=s.subtract(this.position,a.position),b=p.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]),a=this.radius+a.radius;if(b*b<a*a)return!0;return!1};Array_remove=function(a,b,c){c=a.slice((c||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,c)};I.prototype.destroy=function(){for(var a=0,b=this._static_lights.length;a<b;++a){var c=this._static_lights[a];c.octree_leaves=null;c.octree_common_root=null;c.octree_aabb=
null}a=0;for(b=this._lights.length;a<b;++a)c=this._lights[a],c.octree_leaves=null,c.octree_common_root=null,c.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].destroy();a=0;for(b=this._nodes.length;a<b;++a)c=this._nodes[a],c.octree_leaves=null,c.octree_common_root=null,c.octree_aabb=null,c.dynamic_lights=[],c.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=
null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};I.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};I.prototype.remove=function(a){var b=!1,c=this._nodes.length,
d;d=c-1;for(c=this._nodes.length;d>=0;--d)if(a===this._nodes[d]){Array_remove(this._nodes,d);this.dirty_lineage();b=!0;break}if(!b)for(d=c-1;d>=0;--d)if(a===this._lights[d]){Array_remove(this._lights,d);this.dirty_lineage();break}};I.prototype.dirty_lineage=function(){this._dirty=!0;this._root!==null&&this._root.dirty_lineage()};I.prototype.cleanup=function(){for(var a=this._children.length,b=0,c=0;c<a;++c){var d=this._children[c];if(d!==null){var e=!0;d._dirty===!0&&(e=d.cleanup());e?++b:this._children[c]=
null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(b===0||a===0))return!1;return!0};I.prototype.insert_light=function(a){this.insert(a,!0)};I.prototype.propagate_static_light=function(a){var b,c;b=0;for(c=this._nodes.length;b<c;++b)this._nodes[b].static_lights.indexOf(a)===-1&&this._nodes[b].static_lights.push(a);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].propagate_static_light(a)};I.prototype.collect_static_lights=function(a){for(var b=0,c=
this._static_lights.length;b<c;++b)a.static_lights.indexOf(this._static_lights[b])===-1&&a.static_lights.push(this._static_lights[b]);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].collect_static_lights(a)};I.prototype.insert=function(a,b){function c(a,b,c,d){var e;if(c)if(b.method===g.light.method.STATIC){a._static_lights.indexOf(b)===-1&&a._static_lights.push(b);for(c=0;c<a._nodes.length;++c)a._nodes[c].static_lights.indexOf(b)===-1&&a._nodes[c].static_lights.push(b);for(e=a._root;e!==
null;){for(var c=0,f=e._nodes.length;c<f;++c){var h=e._nodes[c];h.static_lights.indexOf(b)===-1&&h.static_lights.push(b)}e=e._root}}else a._lights.indexOf(b)===-1&&a._lights.push(b);else{a._nodes.push(b);c=0;for(e=a._static_lights.length;c<e;++c)b.static_lights.indexOf(a._static_lights[c])===-1&&b.static_lights.push(a._static_lights[c]);for(e=a._root;e!==null;){c=0;for(f=e._static_lights.length;c<f;++c)h=e._static_lights[c],b.static_lights.indexOf(h)===-1&&b.static_lights.push(h);e=e._root}}b.octree_leaves.push(a);
b.octree_common_root=d;Ea(b.octree_aabb,a._bbox[0]);Ea(b.octree_aabb,a._bbox[1])}b===h&&(b=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)c(this,a,b,this._root);else{var d=this._position,e,f,m,r,i,u,q;f=a.getAABB();q=[f[0][0],f[0][1],f[0][2]];var o=[f[1][0],f[1][1],f[1][2]];e=q[0]<d[0]&&q[1]<d[1]&&q[2]<d[2];f=o[0]>d[0]&&q[1]<d[1]&&q[2]<d[2];i=q[0]<d[0]&&o[1]>d[1]&&q[2]<d[2];u=o[0]>d[0]&&o[1]>d[1]&&q[2]<d[2];m=q[0]<d[0]&&q[1]<d[1]&&o[2]>d[2];r=o[0]>d[0]&&
q[1]<d[1]&&o[2]>d[2];q=q[0]<d[0]&&o[1]>d[1]&&o[2]>d[2];d=o[0]>d[0]&&o[1]>d[1]&&o[2]>d[2];if(e&&f&&i&&u&&m&&r&&q&&d)c(this,a,b,this),b?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var o=0,l=this._static_lights.length;o<l;++o){if(a.static_lights===h)a.static_lights=[];a.static_lights.indexOf(this._static_lights[o])===-1&&a.static_lights.push(this._static_lights[o])}var o=this._size/2,l=this._size/4,n=0,x=this._position[0],t=this._position[1],
p=this._position[2];e&&(e=[x-l,t-l,p-l],this._children[g.octree.TOP_NW]===null&&(this._children[g.octree.TOP_NW]=new I(o,this._max_depth-1,this,e,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,b),++n);f&&(e=[x+l,t-l,p-l],this._children[g.octree.TOP_NE]===null&&(this._children[g.octree.TOP_NE]=new I(o,this._max_depth-1,this,e,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,b),++n);i&&(e=[x-l,t+l,p-l],this._children[g.octree.BOTTOM_NW]===null&&(this._children[g.octree.BOTTOM_NW]=
new I(o,this._max_depth-1,this,e,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,b),++n);u&&(e=[x+l,t+l,p-l],this._children[g.octree.BOTTOM_NE]===null&&(this._children[g.octree.BOTTOM_NE]=new I(o,this._max_depth-1,this,e,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,b),++n);m&&(e=[x-l,t-l,p+l],this._children[g.octree.TOP_SW]===null&&(this._children[g.octree.TOP_SW]=new I(o,this._max_depth-1,this,e,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,b),++n);
r&&(e=[x+l,t-l,p+l],this._children[g.octree.TOP_SE]===null&&(this._children[g.octree.TOP_SE]=new I(o,this._max_depth-1,this,e,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,b),++n);q&&(e=[x-l,t+l,p+l],this._children[g.octree.BOTTOM_SW]===null&&(this._children[g.octree.BOTTOM_SW]=new I(o,this._max_depth-1,this,e,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,b),++n);d&&(e=[x+l,t+l,p+l],this._children[g.octree.BOTTOM_SE]===null&&(this._children[g.octree.BOTTOM_SE]=new I(o,
this._max_depth-1,this,e,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,b),++n);if(n>1||a.octree_common_root===null)a.octree_common_root=this}}};I.prototype.draw_on_map=function(a,b,c){function d(a,c,d,g,h){var i=a<d?a:d,m=c<g?c:g,a=a<d?d-a:a-d,c=c<g?g-c:c-g;b.save();if(h!==void 0)b.fillStyle=h,b.fillRect(e+i,f+m,a,c);b.strokeRect(e+i,f+m,a,c);b.restore()}var e=a.width/2,f=a.height/2,g,r,i,l,q,o;if(c===h||c==="map")b.save(),this._debug_visible!==!1?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle=
"#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),q=this._size/2,g=this._position[0],r=this._position[2],b.moveTo(e+g-q,e+r-q),b.lineTo(e+g-q,e+r+q),b.lineTo(e+g+q,e+r+q),b.lineTo(e+g+q,e+r-q),b.stroke(),b.fill(),b.restore();if(c===h||c==="objects"){b.save();q=0;for(o=this._nodes.length;q<o;++q){var s=this._nodes[q];b.fillStyle="#5500FF";b.strokeStyle=s.visible===!0&&s.culled===!1?"#FFFFFF":"#000000";b.beginPath();g=s.aabb[0][0];r=s.aabb[0][2];i=s.aabb[1][0]-g;l=
s.aabb[1][2]-r;b.rect(e+g,f+r,i,l);b.stroke()}b.restore()}if(c===h||c==="lights"){q=0;for(o=this._lights.length;q<o;++q)l=this._lights[q],b.fillStyle=l.culled===!1&&l.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),s=l.distance,g=l.position[0],r=l.position[2],b.arc(e+g,f+r,s,0,p.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),g=l.aabb[0][0],r=l.aabb[0][2],i=l.aabb[1][0]-g,l=l.aabb[1][2]-r,b.rect(e+g,f+r,i,l),b.closePath(),b.stroke();
q=0;for(o=this._static_lights.length;q<o;++q)l=this._static_lights[q],b.fillStyle=l.culled===!1&&l.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),s=l.distance,g=l.position[0],r=l.position[2],b.arc(e+g,f+r,s,0,p.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),g=l.aabb[0][0],r=l.aabb[0][2],i=l.aabb[1][0]-g,l=l.aabb[1][2]-r,b.rect(e+g,f+r,i,l),b.closePath(),b.stroke()}if(c!="lights"&&c!="objects"&&c!="map"){b.save();g=this._nodes;q=
0;for(l=g.length;q<l;++q)if(s=g[q],s.name==c){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();g=s.aabb[0][0];r=s.aabb[0][2];i=s.aabb[1][0]-g;l=s.aabb[1][2]-r;b.rect(e+g,f+r,i,l);b.closePath();b.stroke();g=s.octree_aabb;b.strokeStyle="#0000FF";d(g[0][0],g[0][2],g[1][0],g[1][2]);b.lineWidth=1;if(s.common_root!==null)b.strokeStyle="#00FF00";break}b.lineWidth=1;b.strokeStyle="#FFFF00";d(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}q=0;for(o=this._children.length;q<
o;++q)this._children[q]!==null&&this._children[q].draw_on_map(a,b,c)};I.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};I.prototype.get_frustum_hits=function(a,b){var c={objects:[],lights:[]};if((b===h||b===!0)&&!this.contains_point(a.position)){if(a.frustum.sphere.intersects(this._sphere)===
!1)return c;var d=a.frustum.contains_sphere(this._sphere);if(d===-1)return this._debug_visible=!1,c;else if(d===1)this._debug_visible=2,b=!1;else if(d===0)if(this._debug_visible=!0,d=a.frustum.contains_box(this._bbox),d===-1)return this._debug_visible=!1,c;else if(d===1)this._debug_visible=3,b=!1}var e,d=0;for(e=this._nodes.length;d<e;++d){var f=this._nodes[d];c.objects.push(f);f.dynamic_lights=[].concat(this._lights);f.was_culled=f.culled;f.culled=!1;f.drawn_this_frame=!1}this._debug_visible=this._lights.length>
0?4:this._debug_visible;d=0;for(e=this._lights.length;d<e;++d)if(f=this._lights[d],f.visible===!0)c.lights.push(f),f.was_culled=f.culled,f.culled=!1;d=0;for(e=this._static_lights.length;d<e;++d)if(f=this._static_lights[d],f.visible===!0)f.culled=!1;for(d=0;d<8;++d)if(this._children[d]!==null){e=this._children[d].get_frustum_hits(a,b);var g,f=0;for(g=e.objects.length;f<g;++f){c.objects.push(e.objects[f]);for(var l=e.objects[f].dynamic_lights,i=0,u=this._lights.length;i<u;++i)l.indexOf(this._lights[i])<
0&&l.push(this._lights[i])}f=0;for(g=e.lights.length;f<g;++f)c.lights.indexOf(e.lights[f])<0&&c.lights.push(e.lights[f])}return c};I.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=!0;a=0;for(b=this._lights.length;a<b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};
kb.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};kb.prototype.attach=function(a){this._object=a};lb.prototype.onmessage=function(a){var b=a.message;if(b==="init"){var c=a.data;this.octree=new I(c.size,c.max_depth);this.camera=new S}else if(type==="set_camera")c=b.data,this.camera.mvMatrix=c.mvMatrix,this.camera.pMatrix=c.pMatrix,this.camera.position=c.position,this.camera.target=c.target,this.camera.frustum.extract(this.camera,this.camera.mvMatrix,this.camera.pMatrix);else if(type===
"insert"){var a=JSON.parse(b.data),b=new V,d=new R;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);for(c in a.trans)a.trans.hasOwnProperty(c)&&(d[c]=a.trans[c]);b.trans=d;b.id=a.id;this.octree.insert(b);this.nodes[b.id]=b}else type==="cleaup"&&this.octree.cleanup()};Ha.prototype.extract=function(a,b,c){if(!(b===h||c===h)){var d=A.multiply(b,c);this._planes[g.frustum.plane.LEFT].a=d[3]+d[0];this._planes[g.frustum.plane.LEFT].b=d[7]+d[4];this._planes[g.frustum.plane.LEFT].c=d[11]+d[8];this._planes[g.frustum.plane.LEFT].d=
d[15]+d[12];this._planes[g.frustum.plane.RIGHT].a=d[3]-d[0];this._planes[g.frustum.plane.RIGHT].b=d[7]-d[4];this._planes[g.frustum.plane.RIGHT].c=d[11]-d[8];this._planes[g.frustum.plane.RIGHT].d=d[15]-d[12];this._planes[g.frustum.plane.TOP].a=d[3]-d[1];this._planes[g.frustum.plane.TOP].b=d[7]-d[5];this._planes[g.frustum.plane.TOP].c=d[11]-d[9];this._planes[g.frustum.plane.TOP].d=d[15]-d[13];this._planes[g.frustum.plane.BOTTOM].a=d[3]+d[1];this._planes[g.frustum.plane.BOTTOM].b=d[7]+d[5];this._planes[g.frustum.plane.BOTTOM].c=
d[11]+d[9];this._planes[g.frustum.plane.BOTTOM].d=d[15]+d[13];this._planes[g.frustum.plane.NEAR].a=d[3]+d[2];this._planes[g.frustum.plane.NEAR].b=d[7]+d[6];this._planes[g.frustum.plane.NEAR].c=d[11]+d[10];this._planes[g.frustum.plane.NEAR].d=d[15]+d[14];this._planes[g.frustum.plane.FAR].a=d[3]-d[2];this._planes[g.frustum.plane.FAR].b=d[7]-d[6];this._planes[g.frustum.plane.FAR].c=d[11]-d[10];this._planes[g.frustum.plane.FAR].d=d[15]-d[14];for(b=0;b<6;++b)this._planes[b].normalize();var e=-this._planes[g.frustum.plane.NEAR].d,
b=this._planes[g.frustum.plane.FAR].d-e,c=b*(1/c[5]),c=s.subtract([0,0,e+b*0.5],[c,c,e+b]),c=s.length(c),d=[d[3],d[9],d[10]],e=s.length(d),d=s.multiply(d,1/e);this.sphere=new Wa([a.position[0],a.position[1],a.position[2]],c);this.sphere.position=s.add(this.sphere.position,s.multiply(d,b*0.5));this.sphere.position=s.add(this.sphere.position,s.multiply(d,1))}};Ha.prototype.contains_sphere=function(a){for(var b=0;b<6;++b){var c=this._planes[b],c=s.dot([c.a,c.b,c.c],a.position)+c.d;this.last_in[b]=1;
if(c<-a.radius)return-1;if(p.abs(c)<a.radius)return 0}return 1};Ha.prototype.draw_on_map=function(a,b){var c=a.width/2,d=a.height/2;b.save();for(var e=0,f=this._planes.length;e<f;++e)if(!(e===2||e===3)){b.strokeStyle="#FF00FF";if(e<this.last_in.length&&this.last_in[e])b.strokeStyle="#FFFF00";var g=this._planes[e],h=-c,i=c,l=(-g.d-g.a*i)/g.c;b.moveTo(c+h,d+(-g.d-g.a*h)/g.c);b.lineTo(c+i,d+l);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(c+this.sphere.position[0],d+this.sphere.position[2],
this.sphere.radius,0,p.PI*2,!1);b.closePath();b.stroke();b.restore()};Ha.prototype.contains_box=function(a){var b=0,c=[];c[0]=a[0];c[1]=[a[0][0],a[0][1],a[1][2]];c[2]=[a[0][0],a[1][1],a[0][2]];c[3]=[a[0][0],a[1][1],a[1][2]];c[4]=[a[1][0],a[0][1],a[0][2]];c[5]=[a[1][0],a[0][1],a[1][2]];c[6]=[a[1][0],a[1][1],a[0][2]];c[7]=a[1];for(a=0;a<6;++a){for(var d=8,e=1,f=0;f<8;++f)this._planes[a].classify_point(c[f])===-1&&(e=0,--d);this.last_in[a]=e;if(d===0)return-1;b+=e}if(b===6)return 1;return 0};S.prototype.setOrtho=
function(a,b,c,d){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=c;this.ortho_view.top=d};S.prototype.control=function(a,b,c){a===g.motion.ROT?this.rotation[b]=c:a===g.motion.POS?this.position[b]=c:a===g.motion.FOV?this.setFOV(c):a===g.motion.LENS?this.setLENS(c):a===g.motion.NEARCLIP?this.setClip(c,this.farclip):a===g.motion.FARCLIP&&this.setClip(this.nearclip,c)};S.prototype.makeFrustum=function(a,b,c,d,e,f){return[2*e/(b-a),0,0,0,0,2*e/(d-c),0,0,(b+a)/(b-a),
(d+c)/(d-c),-(f+e)/(f-e),-1,0,0,-2*f*e/(f-e),0]};S.prototype.setTargeted=function(a){this.targeted=a};S.prototype.calcProjection=function(){this.pMatrix=this.ortho?A.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):A.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)this.transform.clearStack(),this.transform.translate(-this.position[0],-this.position[1],-this.position[2]),this.transform.pushMatrix(),
this.transform.rotate(-this.rotation[2],0,0,1),this.transform.rotate(-this.rotation[1],0,1,0),this.transform.rotate(-this.rotation[0],1,0,0),this.transform.pushMatrix(),this.mvMatrix=this.transform.getResult(),this.calc_nmatrix?(this.nMatrix=A.inverse_mat3(this.mvMatrix),Ma.transpose_inline(this.nMatrix)):this.nMatrix=oa;this.frustum.extract(this,this.mvMatrix,this.pMatrix)};S.prototype.setClip=function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()};S.prototype.setDimensions=function(a,
b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()};S.prototype.resize=function(a,b){this.setDimensions(a,b)};S.prototype.setFOV=function(a){this.fov=a;this.ortho=!1;this.calcProjection()};S.prototype.setLENS=function(a){this.setFOV(2*p.atan(16/a)*(180/J))};S.prototype.lookat=function(a,b,c,d,e,f,g,h,i){if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=A.lookat(a,b,c,d,e,f,g,h,i);if(this.rotation[2])this.transform.clearStack(),
this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.calc_nmatrix?(this.nMatrix=A.inverse_mat3(this.mvMatrix),Ma.transpose_inline(this.nMatrix)):this.nMatrix=oa;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}};S.prototype.unProject=function(a,b,c){var d=[0,0,this.width,this.height];if(c===h)c=this.farclip;a=A.vec4_multiply(A.vec4_multiply([(a-d[0])/d[2]*2-1,-((b-d[1])/d[3]*2-1),(c-this.nearclip)/(this.farclip-
this.nearclip),1],A.inverse(this.pMatrix)),A.inverse(this.mvMatrix));return[a[0]/a[3],a[1]/a[3],a[2]/a[3]]};S.prototype.project=function(a,b,c){a=A.vec4_multiply(A.vec4_multiply([a,b,c,1],this.mvMatrix),this.pMatrix);return[(a[0]/a[3]+1)/2*this.width,(-a[1]/a[3]+1)/2*this.height,a[2]/a[3]*(this.farclip-this.nearclip)+this.nearclip]};Pa.prototype.control=function(a,b,c){a===g.motion.POS&&(this.position[b]=c)};Ia.prototype.inBounds=function(a){if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>
this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var b=0,c=this.avoid_sphere.length;b<c;b++)if(s.length(a,this.avoid_sphere[b][0])<this.avoid_sphere[b][1])return!1;return!0};Ia.prototype.findNextNode=function(a,b){var c=[0,0,0],d=[0,0,0],e=c=0,f=!1;do if(d[0]=p.random()-0.5,d[1]=p.random()-0.5,d[2]=p.random()-0.5,d=s.normalize(d),c=p.random()*(this.max_distance-this.min_distance)+this.min_distance,c=s.add(b.position,s.multiply(d,c)),f=this.inBounds(c),
e++,e>30){c=b.position;break}while(!f);return c};Ia.prototype.run=function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new Pa,
c=new Pa;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,c);b=this.findNextNode(b,c);this.camPath.setKey(g.motion.POS,g.motion.X,this.path_time,b[0]);this.camPath.setKey(g.motion.POS,g.motion.Y,this.path_time,b[1]);this.camPath.setKey(g.motion.POS,g.motion.Z,this.path_time,b[2]);this.path_length++}b=new Pa;this.camPath.apply(a,b);return b.position};Ia.prototype.addSafeBound=function(a,b){this.safe_bb.push([a,b])};Ia.prototype.addAvoidSphere=
function(a,b){this.avoid_sphere.push([a,b])};T.prototype.attachOctree=function(a){this.octree=a;a.init&&a.init(this);var b=this.lights;this.lights=[];for(var a=0,c=b.length;a<c;a++)this.bindLight(b[a]);b=this.sceneObjects;if(this.octree!==h){c=0;for(a=b.length;c<a;++c){var d=b[c];if(d.obj!==null){if(d.id<0)d.id=Sa,++Sa;this.sceneObjectsById[d.id]=d;Da(d.octree_aabb,d.position);this.octree.insert(d);(d.octree_common_root===void 0||d.octree_common_root===null)&&la("!!",d.name,"octree_common_root is null")}}}};
T.prototype.setSkyBox=function(a){this.skybox=a};T.prototype.getSceneObject=function(a){return this.sceneObjectsByName[a]};T.prototype.bindSceneObject=function(a,b,c){if(this.sceneObjects.indexOf(a)==-1){this.sceneObjects.push(a);b!==h&&b&&this.pickables.push(a);a.name!==null&&(this.sceneObjectsByName[a.name]=a);if(this.octree!==h&&(c===h||c==="true")){if(a.id<0)a.id=Sa,++Sa;this.sceneObjectsById[a.id]=a;Da(a.octree_aabb,a.position);this.octree.insert(a)}if(a.children)for(var d=0,e=a.children.length;d<
e;d++)this.bindSceneObject(a.children[d],b,c)}};T.prototype.removeLight=function(a){var b;(b=this.lights.indexOf(a))>=0&&this.lights.splice(b,1)};T.prototype.removeSceneObject=function(a){var b;(b=this.sceneObjects.indexOf(a))>=0&&this.sceneObjects.splice(b,1);this.pickables.indexOf(a)>=0&&pickable&&this.pickables.push(a);a.name!==null&&this.sceneObjectsByName[a.name]!==h&&delete this.sceneObjectsByName[a.name];if(a.children){b=0;for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}};
T.prototype.bindLight=function(a,b){this.lights.push(a);if(this.octree!==h&&(b===h||b==="true"))a.method===g.light.method.GLOBAL?this.global_lights.push(a):(a.method===g.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(mb)};T.prototype.bindCamera=function(a){this.camera=a};T.prototype.evaluate=function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);
if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(c=this.lights.length;b<c;b++){var d=this.lights[b];d.motion!==null&&d.motion.apply(a,d)}};T.prototype.renderSceneObjectChildren=function(a,b,c){for(var d=l.gl,e=!1,f=0,g=a.children.length;f<g;f++)if(a.children[f].visible!==!1){try{a.children[f].doTransform(a.tMatrix)}catch(h){break}var i=a.children[f],u=a.children[f].obj;if(u){a.children[f].scale[0]<
0&&(e=!e);a.children[f].scale[1]<0&&(e=!e);a.children[f].scale[2]<0&&(e=!e);e&&d.cullFace(d.FRONT);if(u.morphTargets!==null&&(i.morphSource!==-1&&u.setMorphSource(i.morphSource),i.morphTarget!==-1&&u.setMorphTarget(i.morphTarget),i.morphWeight!==null))u.morphWeight=i.morphWeight;La(obj,b,a.children[f].tMatrix,c);e&&d.cullFace(d.BACK)}a.children[f].children!==null&&this.renderSceneObjectChildren(a.children[f],b,c)}};T.prototype.updateShadows=function(){var a=l.gl,b=!1;this.updateCamera();for(var c=
!1,d=a.getParameter(a.VIEWPORT),e=0,f=this.lights.length;e<f;e++){var h=this.lights[e];if(h.light_type==g.light.type.SPOT_SHADOW||h.light_type==g.light.type.AREA){var c=!0,r=new w.Light(g.light.type.DEPTH_PACK);if(h.light_type===g.light.type.AREA)h.areaCam=this.camera,h.updateAreaLight();l.shadow_near=h.dummyCam.nearclip;l.shadow_far=h.dummyCam.farclip;h.shadowBegin();for(var i=0,u=this.sceneObjects.length;i<u;i++){var q=this.sceneObjects[i];if(q.parent===null&&!(q.visible===!1||q.shadowCast===!1)){q.doTransform();
if(q.obj!==null){q.scale[0]<0&&(b=!b);q.scale[1]<0&&(b=!b);q.scale[2]<0&&(b=!b);b&&a.cullFace(a.FRONT);var o=q.obj;if(o.morphTargets!==null&&(q.morphSource!==-1&&o.setMorphSource(q.morphSource),q.morphTarget!==-1&&o.setMorphTarget(q.morphTarget),q.morphWeight!==null))o.morphWeight=q.morphWeight;La(o,h.dummyCam,q.tMatrix,[r]);b&&a.cullFace(a.BACK);b=!1}q.children!==null&&this.renderSceneObjectChildren(q,h.dummyCam,[r])}}h.shadowEnd()}}c&&a.viewport(d[0],d[1],d[2],d[3])};T.prototype.updateCamera=function(){this.camera.manual===
!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());l.depth_alpha_near=this.camera.nearclip;l.depth_alpha_far=this.camera.farclip};T.prototype.resize=function(a,b){this.camera&&this.camera.setDimensions(a,b)};T.prototype.render=function(){++this.frames;this.updateCamera();for(var a=0,b=this.lights.length;a<b;a++)this.lights[a].prepare(this.camera);
var c=l.gl,d=this.octree!==h,e=0;if(d){a=0;for(b=this.dynamic_lights.length;a<b;++a)this.dynamic_lights[a].doTransform();this.octree.reset_node_visibility();this.octree.cleanup();a=this.octree.get_frustum_hits(this.camera);e=a.lights.length}for(var f=!1,g=0,r=[],a=0,b=this.sceneObjects.length;a<b;a++){var i=this.lights,u=this.sceneObjects[a];if(u.parent===null){u.doTransform();if(d){u.dirty&&u.obj!==null&&u.adjust_octree();if(u.visible===!1||d&&(u.ignore_octree||u.drawn_this_frame===!0||u.culled===
!0))continue;i=u.dynamic_lights;i=i.concat(u.static_lights);i=i.concat(this.global_lights);this.collect_stats&&(e=p.max(i.length,e),e===i.length&&(r=i),++g);i=i.length===0?[Ja]:i.sort(mb);u.drawn_this_frame=!0}else if(u.visible===!1)continue;if(u.obj!==null){u.scale[0]<0&&(f=!f);u.scale[1]<0&&(f=!f);u.scale[2]<0&&(f=!f);f&&c.cullFace(c.FRONT);var q=u.obj;if(q.morphTargets!==null&&(u.morphSource!==-1&&q.setMorphSource(u.morphSource),u.morphTarget!==-1&&q.setMorphTarget(u.morphTarget),u.morphWeight!==
null))q.morphWeight=u.morphWeight;La(q,this.camera,u.tMatrix,i);f&&c.cullFace(c.BACK);f=!1}u.children!==null&&this.renderSceneObjectChildren(u,this.camera,i)}}if(this.collect_stats)this.stats["objects.num_rendered"]=g,this.stats["lights.num_rendered"]=e,this.stats["lights.rendered"]=r,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)c.cullFace(c.FRONT),d=this.camera.farclip*2/p.sqrt(3),
this.skybox.scene_object.position=[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[d,d,d],this.skybox.scene_object.doTransform(),La(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),c.cullFace(c.BACK)};T.prototype.bbRayTest=function(a,b,c){var d=[],b=b.length===2?this.camera.unProject(b[0],b[1]):s.add(a,b),e;for(e in this.pickables)if(this.pickables.hasOwnProperty(e)){var f=this.pickables[e];if(f.visible===!0){var g,
h;h=f.getAABB();g=h[0];h=h[1];h[0]-g[0]<0.2&&(g[0]-=0.1,h[0]+=0.1);h[1]-g[1]<0.2&&(g[1]-=0.1,h[1]+=0.1);h[2]-g[2]<0.2&&(g[2]-=0.1,h[2]+=0.1);var i=s.multiply(s.add(g,h),0.5),l=s.getClosestTo(a,b,i),i=s.length(s.subtract(l,i));(l[0]>=g[0]&&l[0]<=h[0]?1:0)+(l[1]>=g[1]&&l[1]<=h[1]?1:0)+(l[2]>=g[2]&&l[2]<=h[2]?1:0)>=c&&d.push({dist:i,obj:f})}}d.length&&d.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return d};W.prototype.createBuffer=function(a,b,c){this.texture=this.depth=
this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),d=l.gl;this.fbo=d.createFramebuffer();if(c)this.depth=d.createRenderbuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.fbo);c&&(d.bindRenderbuffer(d.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,a,b),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.depth)):(d.renderbufferStorage(d.RENDERBUFFER,
d.DEPTH_STENCIL,a,b),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this.depth)));this.texture=new Z;d.bindTexture(d.TEXTURE_2D,ka[this.texture.tex_id]);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,a,b,0,d.RGBA,d.UNSIGNED_BYTE,null);
d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,ka[this.texture.tex_id],0);d.bindFramebuffer(d.FRAMEBUFFER,null)};W.prototype.destroyBuffer=function(){var a=l.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(ka[this.texture.tex_id]);ka[this.texture.tex_id]=null};W.prototype.sizeParam=function(a){return a};W.prototype.use=function(){var a=l.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)};ta.prototype.resize=
function(a,b){this.renderBuffer.destroyBuffer();this.blurBuffer.destroyBuffer();this.bloomBuffer.destroyBuffer();this.renderBuffer.createBuffer(a,b,!0);this.blurBuffer.createBuffer(a,b,!1);this.bloomBuffer.createBuffer(parseInt(a/6,10),parseInt(b/6,10),!1);this.bloomShader.use();this.bloomShader.setVector("texel_ofs",[1/this.renderBuffer.sizeParam(a),1/this.renderBuffer.sizeParam(b),0]);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(a,b);this.destroyFSQuad(this.fsQuadBloom);this.fsQuadBloom=
this.makeFSQuad(this.bloomBuffer.width,this.bloomBuffer.height)};ta.prototype.begin=function(){this.renderBuffer.use()};ta.prototype.end=function(){var a=l.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)};ta.prototype.makeFSQuad=function(){var a=l.gl,b=[];b.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);b.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,b.vbo_points,a.STATIC_DRAW);
b.gl_uvs=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_uvs);a.bufferData(a.ARRAY_BUFFER,b.vbo_uvs,a.STATIC_DRAW);return b};ta.prototype.destroyFSQuad=function(a){var b=l.gl;b.deleteBuffer(a.gl_points);b.deleteBuffer(a.gl_uvs)};ta.prototype.renderFSQuad=function(a,b){var c=l.gl;a.use();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);c.bindBuffer(c.ARRAY_BUFFER,b.gl_points);c.vertexAttribPointer(a.aVertex,3,c.FLOAT,!1,0,0);c.enableVertexAttribPointer(a.aVertex);c.bindBuffer(c.ARRAY_BUFFER,b.gl_uvs);c.vertexAttribPointer(a.aTex,
2,c.FLOAT,!1,0,0);c.enableVertexAttribPointer(a.aTex);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);c.drawArrays(c.TRIANGLES,0,6)};ta.prototype.render=function(){var a=l.gl;a.disable(a.DEPTH_TEST);this.renderBuffer.texture.use(a.TEXTURE0);this.copyShader.use();this.copyShader.setInt("srcTex",0);this.renderFSQuad(this.copyShader,this.fsQuad);this.blur&&(this.renderBuffer.texture.use(a.TEXTURE0),this.blurShader.use(),this.blurShader.setInt("srcTex",0),this.blurShader.setFloat("opacity",this.blurOpacity),
this.blurBuffer.use(),a.enable(a.BLEND),a.depthMask(0),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blurShader,this.fsQuad),a.disable(a.BLEND),a.depthMask(1),a.blendFunc(a.ONE,a.ONE),this.end(),this.blurBuffer.texture.use(a.TEXTURE0),this.blurShader.setFloat("opacity",0.5),a.enable(a.BLEND),a.depthMask(0),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blurShader,this.fsQuad),a.disable(a.BLEND),a.depthMask(1),a.blendFunc(a.ONE,a.ONE));this.bloom&&(this.renderBuffer.texture.use(a.TEXTURE0),
a.viewport(0,0,this.bloomBuffer.width,this.bloomBuffer.height),this.bloomShader.use(),this.bloomShader.setInt("srcTex",0),this.bloomBuffer.use(),this.renderFSQuad(this.bloomShader,this.fsQuad),this.end(),this.bloomBuffer.texture.use(a.TEXTURE0),this.copyShader.use(),this.copyShader.setInt("srcTex",0),a.viewport(0,0,this.renderBuffer.width,this.renderBuffer.height),a.enable(a.BLEND),a.depthMask(0),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_COLOR),this.renderFSQuad(this.copyShader,this.fsQuadBloom),a.disable(a.BLEND),
a.depthMask(1),a.blendFunc(a.ONE,a.ONE));a.enable(a.DEPTH_TEST)};var ha=[],Ta=[];ba.prototype.setBlurOpacity=function(a){this.accumOpacity=a};ba.prototype.setBlurIntensity=function(a){this.accumIntensity=a};ba.prototype.makeFSQuad=makeFSQuad=function(a,b){var c=l.gl,d=[],e=a/a,f=b/b;d.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);d.vbo_uvs=new Float32Array([0,0,e,0,e,f,0,f,0,0,e,f]);d.gl_points=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,d.gl_points);c.bufferData(c.ARRAY_BUFFER,
d.vbo_points,c.STATIC_DRAW);d.gl_uvs=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,d.gl_uvs);c.bufferData(c.ARRAY_BUFFER,d.vbo_uvs,c.STATIC_DRAW);return d};ba.prototype.destroyFSQuad=destroyFSQuad=function(a){var b=l.gl;b.deleteBuffer(a.gl_points);b.deleteBuffer(a.gl_uvs)};ba.prototype.renderFSQuad=renderFSQuad=function(a,b){var c=l.gl;a.use();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);c.bindBuffer(c.ARRAY_BUFFER,b.gl_points);c.vertexAttribPointer(a.aVertex,3,c.FLOAT,!1,0,0);c.enableVertexAttribArray(a.aVertex);
c.bindBuffer(c.ARRAY_BUFFER,b.gl_uvs);c.vertexAttribPointer(a.aTex,2,c.FLOAT,!1,0,0);c.enableVertexAttribArray(a.aTex);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);c.drawArrays(c.TRIANGLES,0,6)};ba.prototype.addShader=function(a){this.shaders[this.shaders.length]=a;a.shader.use();a.shader.setVector("texel",this.vTexel);if(a.outputDivisor&&a.outputDivisor!=1){if(ha[a.outputDivisor]===h)var b=parseInt(this.width/a.outputDivisor);var c=parseInt(this.height/a.outputDivisor);ha[a.outputDivisor]=new W(b,c,
!1);Ta[a.outputDivisor]=this.makeFSQuad(b,c)}};ba.prototype.resize=function(a,b){var c=l.gl;this.width=a;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);
this.accum&&(this.accumBuffer.destroyBuffer(),this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT));for(var d in ha){var c=parseInt(this.width/d),e=parseInt(this.height/d);ha[d].destroyBuffer();ha[d].createBuffer(c,e,!1);this.destroyFSQuad(Ta[d]);Ta[d]=this.makeFSQuad(c,e)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;d=0;for(c=this.shaders.length;d<c;d++)if(this.shaders[d].shader.use(),this.shaders[d].shader.setVector("texel",
this.vTexel),this.shaders[d].onresize!==null)this.shaders[d].onresize(this.shaders[d].shader,this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)};ba.prototype.swap=function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a};ba.prototype.begin=function(){this.captureBuffer.use()};ba.prototype.end=function(){var a=l.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)};ba.prototype.render=function(){var a=l.gl;this.captureBuffer.texture.use(a.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(a.TEXTURE0);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var b=0,c=0,d=this.shaders.length;c<d;c++){var e=this.shaders[c];if(e.enabled){this.swap();this.inputBuffer.texture.use(a.TEXTURE0);var f=e.outputMode;if(f===g.post.output.REPLACE)e.outputDivisor!==1?ha[e.outputDivisor].use():this.outputBuffer.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT);else if(f===g.post.output.ADD||
f===g.post.output.BLEND)e.outputDivisor!==1?ha[e.outputDivisor].use():this.bufferC.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT);e.onupdate!==null&&(e.shader.use(),e.onupdate(e.shader));e.outputDivisor!==1?(a.viewport(0,0,ha[e.outputDivisor].width,ha[e.outputDivisor].height),this.renderFSQuad(e.shader,Ta[e.outputDivisor]),e.outputMode===g.post.output.REPLACE?(this.outputBuffer.use(),ha[e.outputDivisor].texture.use(a.TEXTURE0),a.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):a.viewport(0,0,this.width,this.height)):this.renderFSQuad(e.shader,this.fsQuad);f===g.post.output.BLEND?(this.swap(),this.outputBuffer.use(),a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(a.TEXTURE0),e.outputDivisor!==1?ha[e.outputDivisor].texture.use(a.TEXTURE0):this.bufferC.texture.use(a.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.disable(a.BLEND)):f===g.post.output.ADD&&(this.swap(),this.outputBuffer.use(),a.enable(a.BLEND),
a.blendFunc(a.ONE,a.ONE),e.outputDivisor!==1?ha[e.outputDivisor].texture.use(a.TEXTURE0):this.bufferC.texture.use(a.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.disable(a.BLEND));this.end();b++}}b===0?this.captureBuffer.texture.use(a.TEXTURE0):this.outputBuffer.texture.use(a.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),a.disable(a.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(a.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),a.disable(a.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)};nb.prototype.update=function(){var a=
l.gl,b=a.getParameter(a.VIEWPORT);this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);ba.prototype.renderFSQuad(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(b[0],b[1],b[2],b[3])};da.prototype.addMesh=function(a,b,c){this.meshBin[a]===h&&(this.meshBin[a]=[],this.meshBinPtr[a]===h&&(this.meshBinPtr[a]=0));this.meshMap[b]===h&&(this.meshMap[b]=c,this.meshBin[a].push(c))};da.prototype.addImage=
function(a,b,c){this.imageBin[a]===h&&(this.imageBin[a]=[],this.imageBinPtr[a]===h&&(this.imageBinPtr[a]=0));this.imageMap[b]===h&&(this.imageMap[b]=c,this.imageBin[a].push(c))};da.prototype.getMeshes=function(a){return this.meshBin[a]};da.prototype.getImages=function(a){return this.imageBin[a]};da.prototype.rewindMeshes=function(a){this.meshBinPtr[a]=0};da.prototype.rewindImages=function(a){this.imageBinPtr[a]=0};da.prototype.getNextMesh=function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,
this.meshBin[a][b];return null};da.prototype.loadNextMesh=function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1};da.prototype.isMeshBinEmpty=function(a){return this.meshBinPtr[a]===this.meshBin[a].length};da.prototype.loadNextImage=function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc};da.prototype.getNextImage=function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,this.imageBin[a][b];
return null};da.prototype.isImageBinEmpty=function(a){return this.imageBinPtr[a]===this.imageBin[a].length};var ca={fixuaxis:function(a,b){if(a===0)return[b[1],b[0],b[2]];else if(a===1)return b;else if(a===2)return[b[0],b[2],-b[1]]},fixscaleaxis:function(a,b){if(a===0)return[b[1],b[0],b[2]];else if(a===1)return b;else if(a===2)return[b[0],b[2],b[1]]},fixukaxis:function(a,b,c,d){if(b===g.motion.POS&&c===g.motion.Z&&a===g.motion.Z)return-d;return d},getAllOf:function(a,b){for(var c=[a],d=[];c.length;){var e=
c.pop(),f;for(f in e)if(e.hasOwnProperty(f)){if(f===b)if(e[f].length)for(var g=0,h=e[f].length;g<h;g++)d.push(e[f][g]);else d.push(e[f]);if(typeof e[f]=="object")if(e[f].length){g=0;for(h=e[f].length;g<h;g++)c.push(e[f][g])}else c.push(e[f])}}return d},quaternionFilterZYYZ:function(a,b){var c=a,d=new na;b!==h&&(c=s.add(a,b));d.fromEuler(c[0],c[2],-c[1]);return d.toEuler()},cl_getInitalTransform:function(a,b){var c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d=b.translate,e=b.rotate,f=b.scale;
if(d)c.position=ca.fixuaxis(a,z.floatDelimArray(d.$," "));if(e)for(var d=0,g=e.length;d<g;d++){var h=e[d],i=h["@sid"],h=z.floatDelimArray(h.$," ");if(i=="rotateX"||i=="rotationX")c.rotation[0]=h[3];else if(i=="rotateY"||i=="rotationY")c.rotation[1]=h[3];else if(i=="rotateZ"||i=="rotationZ")c.rotation[2]=h[3]}if(f)c.scale=ca.fixscaleaxis(a,z.floatDelimArray(f.$," "));return c}};Qa.prototype.addStroke=function(a,b){var c=[];b===h&&(b=0.1);for(var d=0,e=a.length;d<e;d++){var f=[a[d][0],a[d][1],a[d][2]];
this.manual_pos+=b;f.push(this.manual_pos);c.push(f)}this.strokes.push(c)};Qa.prototype.recenter=function(){var a=[0,0,0],b=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,d,e,f;e=0;for(f=this.strokes.length;e<f;e++){c=0;for(d=this.strokes[e].length;c<d;c++)a[0]>this.strokes[e][c][0]&&(a[0]=this.strokes[e][c][0]),a[1]>this.strokes[e][c][1]&&(a[1]=this.strokes[e][c][1]),a[2]>this.strokes[e][c][2]&&(a[2]=this.strokes[e][c][2]),b[0]<this.strokes[e][c][0]&&(b[0]=this.strokes[e][c][0]),
b[1]<this.strokes[e][c][1]&&(b[1]=this.strokes[e][c][1]),b[2]<this.strokes[e][c][2]&&(b[2]=this.strokes[e][c][2])}a=s.multiply(s.subtract(b,a),0.5);e=0;for(f=this.strokes.length;e<f;e++){c=0;for(d=this.strokes[e].length;c<d;c++)this.strokes[e][c][0]-=a[0],this.strokes[e][c][1]-=this.upvector[1]?a[1]:-a[1],this.strokes[e][c][2]-=a[2]}};Qa.prototype.generateObject=function(a,b,c,d,e){a===h&&(a=0);b===h&&(b=0);e===h&&(e=!1);d===h&&(d=0.02);c===h&&(c=0.015);for(var f=b!==0,g=0,l=0,i=new L(this.name),
u,q,o,w,n,x,t=0,z=this.strokes.length;t<z;t++){x=new ja;var y=new ja,A=new ja,v=this.strokes[t].length,K=0,B=[],F=[],G=0,D=this.strokes[t];for(n=0;n<v;n++){var C=D[n],E=x.addKey(C[3],C[0]),I=y.addKey(C[3],C[1]),X;X=e?A.addKey(C[3],C[2]):A.addKey(C[3],0);E.tension=0.5;I.tension=0.5;X.tension=0.5;n!==0?(u=C[0]-u,q=C[1]-q,o=C[2]-o,w=C[3]-w,o=p.sqrt(u*u+q*q+o*o),K+=o,B[n-1]=o,F[n-1]=w):G=C[3];u=C[0];q=C[1];o=C[2];w=C[3]}K=G;v=i.points.length;for(n=0;n<B.length;n++){G=F[n];E=p.ceil(B[n]/d*3);D=K;C=K+G;
for(E=G/E;D<C-E;D+=E){D===K&&(u=x.evaluate(D),q=y.evaluate(D),o=A.evaluate(D));var J,I=x.evaluate(D+E);X=y.evaluate(D+E);J=A.evaluate(D+E);var O=I-u,N=X-q,P=J-o;p.sqrt(O*O+N*N+P*P);O=s.multiply(s.normalize(s.cross(this.viewvector,s.normalize([O,N,P]))),c/2);i.addPoint([u-O[0],-(q-O[1]),o-O[2]+(f?b/2:0)]);i.addPoint([u+O[0],-(q+O[1]),o+O[2]+(f?b/2:0)]);u=I;q=X;o=J}K+=G}y=i.points.length;if(f){n=v;for(x=y;n<x;n++)i.addPoint([i.points[n][0],i.points[n][1],i.points[n][2]-(f?b/2:0)])}n=0;for(x=y-v;n<=
x-4;n+=2)g%a===0&&l++,i.setSegment(l),A=[v+n,v+n+1,v+n+3,v+n+2],i.addFace(A),f&&(A=[A[3]+y-v,A[2]+y-v,A[1]+y-v,A[0]+y-v],i.addFace(A),A=[v+n,v+n+2,v+n+2+y-v,v+n+y-v],i.addFace(A),A=[v+n+1+y-v,v+n+3+y-v,v+n+3,v+n+1],i.addFace(A),n===0&&(A=[v+n+y-v,v+n+1+y-v,v+n+1,v+n],i.addFace(A)),n===x-4&&(A=[v+n+2,v+n+3,v+n+3+y-v,v+n+2+y-v],i.addFace(A))),g++}i.calcFaceNormals();i.triangulateQuads();i.calcNormals();i.compile();return i};xa.prototype.resizeView=function(a,b){this.vWidth=a;this.vHeight=b;this.pTex!==
null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[a,b,0]))};xa.prototype.addParticle=function(a){this.last_particle===null?this.particles=a:this.last_particle.nextParticle=a;this.last_particle=a};xa.prototype.genBuffer=function(){var a=l.gl;this.glPoints=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.glPoints);a.bufferData(a.ARRAY_BUFFER,this.arPoints,a.DYNAMIC_DRAW);if(this.hasColor)this.glColor=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.glColor),
a.bufferData(a.ARRAY_BUFFER,this.arColor,a.DYNAMIC_DRAW)};xa.prototype.updatePoints=function(){var a=l.gl;a.bindBuffer(a.ARRAY_BUFFER,this.glPoints);a.bufferData(a.ARRAY_BUFFER,this.arPoints,a.DYNAMIC_DRAW)};xa.prototype.updateColors=function(){var a=l.gl;this.hasColor&&(a.bindBuffer(a.ARRAY_BUFFER,this.glColor),a.bufferData(a.ARRAY_BUFFER,this.arColor,a.DYNAMIC_DRAW))};xa.prototype.draw=function(a,b,c){var d=l.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(d.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",
a);this.shader_particle.setMatrix("uPMatrix",b);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,this.glPoints);d.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(d.bindBuffer(d.ARRAY_BUFFER,this.glColor),d.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(this.shader_particle.uniforms.aColor));c===h&&(c=
0);if(this.particles===null)d.disable(d.BLEND);else{for(var a=this.particles,b=null,e=this.numParticles=0;a!==null;){var f=this.numParticles*3,g=this.pfunc(a,c);if(g===1){if(this.arPoints[f]=a.pos[0],this.arPoints[f+1]=a.pos[1],this.arPoints[f+2]=a.pos[2],a.color!==null&&this.arColor!==h&&(this.arColor[f]=a.color[0],this.arColor[f+1]=a.color[1],this.arColor[f+2]=a.color[2]),this.numParticles++,e++,this.numParticles===this.maxPoints)break}else if(g===-1){if(b!==null)b.nextParticle=a.nextParticle}else g===
0&&e++;b=a;a=a.nextParticle}if(!e)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors();this.alpha&&(d.enable(d.BLEND),d.enable(d.DEPTH_TEST),d.depthMask(0),d.blendFunc(d.ONE,d.ONE_MINUS_SRC_COLOR));d.drawArrays(d.POINTS,0,this.numParticles);this.alpha&&(d.disable(d.BLEND),d.depthMask(1),d.blendFunc(d.ONE,d.ONE));this.hasColor&&d.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};Ya.prototype.addSubview=function(a){this.childViews.push(a);a.superView=
this};Ya.prototype.makePanel=function(a){return this.superView.makePanel(a)};ya.prototype.setupShader=function(){this.shader=new w.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(a){a.setInt("srcTex",0);a.addVector("screen");a.addVector("position");a.addVector("tint");a.addVector("size")}})};ya.prototype.addSubview=function(a){this.childViews.push(a);a.superView=this};ya.prototype.makePanel=function(a){var b=w.GLCore.gl,c={};c.vbo_points=
new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);c.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);c.gl_points=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,c.gl_points);b.bufferData(b.ARRAY_BUFFER,c.vbo_points,b.STATIC_DRAW);c.gl_uvs=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,c.gl_uvs);b.bufferData(b.ARRAY_BUFFER,c.vbo_uvs,b.STATIC_DRAW);a.panel=c};ya.prototype.renderPanel=function(a){if(!a.texture)return!1;a.texture.use(w.GLCore.gl.TEXTURE0)};ya.prototype.renderView=function(a){if(a.texture){var b=
w.GLCore.gl,c=a.offsetLeft,d=a.offsetTop;c||(c=0);d||(d=0);var e=this.shader.shader;e.use();e.setVector("screen",[this.width,this.height,0]);e.setVector("position",[a.x+c,a.y+d,0]);e.setVector("size",[a.width,a.height,0]);e.setVector("tint",a.tint);a.blend&&(b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA));a.texture.use(b.TEXTURE0);b.drawArrays(b.TRIANGLES,0,6);a.blend&&(b.disable(b.BLEND),b.blendFunc(b.ONE,b.ZERO))}};ya.prototype.render=function(){var a=w.GLCore.gl;a.disable(a.DEPTH_TEST);
this.texture&&this.renderView(this);var b=[];this.offsetTop=this.offsetLeft=0;b.push(this);shader=this.shader.shader;shader.use();a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);a.bindBuffer(a.ARRAY_BUFFER,this.panel.gl_points);a.vertexAttribPointer(shader.uniforms.aVertex,3,a.FLOAT,!1,0,0);a.enableVertexAttribArray(shader.uniforms.aVertex);a.bindBuffer(a.ARRAY_BUFFER,this.panel.gl_uvs);a.vertexAttribPointer(shader.uniforms.aTex,2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(shader.uniforms.aTex);for(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,
null);b.length;){var c=b.pop();this.renderView(c);if(c.childViews.length)for(var d=c.childViews.length-1;d>=0;d--)c.childViews[d].offsetLeft=c.x+c.offsetLeft,c.childViews[d].offsetTop=c.y+c.offsetTop,b.push(c.childViews[d])}a.disableVertexAttribArray(shader.uniforms.aTex);a.enable(a.DEPTH_TEST)};var ma={GLCore:l,init:l.init,addResizeable:l.addResizeable,setFixedAspect:l.setFixedAspect,setFixedSize:l.setFixedSize,getCanvas:l.getCanvas,enums:g,vec2:pb,vec3:s,mat4:A,util:z,fsQuad:{make:makeFSQuad,destroy:destroyFSQuad,
render:renderFSQuad},IdentityMatrix:oa,Timer:Q,MainLoop:Ba,MouseViewController:ia,setMainLoop:function(a){w.GLCore.mainloop=a},Transform:R,Light:G,Texture:Z,PJSTexture:db,CanvasTexture:Fa,TextTexture:function(a,b){var c=b&&b.color||"#fff",d=b&&b.bgcolor,e=b&&b.font||"18pt Arial",f=b&&b.align||"start",g=b&&b.y||0,l=b&&b.width||h,i=b&&b.height||h,u=sa.createElement("CANVAS"),q=u.getContext("2d"),o=0,o=typeof a==="string"?1:a.length;q.font=e;var p=b&&b.lineHeight||q.measureText("OO").width,n;if(o===
1)n=q.measureText(a).width;else for(var s=n=0;s<o;++s){var t=q.measureText(a[s]).width;t>n&&(n=t)}u.width=l||n;u.height=i||p*o;if(d)q.fillStyle=d,q.fillRect(0,0,u.width,u.height);q.fillStyle=c;q.font=e;q.textAlign=f;q.textBaseline="top";if(o===1)c=b&&b.x||f==="center"?u.width/2:f==="right"?u.width:0,q.fillText(a,c,g);else for(s=0;s<o;++s)c=b&&b.x||f==="center"?u.width/2:f==="right"?u.width:0,q.fillText(a[s],c,g+s*p);q.fill();this.use=Fa.prototype.use;this.clear=Fa.prototype.clear;this.update=Fa.prototype.update;
Fa.apply(this,[u]);this.update();this.canvasSource=null},UVMapper:$,Scene:T,SceneObject:V,Face:Ca,Material:ga,Textures:ka,Textures_obj:Y,Images:qa,Shader:E,Landscape:wa,Camera:S,GML:Qa,SkyBox:function(a){var b=a.texture,a=a.mapping,c=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/qa[c.texture.tex_id].width;if(c.mapping===null)c.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new ga("skybox"),
e=new L;e.sky_mapping=c.mapping;Va(e,1,a);e.calcNormals();var f=new $;f.projection_mode=g.uv.projection.SKY;f.scale=[1,1,1];f.apply(e,a);e.triangulateQuads();e.compile();a.setTexture(b);c.scene_object=new V(e);c.ready=!0};if(b){if(typeof b==="string")b=new Z(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},Envelope:ja,Motion:aa,RenderBuffer:W,PostProcessFX:ta,PostProcessChain:ba,PostProcessShader:Xa,NormalMapGen:nb,Particle:function(a,
b,c,d,e){this.startpos=new Float32Array(a);this.pos=new Float32Array(a);this.velocity=new Float32Array(d!==h?d:[0,0,0]);this.accel=new Float32Array(e!==h?e:[0,0,0]);this.start_time=b!==h?b:0;this.life_time=c!==h?c:0;this.nextParticle=this.color=null},ParticleSystem:xa,Octree:I,OctreeWorker:function(a,b){var c=this;this.size=a;this.depth=b;this.worker=new ab({message:function(a){console.log("Octree Worker Message:",a)},error:function(a){console.log("Octree Worker Error:",a)},type:"octree"});this.worker.start();
this.init=function(a){c.scene=a;c.worker.init({size:c.size,max_depth:c.depth,camera:a.camera})};this.insert=function(a){c.worker.send({message:"insert",node:a})};this.draw_on_map=function(){};this.reset_node_visibility=function(){};this.get_frustum_hits=function(){}},Quaternion:na,AutoCamera:Ia,Mesh:L,MeshPool:Ra,genPlaneObject:fb,genBoxObject:Va,genLatheObject:eb,genTorusObject:gb,genConeObject:hb,genCylinderObject:ib,genSphereObject:jb,primitives:{lathe:function(a){var b,c;if(a.points==h)return null;
b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:new w.Material;eb(b,a.points,a.divisions!==h?a.divisions:24,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},box:function(a){var b,c;b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:new w.Material;Va(b,a.size!==h?a.size:1,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},plane:function(a){var b,c;b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:
h);c=a.material!==h?a.material:new w.Material;fb(b,a.size!==h?a.size:1,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},sphere:function(a){var b,c;b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:new w.Material;jb(b,a.radius!==h?a.radius:1,a.lon!==h?a.lon:24,a.lat!==h?a.lat:24,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},torus:function(a){var b,c;b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:
new w.Material;gb(b,a.innerRadius!==h?a.innerRadius:0.75,a.outerRadius!==h?a.outerRadius:1,a.lon!==h?a.lon:24,a.lat!==h?a.lat:24,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},cone:function(a){var b,c;b=a.mesh!==h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:new w.Material;hb(b,a.base!==h?a.base:1,a.height!==h?a.height:1,a.lon!==h?a.lon:24,c,a.transform!==h?a.transform:h,a.uvmapper!==h?a.uvmapper:h);return b},cylinder:function(a){var b,c,d,e,f,g;b=a.mesh!==
h?a.mesh:new w.Mesh(a.name!==h?a.name:h);c=a.material!==h?a.material:new w.Material;d=a.transform!==h?a.transform:h;e=a.uvmapper!==h?a.uvmapper:h;f=a.radius!==h?a.radius:1;g=a.height!==h?a.height:1;lon=a.lon!==h?a.lon:24;ib(b,f,g,lon,c,d,e);return b}},renderObject:La,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){w.globalAmbient=a},loadMesh:function(a,b){if(Ra[a]!==h)return Ra[a];var c,d,e,f,l,r,i=new L,u=z.getXML(a);c=u.getElementsByTagName("points");var q=z.collectTextNode(c[0]).split(" ");
c=0;for(f=q.length;c<f;c++){q[c]=q[c].split(",");d=0;for(l=q[c].length;d<l;d++)q[c][d]=parseFloat(q[c][d])}i.addPoint(q);u=u.getElementsByTagName("material");q=[];c=0;for(f=u.length;c<f;c++){var o=u[c];d=o.getElementsByTagName("name").length?o.getElementsByTagName("name")[0].firstChild.nodeValue:null;e=new ga(d);if(o.getElementsByTagName("alpha").length)e.opacity=parseFloat(o.getElementsByTagName("alpha")[0].firstChild.nodeValue);if(o.getElementsByTagName("shininess").length)e.shininess=parseFloat(o.getElementsByTagName("shininess")[0].firstChild.nodeValue)/
100;if(o.getElementsByTagName("max_smooth").length)e.max_smooth=parseFloat(o.getElementsByTagName("max_smooth")[0].firstChild.nodeValue);if(o.getElementsByTagName("color").length)e.color=z.floatDelimArray(o.getElementsByTagName("color")[0].firstChild.nodeValue);if(o.getElementsByTagName("ambient").length)e.ambient=z.floatDelimArray(o.getElementsByTagName("ambient")[0].firstChild.nodeValue);if(o.getElementsByTagName("diffuse").length)e.diffuse=z.floatDelimArray(o.getElementsByTagName("diffuse")[0].firstChild.nodeValue);
if(o.getElementsByTagName("specular").length)e.specular=z.floatDelimArray(o.getElementsByTagName("specular")[0].firstChild.nodeValue);o.getElementsByTagName("texture").length&&(d=(b?b:"")+o.getElementsByTagName("texture")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.COLOR));o.getElementsByTagName("texture_luminosity").length&&(d=(b?b:"")+o.getElementsByTagName("texture_luminosity")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.AMBIENT));
o.getElementsByTagName("texture_normal").length&&(d=(b?b:"")+o.getElementsByTagName("texture_normal")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.NORMAL));o.getElementsByTagName("texture_specular").length&&(d=(b?b:"")+o.getElementsByTagName("texture_specular")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.SPECULAR));o.getElementsByTagName("texture_bump").length&&(d=(b?b:"")+o.getElementsByTagName("texture_bump")[0].firstChild.nodeValue,
d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.BUMP));o.getElementsByTagName("texture_envsphere").length&&(d=(b?b:"")+o.getElementsByTagName("texture_envsphere")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.ENVSPHERE));o.getElementsByTagName("texture_alpha").length&&(d=(b?b:"")+o.getElementsByTagName("texture_alpha")[0].firstChild.nodeValue,d=U[d]!==h?Y[U[d]]:new Z(d),e.setTexture(d,g.texture.map.ALPHA));var s=null;if(o.getElementsByTagName("uvmapper").length){var n=
new $,p=o.getElementsByTagName("uvmapper")[0];r="";if(p.getElementsByTagName("type").length)switch(r=o.getElementsByTagName("type")[0].firstChild.nodeValue,r){case "planar":n.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":n.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":n.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":n.projection_mode=g.uv.projection.CUBIC}if(r==="uv"&&p.getElementsByTagName("uv").length){s=z.collectTextNode(o.getElementsByTagName("uv")[0]).split(" ");
d=0;for(l=s.length;d<l;d++)s[d]=z.floatDelimArray(s[d])}if(p.getElementsByTagName("axis").length)switch(o.getElementsByTagName("axis")[0].firstChild.nodeValue){case "x":n.projection_axis=g.uv.axis.X;break;case "y":n.projection_axis=g.uv.axis.Y;break;case "z":n.projection_axis=g.uv.axis.Z}if(o.getElementsByTagName("center").length)n.center=z.floatDelimArray(o.getElementsByTagName("center")[0].firstChild.nodeValue);if(o.getElementsByTagName("rotation").length)n.rotation=z.floatDelimArray(o.getElementsByTagName("rotation")[0].firstChild.nodeValue);
if(o.getElementsByTagName("scale").length)n.scale=z.floatDelimArray(o.getElementsByTagName("scale")[0].firstChild.nodeValue);r!==""&&r!=="uv"&&q.push([n,e])}p=n=null;o.getElementsByTagName("segments").length&&(n=z.intDelimArray(z.collectTextNode(o.getElementsByTagName("segments")[0])," "));o.getElementsByTagName("triangles").length&&(p=z.intDelimArray(z.collectTextNode(o.getElementsByTagName("triangles")[0])," "));n===null&&(n=[0,parseInt(p.length/3,10)]);o=0;i.setFaceMaterial(e);if(p.length){e=0;
for(r=n.length;e<r;e+=2){var t=n[e+1]*3;i.setSegment(n[e]);d=o;for(l=o+t;d<l;d+=3){var w=i.addFace([p[d],p[d+1],p[d+2]]);s&&i.faces[w].setUV([s[d],s[d+1],s[d+2]])}o+=t}}}i.calcNormals();c=0;for(f=q.length;c<f;c++)q[c][0].apply(i,q[c][1]);i.compile();return Ra[a]=i},DeferredBin:da,DeferredLoadTexture:ma,loadCollada:function(a,b,c){for(var b=zb(a,b,c),d=b.up_axis,e=[],f=0,m=b.materials.length;f<m;f++){for(var r=b.materials[f],i=new ga(r.mat),p=0,q=r.mat.textures_ref.length;p<q;p++){var o=r.mat.textures_ref[p],
s=null,s=U[o.image]===void 0?new Z(o.image,l.default_filter,c,a):Y[U[o.image]];i.setTexture(s,o.type)}e[r.id]=i}r=[];f=0;for(m=b.meshes.length;f<m;f++){q=b.meshes[f];o=new L(q.id);o.points=q.points;for(var s=0,n=q.parts.length;s<n;s++){var x=q.parts[s];x.material!==0&&o.setFaceMaterial(e[x.material]);for(var t=x.normals.length?!0:!1,A=x.texcoords.length?!0:!1,i=0,p=x.faces.length;i<p;i++){var y=o.addFace(x.faces[i]);if(t)o.faces[y].point_normals=x.normals[i];if(A)o.faces[y].uvs=x.texcoords[i]}}c?
c.addMesh(a,a+":"+meshId,o):(o.triangulateQuads(),o.compile());r[q.id]=o}m=[];a=0;for(i=b.cameras.length;a<i;a++)m[b.cameras[a].id]=b.cameras[a];q=[];i=0;for(p=b.lights.length;i<p;i++)q[b.lights[i].id]=b.lights[i];c={};e={};f={};a={};o=0;for(s=b.scenes.length;o<s;o++){n=b.scenes[o];x=new w.Scene;i=0;for(p=n.sceneObjects.length;i<p;i++)t=n.sceneObjects[i],A=new V(t),A.obj=(r[t.meshName]?r[t.meshName]:r[t.meshId])||null,c[t.id]=A,x.bindSceneObject(A);i=0;for(p=n.lights.length;i<p;i++)t=n.lights[i],
A=new G(q[t.source]),A.position=t.position,e[t.id]=A,x.bindLight(A);if(n.cameras.length)i=n.cameras[0],p=new S(m[i.source]),p.position=i.position,p.rotation=i.rotation,f[i.id]=p,x.camera=p;i=0;for(p=n.parentMap.length;i<p;i++)t=n.parentMap[i],c[t.parent].bindChild(c[t.child]);a[n.id]=x}for(animId in b.animations)if(b.animations.hasOwnProperty(animId)&&(r=b.animations[animId],r.channels.length)){cCount=0;for(i=r.channels.length;cCount<i;cCount++){var m=r.channels[cCount],t=r.samplers[m.source],p=r.sources[t.INPUT],
q=r.sources[t.OUTPUT],o=r.sources[t.INTERPOLATION],s=r.sources[t.IN_TANGENT],n=r.sources[t.OUT_TANGENT],x=t.IN_TANGENT!==h,t=t.OUT_TANGENT!==h,A=null,z=c[m.targetName],y=f[m.targetName],v=e[m.targetName];if(z){if(z.motion===null)z.motion=new aa;A=z.motion}else if(y){if(y.motion===null)y.motion=new aa;A=y.motion}else if(v){if(v.motion===null)v.motion=new aa;A=v.motion}if(A!==null){var z=g.motion.POS,K=g.motion.X;if(d===2)A.yzflip=!0;var B=m.paramName;if(B==="rotateX"||B==="rotationX")z=g.motion.ROT,
K=g.motion.X;else if(B==="rotateY"||B==="rotationY")z=g.motion.ROT,K=g.motion.Y;else if(B==="rotateZ"||B==="rotationZ")z=g.motion.ROT,K=g.motion.Z;else if(B==="location"){z=g.motion.POS;if(m.typeName==="X")K=g.motion.X;if(m.typeName==="Y")K=g.motion.Y;if(m.typeName==="Z")K=g.motion.Z}else if(B==="translate"){z=g.motion.POS;if(m.typeName==="X")K=g.motion.X;if(m.typeName==="Y")K=g.motion.Y;if(m.typeName==="Z")K=g.motion.Z}else if(B==="LENS")continue;else if(B==="FOV")z=g.motion.FOV,K=3;else if(B===
"ZNEAR")z=g.motion.NEARCLIP,K=3;else if(B==="ZFAR")z=g.motion.FARCLIP,K=3;else if(B==="intensity")z=g.motion.INTENSITY,K=3;if(v&&z<3)v.method=g.light.method.DYNAMIC;mCount=0;for(m=p.data.length;mCount<m;mCount++)if(k=null,typeof q.data[mCount]==="object"){fa=0;for(Za=q.data[mCount].length;fa<Za;fa++)if(v=fa,d===2&&fa===2?v=1:d===2&&fa===1&&(v=2),k=A.setKey(z,v,p.data[mCount],ca.fixukaxis(b.up_axis,z,v,q.data[mCount][fa])),o)if(B=o.data[mCount][fa],B==="LINEAR")k.shape=g.envelope.shape.LINE;else if(B===
"BEZIER")k.shape=!x&&!t?g.envelope.shape.LINEAR:g.envelope.shape.BEZI}else if(v=K,ofs=0,y&&z===g.motion.ROT&&d===2&&v===0&&(ofs=-90),z===g.motion.ROT?k=A.setKey(z,v,p.data[mCount],q.data[mCount]+ofs):(d===2&&K===2?v=1:d===2&&K===1&&(v=2),k=A.setKey(z,v,p.data[mCount],ca.fixukaxis(b.up_axis,z,v,q.data[mCount]))),o)if(B=o.data[mCount],B==="LINEAR")k.shape=g.envelope.shape.LINE;else if(B==="BEZIER")if(!x&&!t)k.shape=g.envelope.shape.LINEAR,k.continutity=1;else{k.shape=g.envelope.shape.BEZ2;var B=s.data[mCount][0],
F,E=n.data[mCount][0];z===g.motion.ROT?(F=s.data[mCount][1],v=n.data[mCount][1],k.param[0]=B-k.time,k.param[1]=F-k.value+ofs,k.param[2]=E-k.time,k.param[3]=v-k.value+ofs):(F=ca.fixukaxis(b.up_axis,z,v,s.data[mCount][1]),v=ca.fixukaxis(b.up_axis,z,v,n.data[mCount][1]),k.param[0]=B-k.time,k.param[1]=F-k.value,k.param[2]=E-k.time,k.param[3]=v-k.value)}}}}d=null;return d=b.scene?a[b.scene]:a.pop()},loadColladaWorker:function(a,b,c,d){var e;try{e=new Worker(Aa+"collada.js")}catch(f){throw Error("Can't find collada.js");
}var g=[],h=[];e.onmessage=function(b){function e(a,b){for(var c in a)b[c]=a[c]}var f=b.data.message;if(f=="materials")for(var l=JSON.parse(b.data.data),b=0,f=l.length;b<f;++b){var p=new ga(l[b].name),n=p.material_id;e(l[b],p);p.material_id=n;g[l[b].material_id]=n;for(var n=0,s=l[b].textures.length;n<s;++n){var t=l[b].textures[n];if(t){var w=U[t.img_path];w===void 0?(t=new Z(t.img_path,t.filter_type,d,a),p.textures[n]=t):p.textures[n]=Y[w]}else p.textures[n]=0}}else if(f=="scene"){l=JSON.parse(b.data.data);
p=function(a){if(a.motion){for(var b=a.motion.controllers,c=[],d=0,f=b.length;d<f;++d){var g=b[d];if(g){for(var h=[],i=0,l=g.length;i<l;++i){var m=g[i];if(m){var n=m.keys[0];if(m.keys.length>1)n.prev=null,n.next=m.keys[1],n=m.keys[1];for(var o=1,p=m.keys.length-1;o<p;++o)n.prev=m.keys[o-1],n.next=m.keys[o+1],n=m.keys[o+1];if(m.keys.length>1)n=m.keys[m.keys.length-1],n.prev=m.keys[m.keys.length-2],n.next=null;m.firstKey=m.keys[0];m.lastKey=m.keys[m.keys.length-1];m.keys=m.firstKey;n=new ja;e(m,n);
h[i]=n}else g[i]=void 0}c[d]=h}else b[d]=void 0}a.motion.controllers=c;b=new aa;e(a.motion,b);a.motion=b}};b=0;for(f=l.sceneObjects.length;b<f;++b){n=l.sceneObjects[b];n.obj!==null&&va();if(n.reassembled===void 0)p(n),n.reassembled=!0;var y=function(b){var c=new V;e(b,c);if(b.obj!==null){var f=h[b.obj.id];if(f===void 0)if(f=new L,e(b.obj,f),c.obj=f,h[b.obj.id]=f,d){if(f.points.length>0){d.addMesh(a,a+":"+f.id,f);for(var i=0,l=f.faces.length;i<l;++i){var n=f.faces[i],o=n.material;n.material=g[o]!==
void 0?g[o]:0}}}else c.obj.triangulateQuads(),c.obj.calcNormals(),c.obj.compile(),c.obj.clean();else c.obj=f}c.trans=new R;if(b.children&&b.children.length>0&&(c.children=[],b.children)){f=0;for(i=b.children.length;f<i;++f)l=y(b.children[f]),c.bindChild(l)}return c};l.sceneObjects[b]=y(n)}n=new T;b=n.camera;f=b.transform;e(l.camera,b);e(l.camera.transform,f);p(b);n.camera=b;n.camera.transform=f;n.camera.frustum=new Ha;b=0;for(f=l.sceneObjects.length;b<f;++b){s=l.sceneObjects[b];n.bindSceneObject(s);
try{s.getAABB()}catch(z){}}b=0;for(f=l.lights.length;b<f;++b)s=new G,e(l.lights[b],s),s.trans=new R,p(s),n.bindLight(s);c(n)}else console.log("message from collada worker:",b.data.message)};e.onerror=function(a){console.log("error from collada worker:",a.message)};e.postMessage({message:"start",params:{meshUrl:a,prefix:b,rootDir:Aa}})},setGlobalDepthAlpha:l.setDepthAlpha,setDefaultFilter:l.setDefaultFilter,setSoftShadows:l.setSoftShadows,Worker:ab,Layout:ya,View:Ya},Ua;for(Ua in ma)ma.hasOwnProperty(Ua)&&
(this.CubicVR[Ua]=ma[Ua])})(window,window.document,Math,function(){console.log("nop!")});window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvec3 mSpec;\nfloat mShine;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mColor;\nuniform vec3 mAmb;\nuniform vec3 mSpec;\nuniform float mShine;\nuniform vec3 lAmb;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\naccum += att * lDiff[i] * mDiff * NdotL;\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
